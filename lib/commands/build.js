"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = build;

require("source-map-support/register");

var _fsExtra = require("fs-extra");

var _path = require("path");

var _buildPrintable = _interopRequireDefault(require("../builders/buildPrintable"));

var _buildSnippets = require("../builders/buildSnippets");

var _buildWiki = require("../builders/buildWiki");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const libmanPrefix = 'libman_auto_generated_';

function build(config, project, one = false) {
  const src = (0, _path.resolve)(process.cwd(), config.WorkingDir, config.SrcDir);
  const dist = (0, _path.resolve)(process.cwd(), config.WorkingDir, config.DistDir);
  const printlistPath = (0, _path.resolve)(src, 'printlist.json');
  const printlistUsedPath = (0, _path.resolve)(src, 'printlist_used.json');
  const printedPath = (0, _path.resolve)(src, 'printed.json');

  if (one && !(0, _fsExtra.existsSync)(printlistPath)) {
    throw "'printlist.json' is needed. build --init";
  }

  if (one && !(0, _fsExtra.existsSync)(printedPath)) {
    (0, _fsExtra.writeFileSync)(printedPath, '{}');
  }

  check(config.CopyWiki, 'wiki');
  (0, _fsExtra.removeSync)(dist);
  (0, _fsExtra.mkdirsSync)(dist); // wikiを作る

  (0, _buildWiki.buildWiki)(config, project);
  autoRemove(config.CopyWiki);
  copy(dist, config.CopyWiki, 'wiki'); // snippetsを作る(1ファイル)

  const snippet = (0, _buildSnippets.makeSnippet)(config, project.libs);
  (0, _fsExtra.writeFileSync)((0, _path.resolve)(dist, 'libman.snip'), snippet);
  copy(dist, config.CopySnippet, 'libman.snip'); // printable-one-pageを作る

  if (one) {
    const printlist = JSON.parse((0, _fsExtra.readFileSync)(printlistPath));
    const printed = JSON.parse((0, _fsExtra.readFileSync)(printedPath));
    const {
      printed: newPrinted,
      printable
    } = (0, _buildPrintable.default)(config.printableYAML, printlist, printed, project.libs);
    (0, _fsExtra.writeFileSync)((0, _path.resolve)(dist, 'printable.md'), printable);
    copy(dist, config.CopyPrintable, 'printable.md');
    (0, _fsExtra.writeFileSync)(printedPath, JSON.stringify(newPrinted));
    (0, _fsExtra.renameSync)(printlistPath, printlistUsedPath);
  }
}

function check(data, name) {
  if (data && typeof data === 'string') {
    const cp = (0, _path.resolve)(process.cwd(), data);

    if (!(0, _fsExtra.existsSync)(cp)) {
      throw `${cp} doesn't exist, skipped copy ` + name;
    }
  }
}

function copy(dist, data, name) {
  if (data && typeof data === 'string') {
    const cp = (0, _path.resolve)(process.cwd(), data);
    (0, _fsExtra.copySync)((0, _path.resolve)(dist, name), cp);
  }
}

function autoRemove(data) {
  if (data && typeof data === 'string') {
    const dir = (0, _path.resolve)(process.cwd(), data);
    (0, _fsExtra.readdirSync)(dir).filter(file => new RegExp(String.raw`^${libmanPrefix}.*\.md$`).test(file)).forEach(file => {
      (0, _fsExtra.removeSync)((0, _path.resolve)(dir, file));
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tYW5kcy9idWlsZC5qcyJdLCJuYW1lcyI6WyJsaWJtYW5QcmVmaXgiLCJidWlsZCIsImNvbmZpZyIsInByb2plY3QiLCJvbmUiLCJzcmMiLCJwcm9jZXNzIiwiY3dkIiwiV29ya2luZ0RpciIsIlNyY0RpciIsImRpc3QiLCJEaXN0RGlyIiwicHJpbnRsaXN0UGF0aCIsInByaW50bGlzdFVzZWRQYXRoIiwicHJpbnRlZFBhdGgiLCJjaGVjayIsIkNvcHlXaWtpIiwiYXV0b1JlbW92ZSIsImNvcHkiLCJzbmlwcGV0IiwibGlicyIsIkNvcHlTbmlwcGV0IiwicHJpbnRsaXN0IiwiSlNPTiIsInBhcnNlIiwicHJpbnRlZCIsIm5ld1ByaW50ZWQiLCJwcmludGFibGUiLCJwcmludGFibGVZQU1MIiwiQ29weVByaW50YWJsZSIsInN0cmluZ2lmeSIsImRhdGEiLCJuYW1lIiwiY3AiLCJkaXIiLCJmaWx0ZXIiLCJmaWxlIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwidGVzdCIsImZvckVhY2giXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLHdCQUFyQjs7QUFFZSxTQUFTQyxLQUFULENBQWdCQyxNQUFoQixFQUF3QkMsT0FBeEIsRUFBaUNDLEdBQUcsR0FBRyxLQUF2QyxFQUE4QztBQUMzRCxRQUFNQyxHQUFHLEdBQUcsbUJBQVFDLE9BQU8sQ0FBQ0MsR0FBUixFQUFSLEVBQXVCTCxNQUFNLENBQUNNLFVBQTlCLEVBQTBDTixNQUFNLENBQUNPLE1BQWpELENBQVo7QUFDQSxRQUFNQyxJQUFJLEdBQUcsbUJBQVFKLE9BQU8sQ0FBQ0MsR0FBUixFQUFSLEVBQXVCTCxNQUFNLENBQUNNLFVBQTlCLEVBQTBDTixNQUFNLENBQUNTLE9BQWpELENBQWI7QUFFQSxRQUFNQyxhQUFhLEdBQUcsbUJBQVFQLEdBQVIsRUFBYSxnQkFBYixDQUF0QjtBQUNBLFFBQU1R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T0FBT0EsSUFBUCxLQUFnQixRQUE1QixFQUFzQztBQUNwQyxVQUFNRyxHQUFHLEdBQUcsbUJBQVE1QixPQUFPLENBQUNDLEdBQVIsRUFBUixFQUF1QndCLElBQXZCLENBQVo7QUFDQSw4QkFBWUcsR0FBWixFQUNHQyxNQURILENBQ1VDLElBQUksSUFBSSxJQUFJQyxNQUFKLENBQ2RDLE1BQU0sQ0FBQ0MsR0FBSSxJQUFHdkMsWUFBYSxTQURiLEVBQ3VCd0MsSUFEdkIsQ0FDNEJKLElBRDVCLENBRGxCLEVBR0dLLE9BSEgsQ0FHV0wsSUFBSSxJQUFJO0FBQ2YsK0JBQVcsbUJBQVFGLEdBQVIsRUFBYUUsSUFBYixDQUFYO0FBQ0QsS0FMSDtBQU1EO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb3B5U3luYywgZXhpc3RzU3luYywgbWtkaXJzU3luYywgcmVhZGRpclN5bmMsIHJlYWRGaWxlU3luYywgcmVtb3ZlU3luYywgcmVuYW1lU3luYywgd3JpdGVGaWxlU3luYyB9IGZyb20gJ2ZzLWV4dHJhJ1xyXG5pbXBvcnQgeyByZXNvbHZlIH0gZnJvbSAncGF0aCdcclxuaW1wb3J0IGJ1aWxkUHJpbnRhYmxlIGZyb20gJy4uL2J1aWxkZXJzL2J1aWxkUHJpbnRhYmxlJ1xyXG5pbXBvcnQgeyBtYWtlU25pcHBldCB9IGZyb20gJy4uL2J1aWxkZXJzL2J1aWxkU25pcHBldHMnXHJcbmltcG9ydCB7IGJ1aWxkV2lraSB9IGZyb20gJy4uL2J1aWxkZXJzL2J1aWxkV2lraSdcclxuXHJcbmNvbnN0IGxpYm1hblByZWZpeCA9ICdsaWJtYW5fYXV0b19nZW5lcmF0ZWRfJ1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gYnVpbGQgKGNvbmZpZywgcHJvamVjdCwgb25lID0gZmFsc2UpIHtcclxuICBjb25zdCBzcmMgPSByZXNvbHZlKHByb2Nlc3MuY3dkKCksIGNvbmZpZy5Xb3JraW5nRGlyLCBjb25maWcuU3JjRGlyKVxyXG4gIGNvbnN0IGRpc3QgPSByZXNvbHZlKHByb2Nlc3MuY3dkKCksIGNvbmZpZy5Xb3JraW5nRGlyLCBjb25maWcuRGlzdERpcilcclxuXHJcbiAgY29uc3QgcHJpbnRsaXN0UGF0aCA9IHJlc29sdmUoc3JjLCAncHJpbnRsaXN0Lmpzb24nKVxyXG4gIGNvbnN0IHByaW50bGlzdFVzZWRQYXRoID0gcmVzb2x2ZShzcmMsICdwcmludGxpc3RfdXNlZC5qc29uJylcclxuICBjb25zdCBwcmludGVkUGF0aCA9IHJlc29sdmUoc3JjLCAncHJpbnRlZC5qc29uJylcclxuXHJcbiAgaWYgKG9uZSAmJiAhZXhpc3RzU3luYyhwcmludGxpc3RQYXRoKSkge1xyXG4gICAgdGhyb3cgXCIncHJpbnRsaXN0Lmpzb24nIGlzIG5lZWRlZC4gYnVpbGQgLS1pbml0XCJcclxuICB9XHJcblxyXG4gIGlmIChvbmUgJiYgIWV4aXN0c1N5bmMocHJpbnRlZFBhdGgpKSB7XHJcbiAgICB3cml0ZUZpbGVTeW5jKHByaW50ZWRQYXRoLCAne30nKVxyXG4gIH1cclxuXHJcbiAgY2hlY2soY29uZmlnLkNvcHlXaWtpLCAnd2lraScpXHJcblxyXG4gIHJlbW92ZVN5bmMoZGlzdClcclxuICBta2RpcnNTeW5jKGRpc3QpXHJcbiAgLy8gd2lraeOCkuS9nOOCi1xyXG4gIGJ1aWxkV2lraShjb25maWcsIHByb2plY3QpXHJcbiAgYXV0b1JlbW92ZShjb25maWcuQ29weVdpa2kpXHJcbiAgY29weShkaXN0LCBjb25maWcuQ29weVdpa2ksICd3aWtpJylcclxuICAvLyBzbmlwcGV0c+OCkuS9nOOCiygx44OV44Kh44Kk44OrKVxyXG4gIGNvbnN0IHNuaXBwZXQgPSBtYWtlU25pcHBldChjb25maWcsIHByb2plY3QubGlicylcclxuICB3cml0ZUZpbGVTeW5jKHJlc29sdmUoZGlzdCwgJ2xpYm1hbi5zbmlwJyksIHNuaXBwZXQpXHJcbiAgY29weShkaXN0LCBjb25maWcuQ29weVNuaXBwZXQsICdsaWJtYW4uc25pcCcpXHJcblxyXG4gIC8vIHByaW50YWJsZS1vbmUtcGFnZeOCkuS9nOOCi1xyXG4gIGlmIChvbmUpIHtcclxuICAgIGNvbnN0IHByaW50bGlzdCA9IEpTT04ucGFyc2UocmVhZEZpbGVTeW5jKHByaW50bGlzdFBhdGgpKVxyXG4gICAgY29uc3QgcHJpbnRlZCA9IEpTT04ucGFyc2UocmVhZEZpbGVTeW5jKHByaW50ZWRQYXRoKSlcclxuICAgIGNvbnN0IHtwcmludGVkOiBuZXdQcmludGVkLCBwcmludGFibGV9ID0gYnVpbGRQcmludGFibGUoY29uZmlnLnByaW50YWJsZVlBTUwsIHByaW50bGlzdCwgcHJpbnRlZCwgcHJvamVjdC5saWJzKVxyXG4gICAgd3JpdGVGaWxlU3luYyhyZXNvbHZlKGRpc3QsICdwcmludGFibGUubWQnKSwgcHJpbnRhYmxlKVxyXG4gICAgY29weShkaXN0LCBjb25maWcuQ29weVByaW50YWJsZSwgJ3ByaW50YWJsZS5tZCcpXHJcbiAgICB3cml0ZUZpbGVTeW5jKHByaW50ZWRQYXRoLCBKU09OLnN0cmluZ2lmeShuZXdQcmludGVkKSlcclxuXHJcbiAgICByZW5hbWVTeW5jKHByaW50bGlzdFBhdGgsIHByaW50bGlzdFVzZWRQYXRoKVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2sgKGRhdGEsIG5hbWUpIHtcclxuICBpZiAoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHtcclxuICAgIGNvbnN0IGNwID0gcmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBkYXRhKVxyXG4gICAgaWYgKCFleGlzdHNTeW5jKGNwKSkge1xyXG4gICAgICB0aHJvdyBgJHtjcH0gZG9lc24ndCBleGlzdCwgc2tpcHBlZCBjb3B5IGAgKyBuYW1lXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjb3B5IChkaXN0LCBkYXRhLCBuYW1lKSB7XHJcbiAgaWYgKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XHJcbiAgICBjb25zdCBjcCA9IHJlc29sdmUocHJvY2Vzcy5jd2QoKSwgZGF0YSlcclxuICAgIGNvcHlTeW5jKHJlc29sdmUoZGlzdCwgbmFtZSksIGNwKVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gYXV0b1JlbW92ZSAoZGF0YSkge1xyXG4gIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnc3RyaW5nJykge1xyXG4gICAgY29uc3QgZGlyID0gcmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBkYXRhKVxyXG4gICAgcmVhZGRpclN5bmMoZGlyKVxyXG4gICAgICAuZmlsdGVyKGZpbGUgPT4gbmV3IFJlZ0V4cChcclxuICAgICAgICBTdHJpbmcucmF3YF4ke2xpYm1hblByZWZpeH0uKlxcLm1kJGApLnRlc3QoZmlsZSkpXHJcbiAgICAgIC5mb3JFYWNoKGZpbGUgPT4ge1xyXG4gICAgICAgIHJlbW92ZVN5bmMocmVzb2x2ZShkaXIsIGZpbGUpKVxyXG4gICAgICB9KVxyXG4gIH1cclxufVxyXG4iXX0=