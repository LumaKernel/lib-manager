"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @([^ \t\n]*)[ \t]+([^ \n].*)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?!Foo Lib)(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|$)/;
const newRegExp = /^\/\/ @new(?:[ \t]+([^ \n].*))?(?:\n|$)/;
const nameRegExp = /^\/\/ @[ \t]+([^ \n].*)(?:\n|$)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  let data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    // @new {name}
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1]; // @ {name}

    const nameData = code.match(nameRegExp);
    if (nameData && nameData[1]) return nameData[1]; // @name {name}

    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  data = data.filter(el => el[0] !== 'name'); //
  // ライブラリに関して

  const libraryRegExp = makeLibraryRegExp('!' + name);
  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`;
  const requirements = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
    old: el,
    name: el.match(libraryRegExp)[2],
    id: IDMaker.next().value
  })); // {old, name}
  // ライブラリの置き換え

  {
    let i = 0;
    code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
      return (0, _id.hash)(requirements[i++].id);
    });
  } //
  // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(newRegExp, '');
  code = code.replace(nameRegExp, '');
  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  if (libEndRegExp.test(code.replace(makeLibraryRegExp('=' + name, 'g'), ''))) throw `${namespace} / ${filename} : ${name} : cannot include unit lib end`;
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      name,
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibWFrZUxpYnJhcnlSZWdFeHAiLCJleCIsImZsYWdzIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibGliRW5kUmVnRXhwIiwibmV3UmVnRXhwIiwibmFtZVJlZ0V4cCIsImVuY2xvc2UiLCJuYW1lIiwiY29kZSIsIm1ha2VMaWIiLCJvbGQiLCJuYW1lc3BhY2UiLCJmaWxlbmFtZSIsImNvbmZpZyIsIklETWFrZXIiLCJkYXRhIiwibWF0Y2giLCJtYXAiLCJlbCIsIkFycmF5IiwiZnJvbSIsInNoaWZ0IiwiZmlsdGVyIiwibmV3RGF0YSIsIm5hbWVEYXRhIiwibGlicmFyeVJlZ0V4cCIsImVuY2xvc3VyZUNvdW50IiwibGVuZ3RoIiwicmVxdWlyZW1lbnRzIiwiaWQiLCJuZXh0IiwidmFsdWUiLCJpIiwicmVwbGFjZSIsImltcG9ydHMiLCJyZWZhY3RvcmVkIiwidGVzdCIsImVuY2xvc2VkIiwicmVxdWlyZSIsImltcG9ydCIsImZpbmlzaGVkIiwicHJvY2Vzc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLDBEQUFyQjtBQUNBLE1BQU1DLFVBQVUsR0FBRyxvREFBbkIsQyxDQUNBOztBQUNBLE1BQU1DLGlCQUFpQixHQUFHLENBQUNDLEVBQUQsRUFBS0MsS0FBTCxLQUFlLElBQUlDLE1BQUosQ0FDdkNDLE1BQU0sQ0FBQ0MsR0FBSSxpQ0FBZ0NKLEVBQUcsMkRBRFAsRUFFdkNDLEtBRnVDLENBQXpDOztBQUlBLE1BQU1JLFlBQVksR0FBRyw0Q0FBckI7QUFDQSxNQUFNQyxTQUFTLEdBQUcseUNBQWxCO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLGlDQUFuQjs7QUFFQSxNQUFNQyxPQUFPLEdBQUcsQ0FBQ0MsSUFBRCxFQUFPQyxJQUFQLEtBQWlCLFdBQVVELElBQUssYUFBWUMsSUFB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QUVMLE9BVko7QUFXSk0sTUFBQUEsUUFBUSxFQUFFLEtBWE47QUFZSkMsTUFBQUEsVUFBVSxFQUFFO0FBWlI7QUFGRCxHQUFQO0FBaUJEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnLi4vZm9ybWF0dGVyJ1xuaW1wb3J0IHsgaGFzaCwgbWFrZUlETWFrZXIgfSBmcm9tICcuLi9pZCdcblxuY29uc3QgaW1wb3J0UmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQGltcG9ydCAoLispXFxuPyhbXFxzXFxTXSo/KVxcblxcL1xcLyBAQCg/PVxcbnwkKS9cbmNvbnN0IGRhdGFSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAKFteIFxcdFxcbl0qKVsgXFx0XSsoW14gXFxuXS4qKSg/OlxcbnwkKS9cbi8vICg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/IUZvbyBMaWIpKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG5cXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKVxuY29uc3QgbWFrZUxpYnJhcnlSZWdFeHAgPSAoZXgsIGZsYWdzKSA9PiBuZXcgUmVnRXhwKFxuICBTdHJpbmcucmF3YCg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/JHtleH0pKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG5cXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKWAsXG4gIGZsYWdzXG4pXG5jb25zdCBsaWJFbmRSZWdFeHAgPSAvKD86XnxcXG4pWyBcXHRdKlxcL1xcL1xcLyB9fX0tLS0gXFwvXFwvXFwvKD86XFxufCQpL1xuY29uc3QgbmV3UmVnRXhwID0gL15cXC9cXC8gQG5ldyg/OlsgXFx0XSsoW14gXFxuXS4qKSk/KD86XFxufCQpL1xuY29uc3QgbmFtZVJlZ0V4cCA9IC9eXFwvXFwvIEBbIFxcdF0rKFteIFxcbl0uKikoPzpcXG58JCkvXG5cbmNvbnN0IGVuY2xvc2UgPSAobmFtZSwgY29kZSkgPT4gYC8vLyAtLS0gJHtuYW1lfSB7e3sgLy8vXFxuJHtjb2RlfVxcbi8vLyB9fX0tLS0gLy8vYFxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWFrZUxpYiAob2xkLCBuYW1lc3BhY2UsIGZpbGVuYW1lLCBjb25maWcpIHtcbiAgY29uc3QgSURNYWtlciA9IG1ha2VJRE1ha2VyKClcbiAgbGV0IGNvZGUgPSBvbGQgLy8g44GE44KP44KG44KLc25pcHBldOeUqOOBruOCs+ODvOODiVxuICBjb2RlID0gYXdhaXQgZm9ybWF0KGNvZGUsIGNvbmZpZylcblxuICAvLyDjg4fjg7zjgr/mir3lh7pcbiAgbGV0IGRhdGEgPSAoY29kZS5tYXRjaChuZXcgUmVnRXhwKGRhdGFSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gQXJyYXkuZnJvbShlbC5tYXRjaChkYXRhUmVnRXhwKSkpIC8vIFthbGwsIG5hbWUsIGRhdGFdXG4gICAgLm1hcChlbCA9PiAoZWwuc2hpZnQoKSwgZWwpKSAvLyBbbmFtZSwgZGF0YV1cbiAgICAuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnaW1wb3J0JylcbiAgICAuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnbmV3JylcbiAgY29uc3QgbmFtZSA9ICgoKSA9PiB7XG4gICAgLy8gQG5ldyB7bmFtZX1cbiAgICBjb25zdCBuZXdEYXRhID0gY29kZS5tYXRjaChuZXdSZWdFeHApXG4gICAgaWYgKG5ld0RhdGEgJiYgbmV3RGF0YVsxXSkgcmV0dXJuIG5ld0RhdGFbMV1cbiAgICAvLyBAIHtuYW1lfVxuICAgIGNvbnN0IG5hbWVEYXRhID0gY29kZS5tYXRjaChuYW1lUmVnRXhwKVxuICAgIGlmIChuYW1lRGF0YSAmJiBuYW1lRGF0YVsxXSkgcmV0dXJuIG5hbWVEYXRhWzFdXG4gICAgLy8gQG5hbWUge25hbWV9XG4gICAgbGV0IG5hbWUgPSBkYXRhLmZpbHRlcihlbCA9PiBlbFswXSA9PT0gJ25hbWUnKVswXVxuICAgIGlmICghbmFtZSkgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogbm8gbmFtZWBcbiAgICByZXR1cm4gbmFtZVsxXVxuICB9KSgpXG4gIGRhdGEgPSBkYXRhLmZpbHRlcihlbCA9PiBlbFswXSAhPT0gJ25hbWUnKVxuICAvL1xuXG4gIC8vIOODqeOCpOODluODqeODquOBq+mWouOBl+OBplxuICBjb25zdCBsaWJyYXJ5UmVnRXhwID0gbWFrZUxpYnJhcnlSZWdFeHAoJyEnICsgbmFtZSlcbiAgY29uc3QgZW5jbG9zdXJlQ291bnQgPVxuICAgICAgKGNvZGUubWF0Y2gobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSwgJ2cnKSkgfHwgW10pLmxlbmd0aFxuICBpZiAoZW5jbG9zdXJlQ291bnQgPj0gMikgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBoYW5kbGUgMiBvciBtb3JlIGVuY2xvc3VyZXMgXCIvLy8gLS0tLi4uXCJgXG4gIGNvbnN0IHJlcXVpcmVtZW50cyA9IChjb2RlXG4gICAgLm1hdGNoKG5ldyBSZWdFeHAobGlicmFyeVJlZ0V4cCwgJ2cnKSkgfHwgW10pXG4gICAgLm1hcChlbCA9PiAoe1xuICAgICAgb2xkOiBlbCwgbmFtZTogZWwubWF0Y2gobGlicmFyeVJlZ0V4cClbMl0sIGlkOiBJRE1ha2VyLm5leHQoKS52YWx1ZVxuICAgIH0pKSAvLyB7b2xkLCBuYW1lfVxuICAgIC8vIOODqeOCpOODluODqeODquOBrue9ruOBjeaPm+OBiFxuICB7XG4gICAgbGV0IGkgPSAwXG4gICAgY29kZSA9IGNvZGUucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAobGlicmFyeVJlZ0V4cCwgJ2cnKSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGhhc2gocmVxdWlyZW1lbnRzW2krK10uaWQpXG4gICAgICB9XG4gICAgKVxuICB9XG4gIC8vXG5cbiAgLy8gaW1wb3J0IOaKveWHulxuICBjb25zdCBpbXBvcnRzID0gKGNvZGVcbiAgICAubWF0Y2gobmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gQXJyYXkuZnJvbShlbC5tYXRjaChpbXBvcnRSZWdFeHApKSkgLy8gW2FsbCwgbmFtZSwgY29kZV1cbiAgICAubWFwKChbLCBuYW1lLCBvbGRdKSA9PiAoe25hbWUsIG9sZCwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlfSkpXG5cbiAgbGV0IHJlZmFjdG9yZWQgPSBjb2RlIC8vIOOBk+OBk+OBi+OCieWIhuWykFxuXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3UmVnRXhwLCAnJylcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuYW1lUmVnRXhwLCAnJylcblxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpLCAnJylcbiAgeyAvLyBpbXBvcnQg44Gu572u44GN5o+b44GIXG4gICAgbGV0IGkgPSAwXG4gICAgcmVmYWN0b3JlZCA9IHJlZmFjdG9yZWQucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpLFxuICAgICAgKCkgPT4gaGFzaChpbXBvcnRzW2krK10uaWQpXG4gICAgKVxuICB9XG5cbiAgLy8gZGF0YSDjga7nva7jgY3mj5vjgYhcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKGRhdGFSZWdFeHAsICdnJyksICcnKVxuICAvLyByZWZhY3RvcmVkIOOBi+OCieOBr+a2iOOBleOBquOBhFxuXG4gIC8vIOODqeOCpOODluODqeODquOBrue1guOCj+OCiuOBjOWNmOS9k+OBp+aui+OCi+OBqOW0qeOCjOOCi1xuICBpZiAobGliRW5kUmVnRXhwLnRlc3QoXG4gICAgY29kZS5yZXBsYWNlKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJyksICcnKVxuICApKSB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiAke25hbWV9IDogY2Fubm90IGluY2x1ZGUgdW5pdCBsaWIgZW5kYFxuXG4gIGNvbnN0IGVuY2xvc2VkID0gZW5jbG9zdXJlQ291bnQgPyBjb2RlLm1hdGNoKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUpKVswXSA6IGVuY2xvc2UobmFtZSwgY29kZSlcblxuICByZXR1cm4ge1xuICAgIG5hbWUsXG4gICAgZGF0YToge1xuICAgICAgbmFtZSxcbiAgICAgIG5hbWVzcGFjZSxcbiAgICAgIGZpbGVuYW1lLFxuICAgICAgY29kZSwgLy8g44K544OL44Oa44OD44OI55SoXG4gICAgICByZWZhY3RvcmVkLCAvLyDjgoLjgajjga7jgrPjg7zjg4nnva7jgY3mj5vjgYjnlKhcbiAgICAgIGVuY2xvc2VkLCAvLyDku5bjga5yZWZhY3RvcmVk44Gu44KC44Gu44Gr5Z+L44KB6L6844KA55SoXG4gICAgICBkYXRhLFxuICAgICAgb2xkLFxuICAgICAgcmVxdWlyZTogcmVxdWlyZW1lbnRzLFxuICAgICAgaW1wb3J0OiBpbXBvcnRzLFxuICAgICAgZmluaXNoZWQ6IGZhbHNlLFxuICAgICAgcHJvY2Vzc2luZzogZmFsc2VcbiAgICB9XG4gIH1cbn1cbiJdfQ==