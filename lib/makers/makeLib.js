"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @([^ \t\n]+)[ \t]+([^ \n].*)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?=Foo Lib)(.+?) {{{ \/\/\/(?:\n([\s\S]*?)\n|\n)\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const libHead = String.raw`\/\/\/ --- .* {{{ \/\/\/\n`;

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/` + String.raw`(?:\n((?:[\s\S](?!${libHead}))*?)\n|\n)` + String.raw`\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libHeadRegExp = /(?:^|\n)([ \t]*)\/\/\/ --- (.+?) {{{ \/\/\/[\s\S]*?\n(?:\n|$)/;
const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|$)/;
const newRegExp = /^\/\/ @new(?:[ \t]+([^ \n].*))?(?:\n|$)/;
const nameRegExp = /(?<=^|\n)\/\/ @[ \t]+([^\n].*)(?:\n|$)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  let data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    // @new {name}
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1]; // @ {name}

    const nameData = code.match(nameRegExp);
    if (nameData) return nameData[1]; // @name {name}

    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  data = data.filter(el => el[0] !== 'name'); //
  // ライブラリに関して

  const requirements = (() => {
    let _requirements = [];
    const libraryRegExp = makeLibraryRegExp('!' + name);

    while (libraryRegExp.test(code)) {
      const tmp = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
        old: el,
        name: el.match(libraryRegExp)[2],
        id: IDMaker.next().value
      })); // {old, name, id}

      _requirements = [..._requirements, ...tmp]; // ライブラリの置き換え

      {
        let i = 0;
        code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
          return (0, _id.hash)(tmp[i++].id);
        });
      }
    }

    return _requirements;
  })(); //
  // ライブラリの置き換えをした跡に調べないと壊れる


  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`; // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(newRegExp, '');
  code = code.replace(nameRegExp, '');
  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  {
    const hollow = code.replace(makeLibraryRegExp('=' + name, 'g'), '');

    if (libEndRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib END "/// }}}--- ///`;
    } // ついでにhead残りも調べる．


    if (libHeadRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib HEAD "/// --- {name} }}} ///"`;
    }
  }
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      name,
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibGliSGVhZCIsIlN0cmluZyIsInJhdyIsIm1ha2VMaWJyYXJ5UmVnRXhwIiwiZXgiLCJmbGFncyIsIlJlZ0V4cCIsImxpYkhlYWRSZWdFeHAiLCJsaWJFbmRSZWdFeHAiLCJuZXdSZWdFeHAiLCJuYW1lUmVnRXhwIiwiZW5jbG9zZSIsIm5hbWUiLCJjb2RlIiwibWFrZUxpYiIsIm9sZCIsIm5hbWVzcGFjZSIsImZpbGVuYW1lIiwiY29uZmlnIiwiSURNYWtlciIsImRhdGEiLCJtYXRjaCIsIm1hcCIsImVsIiwiQXJyYXkiLCJmcm9tIiwic2hpZnQiLCJmaWx0ZXIiLCJuZXdEYXRhIiwibmFtZURhdGEiLCJyZXF1aXJlbWVudHMiLCJfcmVxdWlyZW1lbnRzIiwibGlicmFyeVJlZ0V4cCIsInRlc3QiLCJ0bXAiLCJpZCIsIm5leHQiLCJ2YWx1ZSIsImkiLCJyZXBsYWNlIiwiZW5jbG9zdXJlQ291bnQiLCJsZW5ndGgiLCJpbXBvcnRzIiwicmVmYWN0b3JlZCIsImhvbGxvdyIsImNvbnNvbGUiLCJlcnJvciIsImVuY2xvc2VkIiwicmVxdWlyZSIsImltcG9ydCIsImZpbmlzaGVkIiwicHJvY2Vzc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLDBEQUFyQjtBQUVBLE1BQU1DLFVBQVUsR0FBRyxvREFBbkIsQyxDQUNBOztBQUNBLE1BQU1DLE9BQU8sR0FBR0MsTUFBTSxDQUFDQyxHQUFJLDRCQUEzQjs7QUFDQSxNQUFNQyxpQkFBaUIsR0FBRyxDQUFDQyxFQUFELEVBQUtDLEtBQUwsS0FBZSxJQUFJQyxNQUFKLENBQ3ZDTCxNQUFNLENBQUNDLEdBQUksaUNBQWdDRSxFQUFHLG1CQUE5QyxHQUNBSCxNQUFNLENBQUNDLEdBQUkscUJBQW9CRixPQUFRLGFBRHZDLEdBRUFDLE1BQU0s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a0JXLE1BQWxCLENBQUosRUFBK0I7QUFDN0JDLE1BQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjRixNQUFkO0FBQ0EsWUFBTyxHQUFFNUIsU0FBVSxNQUFLQyxRQUFTLE1BQUtMLElBQUssZ0RBQTNDO0FBQ0QsS0FMSCxDQU1FOzs7QUFDQSxRQUFJTCxhQUFhLENBQUMwQixJQUFkLENBQW1CVyxNQUFuQixDQUFKLEVBQWdDO0FBQzlCQyxNQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY0YsTUFBZDtBQUNBLFlBQU8sR0FBRTVCLFNBQVUsTUFBS0MsUUFBUyxNQUFLTCxJQUFLLDBEQUEzQztBQUNEO0FBQ0Y7QUFFRCxRQUFNbUMsUUFBUSxHQUFHUCxjQUFjLEdBQUczQixJQUFJLENBQUNRLEtBQUwsQ0FBV2xCLGlCQUFpQixDQUFDLE1BQU1TLElBQVAsQ0FBNUIsRUFBMEMsQ0FBMUMsQ0FBSCxHQUFrREQsT0FBTyxDQUFDQyxJQUFELEVBQU9DLElBQVAsQ0FBeEY7QUFFQSxTQUFPO0FBQ0xELElBQUFBLElBREs7QUFFTFEsSUFBQUEsSUFBSSxFQUFFO0FBQ0pSLE1BQUFBLElBREk7QUFFSkksTUFBQUEsU0FGSTtBQUdKQyxNQUFBQSxRQUhJO0FBSUpKLE1BQUFBLElBSkk7QUFJRTtBQUNOOEIsTUFBQUEsVUFMSTtBQUtRO0FBQ1pJLE1BQUFBLFFBTkk7QUFNTTtBQUNWM0IsTUFBQUEsSUFQSTtBQVFKTCxNQUFBQSxHQVJJO0FBU0ppQyxNQUFBQSxPQUFPLEVBQUVsQixZQVRMO0FBVUptQixNQUFBQSxNQUFNLEVBQUVQLE9BVko7QUFXSlEsTUFBQUEsUUFBUSxFQUFFLEtBWE47QUFZSkMsTUFBQUEsVUFBVSxFQUFFO0FBWlI7QUFGRCxHQUFQO0FBaUJEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnLi4vZm9ybWF0dGVyJ1xuaW1wb3J0IHsgaGFzaCwgbWFrZUlETWFrZXIgfSBmcm9tICcuLi9pZCdcblxuY29uc3QgaW1wb3J0UmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQGltcG9ydCAoLispXFxuPyhbXFxzXFxTXSo/KVxcblxcL1xcLyBAQCg/PVxcbnwkKS9cblxuY29uc3QgZGF0YVJlZ0V4cCA9IC8oPzw9XnxcXG4pXFwvXFwvIEAoW14gXFx0XFxuXSspWyBcXHRdKyhbXiBcXG5dLiopKD86XFxufCQpL1xuLy8gKD88PV58XFxuKShbIFxcdF0qKVxcL1xcL1xcLyAtLS0gKD89Rm9vIExpYikoLis/KSB7e3sgXFwvXFwvXFwvKD86XFxuKFtcXHNcXFNdKj8pXFxufFxcbilcXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKVxuY29uc3QgbGliSGVhZCA9IFN0cmluZy5yYXdgXFwvXFwvXFwvIC0tLSAuKiB7e3sgXFwvXFwvXFwvXFxuYFxuY29uc3QgbWFrZUxpYnJhcnlSZWdFeHAgPSAoZXgsIGZsYWdzKSA9PiBuZXcgUmVnRXhwKFxuICBTdHJpbmcucmF3YCg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/JHtleH0pKC4rPykge3t7IFxcL1xcL1xcL2AgK1xuICBTdHJpbmcucmF3YCg/OlxcbigoPzpbXFxzXFxTXSg/ISR7bGliSGVhZH0pKSo/KVxcbnxcXG4pYCArXG4gIFN0cmluZy5yYXdgXFwxXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPz1cXG58JClgLFxuICBmbGFnc1xuKVxuXG5jb25zdCBsaWJIZWFkUmVnRXhwID0gLyg/Ol58XFxuKShbIFxcdF0qKVxcL1xcL1xcLyAtLS0gKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG4oPzpcXG58JCkvXG5jb25zdCBsaWJFbmRSZWdFeHAgPSAvKD86XnxcXG4pWyBcXHRdKlxcL1xcL1xcLyB9fX0tLS0gXFwvXFwvXFwvKD86XFxufCQpL1xuY29uc3QgbmV3UmVnRXhwID0gL15cXC9cXC8gQG5ldyg/OlsgXFx0XSsoW14gXFxuXS4qKSk/KD86XFxufCQpL1xuY29uc3QgbmFtZVJlZ0V4cCA9IC8oPzw9XnxcXG4pXFwvXFwvIEBbIFxcdF0rKFteXFxuXS4qKSg/OlxcbnwkKS9cblxuY29uc3QgZW5jbG9zZSA9IChuYW1lLCBjb2RlKSA9PiBgLy8vIC0tLSAke25hbWV9IHt7eyAvLy9cXG4ke2NvZGV9XFxuLy8vIH19fS0tLSAvLy9gXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWtlTGliIChvbGQsIG5hbWVzcGFjZSwgZmlsZW5hbWUsIGNvbmZpZykge1xuICBjb25zdCBJRE1ha2VyID0gbWFrZUlETWFrZXIoKVxuICBsZXQgY29kZSA9IG9sZCAvLyDjgYTjgo/jgobjgotzbmlwcGV055So44Gu44Kz44O844OJXG4gIGNvZGUgPSBhd2FpdCBmb3JtYXQoY29kZSwgY29uZmlnKVxuXG4gIC8vIOODh+ODvOOCv+aKveWHulxuICBsZXQgZGF0YSA9IChjb2RlLm1hdGNoKG5ldyBSZWdFeHAoZGF0YVJlZ0V4cCwgJ2cnKSkgfHwgW10pXG4gICAgLm1hcChlbCA9PiBBcnJheS5mcm9tKGVsLm1hdGNoKGRhdGFSZWdFeHApKSkgLy8gW2FsbCwgbmFtZSwgZGF0YV1cbiAgICAubWFwKGVsID0+IChlbC5zaGlmdCgpLCBlbCkpIC8vIFtuYW1lLCBkYXRhXVxuICAgIC5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICdpbXBvcnQnKVxuICAgIC5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICduZXcnKVxuICBjb25zdCBuYW1lID0gKCgpID0+IHtcbiAgICAvLyBAbmV3IHtuYW1lfVxuICAgIGNvbnN0IG5ld0RhdGEgPSBjb2RlLm1hdGNoKG5ld1JlZ0V4cClcbiAgICBpZiAobmV3RGF0YSAmJiBuZXdEYXRhWzFdKSByZXR1cm4gbmV3RGF0YVsxXVxuICAgIC8vIEAge25hbWV9XG4gICAgY29uc3QgbmFtZURhdGEgPSBjb2RlLm1hdGNoKG5hbWVSZWdFeHApXG4gICAgaWYgKG5hbWVEYXRhKSByZXR1cm4gbmFtZURhdGFbMV1cbiAgICAvLyBAbmFtZSB7bmFtZX1cbiAgICBsZXQgbmFtZSA9IGRhdGEuZmlsdGVyKGVsID0+IGVsWzBdID09PSAnbmFtZScpWzBdXG4gICAgaWYgKCFuYW1lKSB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiBubyBuYW1lYFxuICAgIHJldHVybiBuYW1lWzFdXG4gIH0pKClcbiAgZGF0YSA9IGRhdGEuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnbmFtZScpXG4gIC8vXG5cbiAgLy8g44Op44Kk44OW44Op44Oq44Gr6Zai44GX44GmXG4gIGNvbnN0IHJlcXVpcmVtZW50cyA9ICgoKSA9PiB7XG4gICAgbGV0IF9yZXF1aXJlbWVudHMgPSBbXVxuICAgIGNvbnN0IGxpYnJhcnlSZWdFeHAgPSBtYWtlTGlicmFyeVJlZ0V4cCgnIScgKyBuYW1lKVxuICAgIHdoaWxlIChsaWJyYXJ5UmVnRXhwLnRlc3QoY29kZSkpIHtcbiAgICAgIGNvbnN0IHRtcCA9IChjb2RlXG4gICAgICAgIC5tYXRjaChuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgICAgICAubWFwKGVsID0+ICh7XG4gICAgICAgICAgb2xkOiBlbCwgbmFtZTogZWwubWF0Y2gobGlicmFyeVJlZ0V4cClbMl0sIGlkOiBJRE1ha2VyLm5leHQoKS52YWx1ZVxuICAgICAgICB9KSkgLy8ge29sZCwgbmFtZSwgaWR9XG4gICAgICBfcmVxdWlyZW1lbnRzID0gWy4uLl9yZXF1aXJlbWVudHMsIC4uLnRtcF1cbiAgICAgIC8vIOODqeOCpOODluODqeODquOBrue9ruOBjeaPm+OBiFxuICAgICAge1xuICAgICAgICBsZXQgaSA9IDBcbiAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShcbiAgICAgICAgICBuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJyksXG4gICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGhhc2godG1wW2krK10uaWQpXG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBfcmVxdWlyZW1lbnRzXG4gIH0pKClcbiAgLy9cbiAgLy8g44Op44Kk44OW44Op44Oq44Gu572u44GN5o+b44GI44KS44GX44Gf6Leh44Gr6Kq/44G544Gq44GE44Go5aOK44KM44KLXG4gIGNvbnN0IGVuY2xvc3VyZUNvdW50ID1cbiAgICAgIChjb2RlLm1hdGNoKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJykpIHx8IFtdKS5sZW5ndGhcbiAgaWYgKGVuY2xvc3VyZUNvdW50ID49IDIpIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6ICR7bmFtZX0gOiBjYW5ub3QgaGFuZGxlIDIgb3IgbW9yZSBlbmNsb3N1cmVzIFwiLy8vIC0tLS4uLlwiYFxuXG4gIC8vIGltcG9ydCDmir3lh7pcbiAgY29uc3QgaW1wb3J0cyA9IChjb2RlXG4gICAgLm1hdGNoKG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpKSB8fCBbXSlcbiAgICAubWFwKGVsID0+IEFycmF5LmZyb20oZWwubWF0Y2goaW1wb3J0UmVnRXhwKSkpIC8vIFthbGwsIG5hbWUsIGNvZGVdXG4gICAgLm1hcCgoWywgbmFtZSwgb2xkXSkgPT4gKHtuYW1lLCBvbGQsIGlkOiBJRE1ha2VyLm5leHQoKS52YWx1ZX0pKVxuXG4gIGxldCByZWZhY3RvcmVkID0gY29kZSAvLyDjgZPjgZPjgYvjgonliIblspBcblxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ld1JlZ0V4cCwgJycpXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmFtZVJlZ0V4cCwgJycpXG5cbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSwgJycpXG4gIHsgLy8gaW1wb3J0IOOBrue9ruOBjeaPm+OBiFxuICAgIGxldCBpID0gMFxuICAgIHJlZmFjdG9yZWQgPSByZWZhY3RvcmVkLnJlcGxhY2UoXG4gICAgICBuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSxcbiAgICAgICgpID0+IGhhc2goaW1wb3J0c1tpKytdLmlkKVxuICAgIClcbiAgfVxuXG4gIC8vIGRhdGEg44Gu572u44GN5o+b44GIXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChkYXRhUmVnRXhwLCAnZycpLCAnJylcbiAgLy8gcmVmYWN0b3JlZCDjgYvjgonjga/mtojjgZXjgarjgYRcblxuICAvLyDjg6njgqTjg5bjg6njg6rjga7ntYLjgo/jgorjgYzljZjkvZPjgafmrovjgovjgajltKnjgozjgotcbiAge1xuICAgIGNvbnN0IGhvbGxvdyA9IGNvZGUucmVwbGFjZShtYWtlTGlicmFyeVJlZ0V4cCgnPScgKyBuYW1lLCAnZycpLCAnJylcbiAgICBpZiAobGliRW5kUmVnRXhwLnRlc3QoaG9sbG93KSkge1xuICAgICAgY29uc29sZS5lcnJvcihob2xsb3cpXG4gICAgICB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiAke25hbWV9IDogY2Fubm90IGluY2x1ZGUgdW5pdCBsaWIgRU5EIFwiLy8vIH19fS0tLSAvLy9gXG4gICAgfVxuICAgIC8vIOOBpOOBhOOBp+OBq2hlYWTmrovjgorjgoLoqr/jgbnjgovvvI5cbiAgICBpZiAobGliSGVhZFJlZ0V4cC50ZXN0KGhvbGxvdykpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoaG9sbG93KVxuICAgICAgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBpbmNsdWRlIHVuaXQgbGliIEhFQUQgXCIvLy8gLS0tIHtuYW1lfSB9fX0gLy8vXCJgXG4gICAgfVxuICB9XG5cbiAgY29uc3QgZW5jbG9zZWQgPSBlbmNsb3N1cmVDb3VudCA/IGNvZGUubWF0Y2gobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSkpWzBdIDogZW5jbG9zZShuYW1lLCBjb2RlKVxuXG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBkYXRhOiB7XG4gICAgICBuYW1lLFxuICAgICAgbmFtZXNwYWNlLFxuICAgICAgZmlsZW5hbWUsXG4gICAgICBjb2RlLCAvLyDjgrnjg4vjg5rjg4Pjg4jnlKhcbiAgICAgIHJlZmFjdG9yZWQsIC8vIOOCguOBqOOBruOCs+ODvOODiee9ruOBjeaPm+OBiOeUqFxuICAgICAgZW5jbG9zZWQsIC8vIOS7luOBrnJlZmFjdG9yZWTjga7jgoLjga7jgavln4vjgoHovrzjgoDnlKhcbiAgICAgIGRhdGEsXG4gICAgICBvbGQsXG4gICAgICByZXF1aXJlOiByZXF1aXJlbWVudHMsXG4gICAgICBpbXBvcnQ6IGltcG9ydHMsXG4gICAgICBmaW5pc2hlZDogZmFsc2UsXG4gICAgICBwcm9jZXNzaW5nOiBmYWxzZVxuICAgIH1cbiAgfVxufVxuIl19