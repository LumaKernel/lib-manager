"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @([^ \t\n]+)[ \t]+([^ \n].*)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?=Foo Lib)(.+?) {{{ \/\/\/(?:\n([\s\S]*?)\n|\n)\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const libHead = String.raw`\/\/\/ --- .* {{{ \/\/\/\n`;

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/` + String.raw`(?:\n((?:[\s\S](?!${libHead}))*?)\n|\n)` + String.raw`\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libHeadRegExp = /(?:^|\n)([ \t]*)\/\/\/ --- (.+?) {{{ \/\/\/[\s\S]*?\n(?:\n|$)/;
const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|$)/;
const newRegExp = /^\/\/ @new(?:[ \t]+([^ \n].*))?(?:\n|$)/;
const nameRegExp = /(?<=^|\n)\/\/ @[ \t]+([^\n].*)(?:\n|$)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  let data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    // @new {name}
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1]; // @ {name}

    const nameData = code.match(nameRegExp);
    if (nameData) return nameData[1]; // @name {name}

    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  data = data.filter(el => el[0] !== 'name'); //
  // ライブラリに関して

  const requirements = (() => {
    let _requirements = [];
    const libraryRegExp = makeLibraryRegExp('!' + name);

    while (libraryRegExp.test(code)) {
      const tmp = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
        old: el,
        name: el.match(libraryRegExp)[2],
        id: IDMaker.next().value
      })); // {old, name, id}

      _requirements = [..._requirements, ...tmp]; // ライブラリの置き換え

      {
        let i = 0;
        code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
          return (0, _id.hash)(tmp[i++].id);
        });
      }
    }

    return _requirements;
  })(); //
  // ライブラリの置き換えをした跡に調べないと壊れる


  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`; // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(newRegExp, '');
  code = code.replace(nameRegExp, '');
  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  {
    const hollow = code.replace(makeLibraryRegExp('=' + name, 'g'), '');

    if (libEndRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib END "/// }}}--- ///`;
    } // ついでにhead残りも調べる．


    if (libHeadRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib HEAD "/// --- {name} }}} ///"`;
    }
  }
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      name,
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibGliSGVhZCIsIlN0cmluZyIsInJhdyIsIm1ha2VMaWJyYXJ5UmVnRXhwIiwiZXgiLCJmbGFncyIsIlJlZ0V4cCIsImxpYkhlYWRSZWdFeHAiLCJsaWJFbmRSZWdFeHAiLCJuZXdSZWdFeHAiLCJuYW1lUmVnRXhwIiwiZW5jbG9zZSIsIm5hbWUiLCJjb2RlIiwibWFrZUxpYiIsIm9sZCIsIm5hbWVzcGFjZSIsImZpbGVuYW1lIiwiY29uZmlnIiwiSURNYWtlciIsImRhdGEiLCJtYXRjaCIsIm1hcCIsImVsIiwiQXJyYXkiLCJmcm9tIiwic2hpZnQiLCJmaWx0ZXIiLCJuZXdEYXRhIiwibmFtZURhdGEiLCJyZXF1aXJlbWVudHMiLCJfcmVxdWlyZW1lbnRzIiwibGlicmFyeVJlZ0V4cCIsInRlc3QiLCJ0bXAiLCJpZCIsIm5leHQiLCJ2YWx1ZSIsImkiLCJyZXBsYWNlIiwiZW5jbG9zdXJlQ291bnQiLCJsZW5ndGgiLCJpbXBvcnRzIiwicmVmYWN0b3JlZCIsImhvbGxvdyIsImNvbnNvbGUiLCJlcnJvciIsImVuY2xvc2VkIiwicmVxdWlyZSIsImltcG9ydCIsImZpbmlzaGVkIiwicHJvY2Vzc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLDBEQUFyQjtBQUVBLE1BQU1DLFVBQVUsR0FBRyxvREFBbkIsQyxDQUNBOztBQUNBLE1BQU1DLE9BQU8sR0FBR0MsTUFBTSxDQUFDQyxHQUFJLDRCQUEzQjs7QUFDQSxNQUFNQyxpQkFBaUIsR0FBRyxDQUFDQyxFQUFELEVBQUtDLEtBQUwsS0FBZSxJQUFJQyxNQUFKLENBQ3ZDTCxNQUFNLENBQUNDLEdBQUksaUNBQWdDRSxFQUFHLG1CQUE5QyxHQUNBSCxNQUFNLENBQUNDLEdBQUkscUJBQW9CRixPQUFRLGFBRHZDLEdBRUFDLE1BQU0s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a0JXLE1BQWxCLENBQUosRUFBK0I7QUFDN0JDLE1BQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjRixNQUFkO0FBQ0EsWUFBTyxHQUFFNUIsU0FBVSxNQUFLQyxRQUFTLE1BQUtMLElBQUssZ0RBQTNDO0FBQ0QsS0FMSCxDQU1FOzs7QUFDQSxRQUFJTCxhQUFhLENBQUMwQixJQUFkLENBQW1CVyxNQUFuQixDQUFKLEVBQWdDO0FBQzlCQyxNQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY0YsTUFBZDtBQUNBLFlBQU8sR0FBRTVCLFNBQVUsTUFBS0MsUUFBUyxNQUFLTCxJQUFLLDBEQUEzQztBQUNEO0FBQ0Y7QUFFRCxRQUFNbUMsUUFBUSxHQUFHUCxjQUFjLEdBQUczQixJQUFJLENBQUNRLEtBQUwsQ0FBV2xCLGlCQUFpQixDQUFDLE1BQU1TLElBQVAsQ0FBNUIsRUFBMEMsQ0FBMUMsQ0FBSCxHQUFrREQsT0FBTyxDQUFDQyxJQUFELEVBQU9DLElBQVAsQ0FBeEY7QUFFQSxTQUFPO0FBQ0xELElBQUFBLElBREs7QUFFTFEsSUFBQUEsSUFBSSxFQUFFO0FBQ0pSLE1BQUFBLElBREk7QUFFSkksTUFBQUEsU0FGSTtBQUdKQyxNQUFBQSxRQUhJO0FBSUpKLE1BQUFBLElBSkk7QUFJRTtBQUNOOEIsTUFBQUEsVUFMSTtBQUtRO0FBQ1pJLE1BQUFBLFFBTkk7QUFNTTtBQUNWM0IsTUFBQUEsSUFQSTtBQVFKTCxNQUFBQSxHQVJJO0FBU0ppQyxNQUFBQSxPQUFPLEVBQUVsQixZQVRMO0FBVUptQixNQUFBQSxNQUFNLEVBQUVQLE9BVko7QUFXSlEsTUFBQUEsUUFBUSxFQUFFLEtBWE47QUFZSkMsTUFBQUEsVUFBVSxFQUFFO0FBWlI7QUFGRCxHQUFQO0FBaUJEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnLi4vZm9ybWF0dGVyJ1xyXG5pbXBvcnQgeyBoYXNoLCBtYWtlSURNYWtlciB9IGZyb20gJy4uL2lkJ1xyXG5cclxuY29uc3QgaW1wb3J0UmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQGltcG9ydCAoLispXFxuPyhbXFxzXFxTXSo/KVxcblxcL1xcLyBAQCg/PVxcbnwkKS9cclxuXHJcbmNvbnN0IGRhdGFSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAKFteIFxcdFxcbl0rKVsgXFx0XSsoW14gXFxuXS4qKSg/OlxcbnwkKS9cclxuLy8gKD88PV58XFxuKShbIFxcdF0qKVxcL1xcL1xcLyAtLS0gKD89Rm9vIExpYikoLis/KSB7e3sgXFwvXFwvXFwvKD86XFxuKFtcXHNcXFNdKj8pXFxufFxcbilcXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKVxyXG5jb25zdCBsaWJIZWFkID0gU3RyaW5nLnJhd2BcXC9cXC9cXC8gLS0tIC4qIHt7eyBcXC9cXC9cXC9cXG5gXHJcbmNvbnN0IG1ha2VMaWJyYXJ5UmVnRXhwID0gKGV4LCBmbGFncykgPT4gbmV3IFJlZ0V4cChcclxuICBTdHJpbmcucmF3YCg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/JHtleH0pKC4rPykge3t7IFxcL1xcL1xcL2AgK1xyXG4gIFN0cmluZy5yYXdgKD86XFxuKCg/OltcXHNcXFNdKD8hJHtsaWJIZWFkfSkpKj8pXFxufFxcbilgICtcclxuICBTdHJpbmcucmF3YFxcMVxcL1xcL1xcLyB9fX0tLS0gXFwvXFwvXFwvKD89XFxufCQpYCxcclxuICBmbGFnc1xyXG4pXHJcblxyXG5jb25zdCBsaWJIZWFkUmVnRXhwID0gLyg/Ol58XFxuKShbIFxcdF0qKVxcL1xcL1xcLyAtLS0gKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG4oPzpcXG58JCkvXHJcbmNvbnN0IGxpYkVuZFJlZ0V4cCA9IC8oPzpefFxcbilbIFxcdF0qXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPzpcXG58JCkvXHJcbmNvbnN0IG5ld1JlZ0V4cCA9IC9eXFwvXFwvIEBuZXcoPzpbIFxcdF0rKFteIFxcbl0uKikpPyg/OlxcbnwkKS9cclxuY29uc3QgbmFtZVJlZ0V4cCA9IC8oPzw9XnxcXG4pXFwvXFwvIEBbIFxcdF0rKFteXFxuXS4qKSg/OlxcbnwkKS9cclxuXHJcbmNvbnN0IGVuY2xvc2UgPSAobmFtZSwgY29kZSkgPT4gYC8vLyAtLS0gJHtuYW1lfSB7e3sgLy8vXFxuJHtjb2RlfVxcbi8vLyB9fX0tLS0gLy8vYFxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1ha2VMaWIgKG9sZCwgbmFtZXNwYWNlLCBmaWxlbmFtZSwgY29uZmlnKSB7XHJcbiAgY29uc3QgSURNYWtlciA9IG1ha2VJRE1ha2VyKClcclxuICBsZXQgY29kZSA9IG9sZCAvLyDjgYTjgo/jgobjgotzbmlwcGV055So44Gu44Kz44O844OJXHJcbiAgY29kZSA9IGF3YWl0IGZvcm1hdChjb2RlLCBjb25maWcpXHJcblxyXG4gIC8vIOODh+ODvOOCv+aKveWHulxyXG4gIGxldCBkYXRhID0gKGNvZGUubWF0Y2gobmV3IFJlZ0V4cChkYXRhUmVnRXhwLCAnZycpKSB8fCBbXSlcclxuICAgIC5tYXAoZWwgPT4gQXJyYXkuZnJvbShlbC5tYXRjaChkYXRhUmVnRXhwKSkpIC8vIFthbGwsIG5hbWUsIGRhdGFdXHJcbiAgICAubWFwKGVsID0+IChlbC5zaGlmdCgpLCBlbCkpIC8vIFtuYW1lLCBkYXRhXVxyXG4gICAgLmZpbHRlcihlbCA9PiBlbFswXSAhPT0gJ2ltcG9ydCcpXHJcbiAgICAuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnbmV3JylcclxuICBjb25zdCBuYW1lID0gKCgpID0+IHtcclxuICAgIC8vIEBuZXcge25hbWV9XHJcbiAgICBjb25zdCBuZXdEYXRhID0gY29kZS5tYXRjaChuZXdSZWdFeHApXHJcbiAgICBpZiAobmV3RGF0YSAmJiBuZXdEYXRhWzFdKSByZXR1cm4gbmV3RGF0YVsxXVxyXG4gICAgLy8gQCB7bmFtZX1cclxuICAgIGNvbnN0IG5hbWVEYXRhID0gY29kZS5tYXRjaChuYW1lUmVnRXhwKVxyXG4gICAgaWYgKG5hbWVEYXRhKSByZXR1cm4gbmFtZURhdGFbMV1cclxuICAgIC8vIEBuYW1lIHtuYW1lfVxyXG4gICAgbGV0IG5hbWUgPSBkYXRhLmZpbHRlcihlbCA9PiBlbFswXSA9PT0gJ25hbWUnKVswXVxyXG4gICAgaWYgKCFuYW1lKSB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiBubyBuYW1lYFxyXG4gICAgcmV0dXJuIG5hbWVbMV1cclxuICB9KSgpXHJcbiAgZGF0YSA9IGRhdGEuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnbmFtZScpXHJcbiAgLy9cclxuXHJcbiAgLy8g44Op44Kk44OW44Op44Oq44Gr6Zai44GX44GmXHJcbiAgY29uc3QgcmVxdWlyZW1lbnRzID0gKCgpID0+IHtcclxuICAgIGxldCBfcmVxdWlyZW1lbnRzID0gW11cclxuICAgIGNvbnN0IGxpYnJhcnlSZWdFeHAgPSBtYWtlTGlicmFyeVJlZ0V4cCgnIScgKyBuYW1lKVxyXG4gICAgd2hpbGUgKGxpYnJhcnlSZWdFeHAudGVzdChjb2RlKSkge1xyXG4gICAgICBjb25zdCB0bXAgPSAoY29kZVxyXG4gICAgICAgIC5tYXRjaChuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJykpIHx8IFtdKVxyXG4gICAgICAgIC5tYXAoZWwgPT4gKHtcclxuICAgICAgICAgIG9sZDogZWwsIG5hbWU6IGVsLm1hdGNoKGxpYnJhcnlSZWdFeHApWzJdLCBpZDogSURNYWtlci5uZXh0KCkudmFsdWVcclxuICAgICAgICB9KSkgLy8ge29sZCwgbmFtZSwgaWR9XHJcbiAgICAgIF9yZXF1aXJlbWVudHMgPSBbLi4uX3JlcXVpcmVtZW50cywgLi4udG1wXVxyXG4gICAgICAvLyDjg6njgqTjg5bjg6njg6rjga7nva7jgY3mj5vjgYhcclxuICAgICAge1xyXG4gICAgICAgIGxldCBpID0gMFxyXG4gICAgICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UoXHJcbiAgICAgICAgICBuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJyksXHJcbiAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBoYXNoKHRtcFtpKytdLmlkKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIClcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIF9yZXF1aXJlbWVudHNcclxuICB9KSgpXHJcbiAgLy9cclxuICAvLyDjg6njgqTjg5bjg6njg6rjga7nva7jgY3mj5vjgYjjgpLjgZfjgZ/ot6Hjgavoqr/jgbnjgarjgYTjgajlo4rjgozjgotcclxuICBjb25zdCBlbmNsb3N1cmVDb3VudCA9XHJcbiAgICAgIChjb2RlLm1hdGNoKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJykpIHx8IFtdKS5sZW5ndGhcclxuICBpZiAoZW5jbG9zdXJlQ291bnQgPj0gMikgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBoYW5kbGUgMiBvciBtb3JlIGVuY2xvc3VyZXMgXCIvLy8gLS0tLi4uXCJgXHJcblxyXG4gIC8vIGltcG9ydCDmir3lh7pcclxuICBjb25zdCBpbXBvcnRzID0gKGNvZGVcclxuICAgIC5tYXRjaChuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSkgfHwgW10pXHJcbiAgICAubWFwKGVsID0+IEFycmF5LmZyb20oZWwubWF0Y2goaW1wb3J0UmVnRXhwKSkpIC8vIFthbGwsIG5hbWUsIGNvZGVdXHJcbiAgICAubWFwKChbLCBuYW1lLCBvbGRdKSA9PiAoe25hbWUsIG9sZCwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlfSkpXHJcblxyXG4gIGxldCByZWZhY3RvcmVkID0gY29kZSAvLyDjgZPjgZPjgYvjgonliIblspBcclxuXHJcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXdSZWdFeHAsICcnKVxyXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmFtZVJlZ0V4cCwgJycpXHJcblxyXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJyksICcnKVxyXG4gIHsgLy8gaW1wb3J0IOOBrue9ruOBjeaPm+OBiFxyXG4gICAgbGV0IGkgPSAwXHJcbiAgICByZWZhY3RvcmVkID0gcmVmYWN0b3JlZC5yZXBsYWNlKFxyXG4gICAgICBuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSxcclxuICAgICAgKCkgPT4gaGFzaChpbXBvcnRzW2krK10uaWQpXHJcbiAgICApXHJcbiAgfVxyXG5cclxuICAvLyBkYXRhIOOBrue9ruOBjeaPm+OBiFxyXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChkYXRhUmVnRXhwLCAnZycpLCAnJylcclxuICAvLyByZWZhY3RvcmVkIOOBi+OCieOBr+a2iOOBleOBquOBhFxyXG5cclxuICAvLyDjg6njgqTjg5bjg6njg6rjga7ntYLjgo/jgorjgYzljZjkvZPjgafmrovjgovjgajltKnjgozjgotcclxuICB7XHJcbiAgICBjb25zdCBob2xsb3cgPSBjb2RlLnJlcGxhY2UobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSwgJ2cnKSwgJycpXHJcbiAgICBpZiAobGliRW5kUmVnRXhwLnRlc3QoaG9sbG93KSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGhvbGxvdylcclxuICAgICAgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBpbmNsdWRlIHVuaXQgbGliIEVORCBcIi8vLyB9fX0tLS0gLy8vYFxyXG4gICAgfVxyXG4gICAgLy8g44Gk44GE44Gn44GraGVhZOaui+OCiuOCguiqv+OBueOCi++8jlxyXG4gICAgaWYgKGxpYkhlYWRSZWdFeHAudGVzdChob2xsb3cpKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoaG9sbG93KVxyXG4gICAgICB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiAke25hbWV9IDogY2Fubm90IGluY2x1ZGUgdW5pdCBsaWIgSEVBRCBcIi8vLyAtLS0ge25hbWV9IH19fSAvLy9cImBcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0IGVuY2xvc2VkID0gZW5jbG9zdXJlQ291bnQgPyBjb2RlLm1hdGNoKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUpKVswXSA6IGVuY2xvc2UobmFtZSwgY29kZSlcclxuXHJcbiAgcmV0dXJuIHtcclxuICAgIG5hbWUsXHJcbiAgICBkYXRhOiB7XHJcbiAgICAgIG5hbWUsXHJcbiAgICAgIG5hbWVzcGFjZSxcclxuICAgICAgZmlsZW5hbWUsXHJcbiAgICAgIGNvZGUsIC8vIOOCueODi+ODmuODg+ODiOeUqFxyXG4gICAgICByZWZhY3RvcmVkLCAvLyDjgoLjgajjga7jgrPjg7zjg4nnva7jgY3mj5vjgYjnlKhcclxuICAgICAgZW5jbG9zZWQsIC8vIOS7luOBrnJlZmFjdG9yZWTjga7jgoLjga7jgavln4vjgoHovrzjgoDnlKhcclxuICAgICAgZGF0YSxcclxuICAgICAgb2xkLFxyXG4gICAgICByZXF1aXJlOiByZXF1aXJlbWVudHMsXHJcbiAgICAgIGltcG9ydDogaW1wb3J0cyxcclxuICAgICAgZmluaXNoZWQ6IGZhbHNlLFxyXG4gICAgICBwcm9jZXNzaW5nOiBmYWxzZVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=