"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @([^ \t\n]+)[ \t]+([^ \n].*)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?!Foo Lib)(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const libHead = String.raw`\/\/\/ --- .* {{{ \/\/\/\n`;

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/\n(?!${libHead})` + String.raw`(?:[\s\S](?!${libHead}))*?\n` + String.raw`\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libHeadRegExp = /(?:^|\n)([ \t]*)\/\/\/ --- (.+?) {{{ \/\/\/[\s\S]*?\n(?:\n|$)/;
const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|$)/;
const newRegExp = /^\/\/ @new(?:[ \t]+([^ \n].*))?(?:\n|$)/;
const nameRegExp = /(?<=^|\n)\/\/ @[ \t]+([^ \t\n].*)(?:\n|$)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  let data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    // @new {name}
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1]; // @ {name}

    const nameData = code.match(nameRegExp);
    if (nameData) return nameData[1]; // @name {name}

    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  data = data.filter(el => el[0] !== 'name'); //
  // ライブラリに関して

  const requirements = (() => {
    let _requirements = [];
    const libraryRegExp = makeLibraryRegExp('!' + name);

    while (libraryRegExp.test(code)) {
      const tmp = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
        old: el,
        name: el.match(libraryRegExp)[2],
        id: IDMaker.next().value
      })); // {old, name, id}

      _requirements = [..._requirements, ...tmp]; // ライブラリの置き換え

      {
        let i = 0;
        code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
          return (0, _id.hash)(tmp[i++].id);
        });
      }
    }

    return _requirements;
  })(); //
  // ライブラリの置き換えをした跡に調べないと壊れる


  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`; // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(newRegExp, '');
  code = code.replace(nameRegExp, '');
  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  {
    const hollow = code.replace(makeLibraryRegExp('=' + name, 'g'), '');

    if (libEndRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib END "/// }}}--- ///`;
    } // ついでにhead残りも調べる．


    if (libHeadRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib HEAD "/// --- {name} }}} ///"`;
    }
  }
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      name,
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibGliSGVhZCIsIlN0cmluZyIsInJhdyIsIm1ha2VMaWJyYXJ5UmVnRXhwIiwiZXgiLCJmbGFncyIsIlJlZ0V4cCIsImxpYkhlYWRSZWdFeHAiLCJsaWJFbmRSZWdFeHAiLCJuZXdSZWdFeHAiLCJuYW1lUmVnRXhwIiwiZW5jbG9zZSIsIm5hbWUiLCJjb2RlIiwibWFrZUxpYiIsIm9sZCIsIm5hbWVzcGFjZSIsImZpbGVuYW1lIiwiY29uZmlnIiwiSURNYWtlciIsImRhdGEiLCJtYXRjaCIsIm1hcCIsImVsIiwiQXJyYXkiLCJmcm9tIiwic2hpZnQiLCJmaWx0ZXIiLCJuZXdEYXRhIiwibmFtZURhdGEiLCJyZXF1aXJlbWVudHMiLCJfcmVxdWlyZW1lbnRzIiwibGlicmFyeVJlZ0V4cCIsInRlc3QiLCJ0bXAiLCJpZCIsIm5leHQiLCJ2YWx1ZSIsImkiLCJyZXBsYWNlIiwiZW5jbG9zdXJlQ291bnQiLCJsZW5ndGgiLCJpbXBvcnRzIiwicmVmYWN0b3JlZCIsImhvbGxvdyIsImNvbnNvbGUiLCJlcnJvciIsImVuY2xvc2VkIiwicmVxdWlyZSIsImltcG9ydCIsImZpbmlzaGVkIiwicHJvY2Vzc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLDBEQUFyQjtBQUVBLE1BQU1DLFVBQVUsR0FBRyxvREFBbkIsQyxDQUNBOztBQUNBLE1BQU1DLE9BQU8sR0FBR0MsTUFBTSxDQUFDQyxHQUFJLDRCQUEzQjs7QUFDQSxNQUFNQyxpQkFBaUIsR0FBRyxDQUFDQyxFQUFELEVBQUtDLEtBQUwsS0FBZSxJQUFJQyxNQUFKLENBQ3ZDTCxNQUFNLENBQUNDLEdBQUksaUNBQWdDRSxFQUFHLHlCQUF3QkosT0FBUSxHQUE5RSxHQUNBQyxNQUFNLENBQUNDLEdBQUksZUFBY0YsT0FBUSxRQURqQyxH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QixJQUFiLENBQWtCVyxNQUFsQixDQUFKLEVBQStCO0FBQzdCQyxNQUFBQSxPQUFPLENBQUNDLEtBQVIsQ0FBY0YsTUFBZDtBQUNBLFlBQU8sR0FBRTVCLFNBQVUsTUFBS0MsUUFBUyxNQUFLTCxJQUFLLGdEQUEzQztBQUNELEtBTEgsQ0FNRTs7O0FBQ0EsUUFBSUwsYUFBYSxDQUFDMEIsSUFBZCxDQUFtQlcsTUFBbkIsQ0FBSixFQUFnQztBQUM5QkMsTUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWNGLE1BQWQ7QUFDQSxZQUFPLEdBQUU1QixTQUFVLE1BQUtDLFFBQVMsTUFBS0wsSUFBSywwREFBM0M7QUFDRDtBQUNGO0FBRUQsUUFBTW1DLFFBQVEsR0FBR1AsY0FBYyxHQUFHM0IsSUFBSSxDQUFDUSxLQUFMLENBQVdsQixpQkFBaUIsQ0FBQyxNQUFNUyxJQUFQLENBQTVCLEVBQTBDLENBQTFDLENBQUgsR0FBa0RELE9BQU8sQ0FBQ0MsSUFBRCxFQUFPQyxJQUFQLENBQXhGO0FBRUEsU0FBTztBQUNMRCxJQUFBQSxJQURLO0FBRUxRLElBQUFBLElBQUksRUFBRTtBQUNKUixNQUFBQSxJQURJO0FBRUpJLE1BQUFBLFNBRkk7QUFHSkMsTUFBQUEsUUFISTtBQUlKSixNQUFBQSxJQUpJO0FBSUU7QUFDTjhCLE1BQUFBLFVBTEk7QUFLUTtBQUNaSSxNQUFBQSxRQU5JO0FBTU07QUFDVjNCLE1BQUFBLElBUEk7QUFRSkwsTUFBQUEsR0FSSTtBQVNKaUMsTUFBQUEsT0FBTyxFQUFFbEIsWUFUTDtBQVVKbUIsTUFBQUEsTUFBTSxFQUFFUCxPQVZKO0FBV0pRLE1BQUFBLFFBQVEsRUFBRSxLQVhOO0FBWUpDLE1BQUFBLFVBQVUsRUFBRTtBQVpSO0FBRkQsR0FBUDtBQWlCRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZvcm1hdCB9IGZyb20gJy4uL2Zvcm1hdHRlcidcbmltcG9ydCB7IGhhc2gsIG1ha2VJRE1ha2VyIH0gZnJvbSAnLi4vaWQnXG5cbmNvbnN0IGltcG9ydFJlZ0V4cCA9IC8oPzw9XnxcXG4pXFwvXFwvIEBpbXBvcnQgKC4rKVxcbj8oW1xcc1xcU10qPylcXG5cXC9cXC8gQEAoPz1cXG58JCkvXG5cbmNvbnN0IGRhdGFSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAKFteIFxcdFxcbl0rKVsgXFx0XSsoW14gXFxuXS4qKSg/OlxcbnwkKS9cbi8vICg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/IUZvbyBMaWIpKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG5cXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKVxuY29uc3QgbGliSGVhZCA9IFN0cmluZy5yYXdgXFwvXFwvXFwvIC0tLSAuKiB7e3sgXFwvXFwvXFwvXFxuYFxuY29uc3QgbWFrZUxpYnJhcnlSZWdFeHAgPSAoZXgsIGZsYWdzKSA9PiBuZXcgUmVnRXhwKFxuICBTdHJpbmcucmF3YCg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/JHtleH0pKC4rPykge3t7IFxcL1xcL1xcL1xcbig/ISR7bGliSGVhZH0pYCArXG4gIFN0cmluZy5yYXdgKD86W1xcc1xcU10oPyEke2xpYkhlYWR9KSkqP1xcbmAgK1xuICBTdHJpbmcucmF3YFxcMVxcL1xcL1xcLyB9fX0tLS0gXFwvXFwvXFwvKD89XFxufCQpYCxcbiAgZmxhZ3NcbilcblxuY29uc3QgbGliSGVhZFJlZ0V4cCA9IC8oPzpefFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICguKz8pIHt7eyBcXC9cXC9cXC9bXFxzXFxTXSo/XFxuKD86XFxufCQpL1xuY29uc3QgbGliRW5kUmVnRXhwID0gLyg/Ol58XFxuKVsgXFx0XSpcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/OlxcbnwkKS9cbmNvbnN0IG5ld1JlZ0V4cCA9IC9eXFwvXFwvIEBuZXcoPzpbIFxcdF0rKFteIFxcbl0uKikpPyg/OlxcbnwkKS9cbmNvbnN0IG5hbWVSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAWyBcXHRdKyhbXiBcXHRcXG5dLiopKD86XFxufCQpL1xuXG5jb25zdCBlbmNsb3NlID0gKG5hbWUsIGNvZGUpID0+IGAvLy8gLS0tICR7bmFtZX0ge3t7IC8vL1xcbiR7Y29kZX1cXG4vLy8gfX19LS0tIC8vL2BcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1ha2VMaWIgKG9sZCwgbmFtZXNwYWNlLCBmaWxlbmFtZSwgY29uZmlnKSB7XG4gIGNvbnN0IElETWFrZXIgPSBtYWtlSURNYWtlcigpXG4gIGxldCBjb2RlID0gb2xkIC8vIOOBhOOCj+OChuOCi3NuaXBwZXTnlKjjga7jgrPjg7zjg4lcbiAgY29kZSA9IGF3YWl0IGZvcm1hdChjb2RlLCBjb25maWcpXG5cbiAgLy8g44OH44O844K/5oq95Ye6XG4gIGxldCBkYXRhID0gKGNvZGUubWF0Y2gobmV3IFJlZ0V4cChkYXRhUmVnRXhwLCAnZycpKSB8fCBbXSlcbiAgICAubWFwKGVsID0+IEFycmF5LmZyb20oZWwubWF0Y2goZGF0YVJlZ0V4cCkpKSAvLyBbYWxsLCBuYW1lLCBkYXRhXVxuICAgIC5tYXAoZWwgPT4gKGVsLnNoaWZ0KCksIGVsKSkgLy8gW25hbWUsIGRhdGFdXG4gICAgLmZpbHRlcihlbCA9PiBlbFswXSAhPT0gJ2ltcG9ydCcpXG4gICAgLmZpbHRlcihlbCA9PiBlbFswXSAhPT0gJ25ldycpXG4gIGNvbnN0IG5hbWUgPSAoKCkgPT4ge1xuICAgIC8vIEBuZXcge25hbWV9XG4gICAgY29uc3QgbmV3RGF0YSA9IGNvZGUubWF0Y2gobmV3UmVnRXhwKVxuICAgIGlmIChuZXdEYXRhICYmIG5ld0RhdGFbMV0pIHJldHVybiBuZXdEYXRhWzFdXG4gICAgLy8gQCB7bmFtZX1cbiAgICBjb25zdCBuYW1lRGF0YSA9IGNvZGUubWF0Y2gobmFtZVJlZ0V4cClcbiAgICBpZiAobmFtZURhdGEpIHJldHVybiBuYW1lRGF0YVsxXVxuICAgIC8vIEBuYW1lIHtuYW1lfVxuICAgIGxldCBuYW1lID0gZGF0YS5maWx0ZXIoZWwgPT4gZWxbMF0gPT09ICduYW1lJylbMF1cbiAgICBpZiAoIW5hbWUpIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6IG5vIG5hbWVgXG4gICAgcmV0dXJuIG5hbWVbMV1cbiAgfSkoKVxuICBkYXRhID0gZGF0YS5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICduYW1lJylcbiAgLy9cblxuICAvLyDjg6njgqTjg5bjg6njg6rjgavplqLjgZfjgaZcbiAgY29uc3QgcmVxdWlyZW1lbnRzID0gKCgpID0+IHtcbiAgICBsZXQgX3JlcXVpcmVtZW50cyA9IFtdXG4gICAgY29uc3QgbGlicmFyeVJlZ0V4cCA9IG1ha2VMaWJyYXJ5UmVnRXhwKCchJyArIG5hbWUpXG4gICAgd2hpbGUgKGxpYnJhcnlSZWdFeHAudGVzdChjb2RlKSkge1xuICAgICAgY29uc3QgdG1wID0gKGNvZGVcbiAgICAgICAgLm1hdGNoKG5ldyBSZWdFeHAobGlicmFyeVJlZ0V4cCwgJ2cnKSkgfHwgW10pXG4gICAgICAgIC5tYXAoZWwgPT4gKHtcbiAgICAgICAgICBvbGQ6IGVsLCBuYW1lOiBlbC5tYXRjaChsaWJyYXJ5UmVnRXhwKVsyXSwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlXG4gICAgICAgIH0pKSAvLyB7b2xkLCBuYW1lLCBpZH1cbiAgICAgIF9yZXF1aXJlbWVudHMgPSBbLi4uX3JlcXVpcmVtZW50cywgLi4udG1wXVxuICAgICAgLy8g44Op44Kk44OW44Op44Oq44Gu572u44GN5o+b44GIXG4gICAgICB7XG4gICAgICAgIGxldCBpID0gMFxuICAgICAgICBjb2RlID0gY29kZS5yZXBsYWNlKFxuICAgICAgICAgIG5ldyBSZWdFeHAobGlicmFyeVJlZ0V4cCwgJ2cnKSxcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gaGFzaCh0bXBbaSsrXS5pZClcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIF9yZXF1aXJlbWVudHNcbiAgfSkoKVxuICAvL1xuICAvLyDjg6njgqTjg5bjg6njg6rjga7nva7jgY3mj5vjgYjjgpLjgZfjgZ/ot6Hjgavoqr/jgbnjgarjgYTjgajlo4rjgozjgotcbiAgY29uc3QgZW5jbG9zdXJlQ291bnQgPVxuICAgICAgKGNvZGUubWF0Y2gobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSwgJ2cnKSkgfHwgW10pLmxlbmd0aFxuICBpZiAoZW5jbG9zdXJlQ291bnQgPj0gMikgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBoYW5kbGUgMiBvciBtb3JlIGVuY2xvc3VyZXMgXCIvLy8gLS0tLi4uXCJgXG5cbiAgLy8gaW1wb3J0IOaKveWHulxuICBjb25zdCBpbXBvcnRzID0gKGNvZGVcbiAgICAubWF0Y2gobmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gQXJyYXkuZnJvbShlbC5tYXRjaChpbXBvcnRSZWdFeHApKSkgLy8gW2FsbCwgbmFtZSwgY29kZV1cbiAgICAubWFwKChbLCBuYW1lLCBvbGRdKSA9PiAoe25hbWUsIG9sZCwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlfSkpXG5cbiAgbGV0IHJlZmFjdG9yZWQgPSBjb2RlIC8vIOOBk+OBk+OBi+OCieWIhuWykFxuXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3UmVnRXhwLCAnJylcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuYW1lUmVnRXhwLCAnJylcblxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpLCAnJylcbiAgeyAvLyBpbXBvcnQg44Gu572u44GN5o+b44GIXG4gICAgbGV0IGkgPSAwXG4gICAgcmVmYWN0b3JlZCA9IHJlZmFjdG9yZWQucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpLFxuICAgICAgKCkgPT4gaGFzaChpbXBvcnRzW2krK10uaWQpXG4gICAgKVxuICB9XG5cbiAgLy8gZGF0YSDjga7nva7jgY3mj5vjgYhcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKGRhdGFSZWdFeHAsICdnJyksICcnKVxuICAvLyByZWZhY3RvcmVkIOOBi+OCieOBr+a2iOOBleOBquOBhFxuXG4gIC8vIOODqeOCpOODluODqeODquOBrue1guOCj+OCiuOBjOWNmOS9k+OBp+aui+OCi+OBqOW0qeOCjOOCi1xuICB7XG4gICAgY29uc3QgaG9sbG93ID0gY29kZS5yZXBsYWNlKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJyksICcnKVxuICAgIGlmIChsaWJFbmRSZWdFeHAudGVzdChob2xsb3cpKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGhvbGxvdylcbiAgICAgIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6ICR7bmFtZX0gOiBjYW5ub3QgaW5jbHVkZSB1bml0IGxpYiBFTkQgXCIvLy8gfX19LS0tIC8vL2BcbiAgICB9XG4gICAgLy8g44Gk44GE44Gn44GraGVhZOaui+OCiuOCguiqv+OBueOCi++8jlxuICAgIGlmIChsaWJIZWFkUmVnRXhwLnRlc3QoaG9sbG93KSkge1xuICAgICAgY29uc29sZS5lcnJvcihob2xsb3cpXG4gICAgICB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiAke25hbWV9IDogY2Fubm90IGluY2x1ZGUgdW5pdCBsaWIgSEVBRCBcIi8vLyAtLS0ge25hbWV9IH19fSAvLy9cImBcbiAgICB9XG4gIH1cblxuICBjb25zdCBlbmNsb3NlZCA9IGVuY2xvc3VyZUNvdW50ID8gY29kZS5tYXRjaChtYWtlTGlicmFyeVJlZ0V4cCgnPScgKyBuYW1lKSlbMF0gOiBlbmNsb3NlKG5hbWUsIGNvZGUpXG5cbiAgcmV0dXJuIHtcbiAgICBuYW1lLFxuICAgIGRhdGE6IHtcbiAgICAgIG5hbWUsXG4gICAgICBuYW1lc3BhY2UsXG4gICAgICBmaWxlbmFtZSxcbiAgICAgIGNvZGUsIC8vIOOCueODi+ODmuODg+ODiOeUqFxuICAgICAgcmVmYWN0b3JlZCwgLy8g44KC44Go44Gu44Kz44O844OJ572u44GN5o+b44GI55SoXG4gICAgICBlbmNsb3NlZCwgLy8g5LuW44GucmVmYWN0b3JlZOOBruOCguOBruOBq+Wfi+OCgei+vOOCgOeUqFxuICAgICAgZGF0YSxcbiAgICAgIG9sZCxcbiAgICAgIHJlcXVpcmU6IHJlcXVpcmVtZW50cyxcbiAgICAgIGltcG9ydDogaW1wb3J0cyxcbiAgICAgIGZpbmlzaGVkOiBmYWxzZSxcbiAgICAgIHByb2Nlc3Npbmc6IGZhbHNlXG4gICAgfVxuICB9XG59XG4iXX0=