"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @(.+?)[ \t]+([^ \n].*)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?!Foo Lib)(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|&)/;
const newRegExp = /^\/\/ @new(?:[ \t]+([^ \n].*))?(?:\n|$)/;
const nameRegExp = /^\/\/ @[ \t]+([^ \n].*)(?:\n|$)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  let data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    // @new {name}
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1]; // @ {name}

    const nameData = code.match(nameRegExp);
    if (nameData && nameData[1]) return nameData[1]; // @name {name}

    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  data = data.filter(el => el[0] !== 'name'); //
  // ライブラリに関して

  const libraryRegExp = makeLibraryRegExp('!' + name);
  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`;
  const requirements = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
    old: el,
    name: el.match(libraryRegExp)[2],
    id: IDMaker.next().value
  })); // {old, name}
  // ライブラリの置き換え

  {
    let i = 0;
    code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
      return (0, _id.hash)(requirements[i++].id);
    });
  } //
  // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(newRegExp, '');
  code = code.replace(nameRegExp, '');
  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  if (libEndRegExp.test(code.replace(makeLibraryRegExp('=' + name, 'g'), ''))) throw `${namespace} / ${filename} : ${name} : cannot include unit lib end`;
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      name,
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibWFrZUxpYnJhcnlSZWdFeHAiLCJleCIsImZsYWdzIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibGliRW5kUmVnRXhwIiwibmV3UmVnRXhwIiwibmFtZVJlZ0V4cCIsImVuY2xvc2UiLCJuYW1lIiwiY29kZSIsIm1ha2VMaWIiLCJvbGQiLCJuYW1lc3BhY2UiLCJmaWxlbmFtZSIsImNvbmZpZyIsIklETWFrZXIiLCJkYXRhIiwibWF0Y2giLCJtYXAiLCJlbCIsIkFycmF5IiwiZnJvbSIsInNoaWZ0IiwiZmlsdGVyIiwibmV3RGF0YSIsIm5hbWVEYXRhIiwibGlicmFyeVJlZ0V4cCIsImVuY2xvc3VyZUNvdW50IiwibGVuZ3RoIiwicmVxdWlyZW1lbnRzIiwiaWQiLCJuZXh0IiwidmFsdWUiLCJpIiwicmVwbGFjZSIsImltcG9ydHMiLCJyZWZhY3RvcmVkIiwidGVzdCIsImVuY2xvc2VkIiwicmVxdWlyZSIsImltcG9ydCIsImZpbmlzaGVkIiwicHJvY2Vzc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLDBEQUFyQjtBQUNBLE1BQU1DLFVBQVUsR0FBRyw4Q0FBbkIsQyxDQUNBOztBQUNBLE1BQU1DLGlCQUFpQixHQUFHLENBQUNDLEVBQUQsRUFBS0MsS0FBTCxLQUFlLElBQUlDLE1BQUosQ0FDdkNDLE1BQU0sQ0FBQ0MsR0FBSSxpQ0FBZ0NKLEVBQUcsMkRBRFAsRUFFdkNDLEtBRnVDLENBQXpDOztBQUlBLE1BQU1JLFlBQVksR0FBRyw0Q0FBckI7QUFDQSxNQUFNQyxTQUFTLEdBQUcseUNBQWxCO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLGlDQUFuQjs7QUFFQSxNQUFNQyxPQUFPLEdBQUcsQ0FBQ0MsSUFBRCxFQUFPQyxJQUFQLEtBQWlCLFdBQVVELElBQUssYUFBWUMsSUFB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QUVMLE9BVko7QUFXSk0sTUFBQUEsUUFBUSxFQUFFLEtBWE47QUFZSkMsTUFBQUEsVUFBVSxFQUFFO0FBWlI7QUFGRCxHQUFQO0FBaUJEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnLi4vZm9ybWF0dGVyJ1xuaW1wb3J0IHsgaGFzaCwgbWFrZUlETWFrZXIgfSBmcm9tICcuLi9pZCdcblxuY29uc3QgaW1wb3J0UmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQGltcG9ydCAoLispXFxuPyhbXFxzXFxTXSo/KVxcblxcL1xcLyBAQCg/PVxcbnwkKS9cbmNvbnN0IGRhdGFSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAKC4rPylbIFxcdF0rKFteIFxcbl0uKikoPzpcXG58JCkvXG4vLyAoPzw9XnxcXG4pKFsgXFx0XSopXFwvXFwvXFwvIC0tLSAoPyFGb28gTGliKSguKz8pIHt7eyBcXC9cXC9cXC9bXFxzXFxTXSo/XFxuXFwxXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPz1cXG58JClcbmNvbnN0IG1ha2VMaWJyYXJ5UmVnRXhwID0gKGV4LCBmbGFncykgPT4gbmV3IFJlZ0V4cChcbiAgU3RyaW5nLnJhd2AoPzw9XnxcXG4pKFsgXFx0XSopXFwvXFwvXFwvIC0tLSAoPyR7ZXh9KSguKz8pIHt7eyBcXC9cXC9cXC9bXFxzXFxTXSo/XFxuXFwxXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPz1cXG58JClgLFxuICBmbGFnc1xuKVxuY29uc3QgbGliRW5kUmVnRXhwID0gLyg/Ol58XFxuKVsgXFx0XSpcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/OlxcbnwmKS9cbmNvbnN0IG5ld1JlZ0V4cCA9IC9eXFwvXFwvIEBuZXcoPzpbIFxcdF0rKFteIFxcbl0uKikpPyg/OlxcbnwkKS9cbmNvbnN0IG5hbWVSZWdFeHAgPSAvXlxcL1xcLyBAWyBcXHRdKyhbXiBcXG5dLiopKD86XFxufCQpL1xuXG5jb25zdCBlbmNsb3NlID0gKG5hbWUsIGNvZGUpID0+IGAvLy8gLS0tICR7bmFtZX0ge3t7IC8vL1xcbiR7Y29kZX1cXG4vLy8gfX19LS0tIC8vL2BcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1ha2VMaWIgKG9sZCwgbmFtZXNwYWNlLCBmaWxlbmFtZSwgY29uZmlnKSB7XG4gIGNvbnN0IElETWFrZXIgPSBtYWtlSURNYWtlcigpXG4gIGxldCBjb2RlID0gb2xkIC8vIOOBhOOCj+OChuOCi3NuaXBwZXTnlKjjga7jgrPjg7zjg4lcbiAgY29kZSA9IGF3YWl0IGZvcm1hdChjb2RlLCBjb25maWcpXG5cbiAgLy8g44OH44O844K/5oq95Ye6XG4gIGxldCBkYXRhID0gKGNvZGUubWF0Y2gobmV3IFJlZ0V4cChkYXRhUmVnRXhwLCAnZycpKSB8fCBbXSlcbiAgICAubWFwKGVsID0+IEFycmF5LmZyb20oZWwubWF0Y2goZGF0YVJlZ0V4cCkpKSAvLyBbYWxsLCBuYW1lLCBkYXRhXVxuICAgIC5tYXAoZWwgPT4gKGVsLnNoaWZ0KCksIGVsKSkgLy8gW25hbWUsIGRhdGFdXG4gICAgLmZpbHRlcihlbCA9PiBlbFswXSAhPT0gJ2ltcG9ydCcpXG4gICAgLmZpbHRlcihlbCA9PiBlbFswXSAhPT0gJ25ldycpXG4gIGNvbnN0IG5hbWUgPSAoKCkgPT4ge1xuICAgIC8vIEBuZXcge25hbWV9XG4gICAgY29uc3QgbmV3RGF0YSA9IGNvZGUubWF0Y2gobmV3UmVnRXhwKVxuICAgIGlmIChuZXdEYXRhICYmIG5ld0RhdGFbMV0pIHJldHVybiBuZXdEYXRhWzFdXG4gICAgLy8gQCB7bmFtZX1cbiAgICBjb25zdCBuYW1lRGF0YSA9IGNvZGUubWF0Y2gobmFtZVJlZ0V4cClcbiAgICBpZiAobmFtZURhdGEgJiYgbmFtZURhdGFbMV0pIHJldHVybiBuYW1lRGF0YVsxXVxuICAgIC8vIEBuYW1lIHtuYW1lfVxuICAgIGxldCBuYW1lID0gZGF0YS5maWx0ZXIoZWwgPT4gZWxbMF0gPT09ICduYW1lJylbMF1cbiAgICBpZiAoIW5hbWUpIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6IG5vIG5hbWVgXG4gICAgcmV0dXJuIG5hbWVbMV1cbiAgfSkoKVxuICBkYXRhID0gZGF0YS5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICduYW1lJylcbiAgLy9cblxuICAvLyDjg6njgqTjg5bjg6njg6rjgavplqLjgZfjgaZcbiAgY29uc3QgbGlicmFyeVJlZ0V4cCA9IG1ha2VMaWJyYXJ5UmVnRXhwKCchJyArIG5hbWUpXG4gIGNvbnN0IGVuY2xvc3VyZUNvdW50ID1cbiAgICAgIChjb2RlLm1hdGNoKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJykpIHx8IFtdKS5sZW5ndGhcbiAgaWYgKGVuY2xvc3VyZUNvdW50ID49IDIpIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6ICR7bmFtZX0gOiBjYW5ub3QgaGFuZGxlIDIgb3IgbW9yZSBlbmNsb3N1cmVzIFwiLy8vIC0tLS4uLlwiYFxuICBjb25zdCByZXF1aXJlbWVudHMgPSAoY29kZVxuICAgIC5tYXRjaChuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gKHtcbiAgICAgIG9sZDogZWwsIG5hbWU6IGVsLm1hdGNoKGxpYnJhcnlSZWdFeHApWzJdLCBpZDogSURNYWtlci5uZXh0KCkudmFsdWVcbiAgICB9KSkgLy8ge29sZCwgbmFtZX1cbiAgICAvLyDjg6njgqTjg5bjg6njg6rjga7nva7jgY3mj5vjgYhcbiAge1xuICAgIGxldCBpID0gMFxuICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UoXG4gICAgICBuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJyksXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHJldHVybiBoYXNoKHJlcXVpcmVtZW50c1tpKytdLmlkKVxuICAgICAgfVxuICAgIClcbiAgfVxuICAvL1xuXG4gIC8vIGltcG9ydCDmir3lh7pcbiAgY29uc3QgaW1wb3J0cyA9IChjb2RlXG4gICAgLm1hdGNoKG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpKSB8fCBbXSlcbiAgICAubWFwKGVsID0+IEFycmF5LmZyb20oZWwubWF0Y2goaW1wb3J0UmVnRXhwKSkpIC8vIFthbGwsIG5hbWUsIGNvZGVdXG4gICAgLm1hcCgoWywgbmFtZSwgb2xkXSkgPT4gKHtuYW1lLCBvbGQsIGlkOiBJRE1ha2VyLm5leHQoKS52YWx1ZX0pKVxuXG4gIGxldCByZWZhY3RvcmVkID0gY29kZSAvLyDjgZPjgZPjgYvjgonliIblspBcblxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ld1JlZ0V4cCwgJycpXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmFtZVJlZ0V4cCwgJycpXG5cbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSwgJycpXG4gIHsgLy8gaW1wb3J0IOOBrue9ruOBjeaPm+OBiFxuICAgIGxldCBpID0gMFxuICAgIHJlZmFjdG9yZWQgPSByZWZhY3RvcmVkLnJlcGxhY2UoXG4gICAgICBuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSxcbiAgICAgICgpID0+IGhhc2goaW1wb3J0c1tpKytdLmlkKVxuICAgIClcbiAgfVxuXG4gIC8vIGRhdGEg44Gu572u44GN5o+b44GIXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChkYXRhUmVnRXhwLCAnZycpLCAnJylcbiAgLy8gcmVmYWN0b3JlZCDjgYvjgonjga/mtojjgZXjgarjgYRcblxuICAvLyDjg6njgqTjg5bjg6njg6rjga7ntYLjgo/jgorjgYzljZjkvZPjgafmrovjgovjgajltKnjgozjgotcbiAgaWYgKGxpYkVuZFJlZ0V4cC50ZXN0KFxuICAgIGNvZGUucmVwbGFjZShtYWtlTGlicmFyeVJlZ0V4cCgnPScgKyBuYW1lLCAnZycpLCAnJylcbiAgKSkgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBpbmNsdWRlIHVuaXQgbGliIGVuZGBcblxuICBjb25zdCBlbmNsb3NlZCA9IGVuY2xvc3VyZUNvdW50ID8gY29kZS5tYXRjaChtYWtlTGlicmFyeVJlZ0V4cCgnPScgKyBuYW1lKSlbMF0gOiBlbmNsb3NlKG5hbWUsIGNvZGUpXG5cbiAgcmV0dXJuIHtcbiAgICBuYW1lLFxuICAgIGRhdGE6IHtcbiAgICAgIG5hbWUsXG4gICAgICBuYW1lc3BhY2UsXG4gICAgICBmaWxlbmFtZSxcbiAgICAgIGNvZGUsIC8vIOOCueODi+ODmuODg+ODiOeUqFxuICAgICAgcmVmYWN0b3JlZCwgLy8g44KC44Go44Gu44Kz44O844OJ572u44GN5o+b44GI55SoXG4gICAgICBlbmNsb3NlZCwgLy8g5LuW44GucmVmYWN0b3JlZOOBruOCguOBruOBq+Wfi+OCgei+vOOCgOeUqFxuICAgICAgZGF0YSxcbiAgICAgIG9sZCxcbiAgICAgIHJlcXVpcmU6IHJlcXVpcmVtZW50cyxcbiAgICAgIGltcG9ydDogaW1wb3J0cyxcbiAgICAgIGZpbmlzaGVkOiBmYWxzZSxcbiAgICAgIHByb2Nlc3Npbmc6IGZhbHNlXG4gICAgfVxuICB9XG59XG4iXX0=