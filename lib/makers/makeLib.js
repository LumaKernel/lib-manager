"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @([^ \t\n]+)[ \t]+([^ \n].*)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?!Foo Lib)(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libHeadRegExp = /(?:^|\n)([ \t]*)\/\/\/ --- (.+?) {{{ \/\/\/[\s\S]*?\n(?:\n|$)/;
const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|$)/;
const newRegExp = /^\/\/ @new(?:[ \t]+([^ \n].*))?(?:\n|$)/;
const nameRegExp = /(?<=^|\n)\/\/ @[ \t]+([^ \t\n].*)(?:\n|$)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  let data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    // @new {name}
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1]; // @ {name}

    const nameData = code.match(nameRegExp);
    if (nameData) return nameData[1]; // @name {name}

    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  data = data.filter(el => el[0] !== 'name'); //
  // ライブラリに関して

  const libraryRegExp = makeLibraryRegExp('!' + name);
  const requirements = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
    old: el,
    name: el.match(libraryRegExp)[2],
    id: IDMaker.next().value
  })); // {old, name}
  // ライブラリの置き換え

  {
    let i = 0;
    code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
      return (0, _id.hash)(requirements[i++].id);
    });
  } //
  // ライブラリの置き換えをした跡に調べないと壊れる

  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`; // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(newRegExp, '');
  code = code.replace(nameRegExp, '');
  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  {
    const hollow = code.replace(makeLibraryRegExp('=' + name, 'g'), '');
    if (libEndRegExp.test(hollow)) throw `${namespace} / ${filename} : ${name} : cannot include unit lib END "/// }}}--- ///`; // ついでにhead残りも調べる．

    if (libHeadRegExp.test(hollow)) throw `${namespace} / ${filename} : ${name} : cannot include unit lib HEAD "/// --- {name} }}} ///"`;
  }
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      name,
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibWFrZUxpYnJhcnlSZWdFeHAiLCJleCIsImZsYWdzIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibGliSGVhZFJlZ0V4cCIsImxpYkVuZFJlZ0V4cCIsIm5ld1JlZ0V4cCIsIm5hbWVSZWdFeHAiLCJlbmNsb3NlIiwibmFtZSIsImNvZGUiLCJtYWtlTGliIiwib2xkIiwibmFtZXNwYWNlIiwiZmlsZW5hbWUiLCJjb25maWciLCJJRE1ha2VyIiwiZGF0YSIsIm1hdGNoIiwibWFwIiwiZWwiLCJBcnJheSIsImZyb20iLCJzaGlmdCIsImZpbHRlciIsIm5ld0RhdGEiLCJuYW1lRGF0YSIsImxpYnJhcnlSZWdFeHAiLCJyZXF1aXJlbWVudHMiLCJpZCIsIm5leHQiLCJ2YWx1ZSIsImkiLCJyZXBsYWNlIiwiZW5jbG9zdXJlQ291bnQiLCJsZW5ndGgiLCJpbXBvcnRzIiwicmVmYWN0b3JlZCIsImhvbGxvdyIsInRlc3QiLCJlbmNsb3NlZCIsInJlcXVpcmUiLCJpbXBvcnQiLCJmaW5pc2hlZCIsInByb2Nlc3NpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBLE1BQU1BLFlBQVksR0FBRywwREFBckI7QUFFQSxNQUFNQyxVQUFVLEdBQUcsb0RBQW5CLEMsQ0FDQTs7QUFDQSxNQUFNQyxpQkFBaUIsR0FBRyxDQUFDQyxFQUFELEVBQUtDLEtBQUwsS0FBZSxJQUFJQyxNQUFKLENBQ3ZDQyxNQUFNLENBQUNDLEdBQUksaUNBQWdDSixFQUFHLDJEQURQLEVBRXZDQyxLQUZ1QyxDQUF6Qzs7QUFLQSxNQUFNSSxhQUFhLEdBQUcsK0RBQXRCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLDRDQUFyQjtBQUNBLE1BQU1DLFNBQVMsR0FBRyx5Q0FBbEI7QUFDQSxNQUFNQyxVQUFVLEdBQUcsMkNBQW5COztBQUVBLE1BQU1DLE9BQU8s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QSxJQURJO0FBRUpJLE1BQUFBLFNBRkk7QUFHSkMsTUFBQUEsUUFISTtBQUlKSixNQUFBQSxJQUpJO0FBSUU7QUFDTjJCLE1BQUFBLFVBTEk7QUFLUTtBQUNaRyxNQUFBQSxRQU5JO0FBTU07QUFDVnZCLE1BQUFBLElBUEk7QUFRSkwsTUFBQUEsR0FSSTtBQVNKNkIsTUFBQUEsT0FBTyxFQUFFYixZQVRMO0FBVUpjLE1BQUFBLE1BQU0sRUFBRU4sT0FWSjtBQVdKTyxNQUFBQSxRQUFRLEVBQUUsS0FYTjtBQVlKQyxNQUFBQSxVQUFVLEVBQUU7QUFaUjtBQUZELEdBQVA7QUFpQkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmb3JtYXQgfSBmcm9tICcuLi9mb3JtYXR0ZXInXG5pbXBvcnQgeyBoYXNoLCBtYWtlSURNYWtlciB9IGZyb20gJy4uL2lkJ1xuXG5jb25zdCBpbXBvcnRSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAaW1wb3J0ICguKylcXG4/KFtcXHNcXFNdKj8pXFxuXFwvXFwvIEBAKD89XFxufCQpL1xuXG5jb25zdCBkYXRhUmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQChbXiBcXHRcXG5dKylbIFxcdF0rKFteIFxcbl0uKikoPzpcXG58JCkvXG4vLyAoPzw9XnxcXG4pKFsgXFx0XSopXFwvXFwvXFwvIC0tLSAoPyFGb28gTGliKSguKz8pIHt7eyBcXC9cXC9cXC9bXFxzXFxTXSo/XFxuXFwxXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPz1cXG58JClcbmNvbnN0IG1ha2VMaWJyYXJ5UmVnRXhwID0gKGV4LCBmbGFncykgPT4gbmV3IFJlZ0V4cChcbiAgU3RyaW5nLnJhd2AoPzw9XnxcXG4pKFsgXFx0XSopXFwvXFwvXFwvIC0tLSAoPyR7ZXh9KSguKz8pIHt7eyBcXC9cXC9cXC9bXFxzXFxTXSo/XFxuXFwxXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPz1cXG58JClgLFxuICBmbGFnc1xuKVxuXG5jb25zdCBsaWJIZWFkUmVnRXhwID0gLyg/Ol58XFxuKShbIFxcdF0qKVxcL1xcL1xcLyAtLS0gKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG4oPzpcXG58JCkvXG5jb25zdCBsaWJFbmRSZWdFeHAgPSAvKD86XnxcXG4pWyBcXHRdKlxcL1xcL1xcLyB9fX0tLS0gXFwvXFwvXFwvKD86XFxufCQpL1xuY29uc3QgbmV3UmVnRXhwID0gL15cXC9cXC8gQG5ldyg/OlsgXFx0XSsoW14gXFxuXS4qKSk/KD86XFxufCQpL1xuY29uc3QgbmFtZVJlZ0V4cCA9IC8oPzw9XnxcXG4pXFwvXFwvIEBbIFxcdF0rKFteIFxcdFxcbl0uKikoPzpcXG58JCkvXG5cbmNvbnN0IGVuY2xvc2UgPSAobmFtZSwgY29kZSkgPT4gYC8vLyAtLS0gJHtuYW1lfSB7e3sgLy8vXFxuJHtjb2RlfVxcbi8vLyB9fX0tLS0gLy8vYFxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWFrZUxpYiAob2xkLCBuYW1lc3BhY2UsIGZpbGVuYW1lLCBjb25maWcpIHtcbiAgY29uc3QgSURNYWtlciA9IG1ha2VJRE1ha2VyKClcbiAgbGV0IGNvZGUgPSBvbGQgLy8g44GE44KP44KG44KLc25pcHBldOeUqOOBruOCs+ODvOODiVxuICBjb2RlID0gYXdhaXQgZm9ybWF0KGNvZGUsIGNvbmZpZylcblxuICAvLyDjg4fjg7zjgr/mir3lh7pcbiAgbGV0IGRhdGEgPSAoY29kZS5tYXRjaChuZXcgUmVnRXhwKGRhdGFSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gQXJyYXkuZnJvbShlbC5tYXRjaChkYXRhUmVnRXhwKSkpIC8vIFthbGwsIG5hbWUsIGRhdGFdXG4gICAgLm1hcChlbCA9PiAoZWwuc2hpZnQoKSwgZWwpKSAvLyBbbmFtZSwgZGF0YV1cbiAgICAuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnaW1wb3J0JylcbiAgICAuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnbmV3JylcbiAgY29uc3QgbmFtZSA9ICgoKSA9PiB7XG4gICAgLy8gQG5ldyB7bmFtZX1cbiAgICBjb25zdCBuZXdEYXRhID0gY29kZS5tYXRjaChuZXdSZWdFeHApXG4gICAgaWYgKG5ld0RhdGEgJiYgbmV3RGF0YVsxXSkgcmV0dXJuIG5ld0RhdGFbMV1cbiAgICAvLyBAIHtuYW1lfVxuICAgIGNvbnN0IG5hbWVEYXRhID0gY29kZS5tYXRjaChuYW1lUmVnRXhwKVxuICAgIGlmIChuYW1lRGF0YSkgcmV0dXJuIG5hbWVEYXRhWzFdXG4gICAgLy8gQG5hbWUge25hbWV9XG4gICAgbGV0IG5hbWUgPSBkYXRhLmZpbHRlcihlbCA9PiBlbFswXSA9PT0gJ25hbWUnKVswXVxuICAgIGlmICghbmFtZSkgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogbm8gbmFtZWBcbiAgICByZXR1cm4gbmFtZVsxXVxuICB9KSgpXG4gIGRhdGEgPSBkYXRhLmZpbHRlcihlbCA9PiBlbFswXSAhPT0gJ25hbWUnKVxuICAvL1xuXG4gIC8vIOODqeOCpOODluODqeODquOBq+mWouOBl+OBplxuICBjb25zdCBsaWJyYXJ5UmVnRXhwID0gbWFrZUxpYnJhcnlSZWdFeHAoJyEnICsgbmFtZSlcbiAgY29uc3QgcmVxdWlyZW1lbnRzID0gKGNvZGVcbiAgICAubWF0Y2gobmV3IFJlZ0V4cChsaWJyYXJ5UmVnRXhwLCAnZycpKSB8fCBbXSlcbiAgICAubWFwKGVsID0+ICh7XG4gICAgICBvbGQ6IGVsLCBuYW1lOiBlbC5tYXRjaChsaWJyYXJ5UmVnRXhwKVsyXSwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlXG4gICAgfSkpIC8vIHtvbGQsIG5hbWV9XG4gICAgLy8g44Op44Kk44OW44Op44Oq44Gu572u44GN5o+b44GIXG4gIHtcbiAgICBsZXQgaSA9IDBcbiAgICBjb2RlID0gY29kZS5yZXBsYWNlKFxuICAgICAgbmV3IFJlZ0V4cChsaWJyYXJ5UmVnRXhwLCAnZycpLFxuICAgICAgKCkgPT4ge1xuICAgICAgICByZXR1cm4gaGFzaChyZXF1aXJlbWVudHNbaSsrXS5pZClcbiAgICAgIH1cbiAgICApXG4gIH1cbiAgLy9cbiAgLy8g44Op44Kk44OW44Op44Oq44Gu572u44GN5o+b44GI44KS44GX44Gf6Leh44Gr6Kq/44G544Gq44GE44Go5aOK44KM44KLXG4gIGNvbnN0IGVuY2xvc3VyZUNvdW50ID1cbiAgICAgIChjb2RlLm1hdGNoKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJykpIHx8IFtdKS5sZW5ndGhcbiAgaWYgKGVuY2xvc3VyZUNvdW50ID49IDIpIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6ICR7bmFtZX0gOiBjYW5ub3QgaGFuZGxlIDIgb3IgbW9yZSBlbmNsb3N1cmVzIFwiLy8vIC0tLS4uLlwiYFxuXG4gIC8vIGltcG9ydCDmir3lh7pcbiAgY29uc3QgaW1wb3J0cyA9IChjb2RlXG4gICAgLm1hdGNoKG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpKSB8fCBbXSlcbiAgICAubWFwKGVsID0+IEFycmF5LmZyb20oZWwubWF0Y2goaW1wb3J0UmVnRXhwKSkpIC8vIFthbGwsIG5hbWUsIGNvZGVdXG4gICAgLm1hcCgoWywgbmFtZSwgb2xkXSkgPT4gKHtuYW1lLCBvbGQsIGlkOiBJRE1ha2VyLm5leHQoKS52YWx1ZX0pKVxuXG4gIGxldCByZWZhY3RvcmVkID0gY29kZSAvLyDjgZPjgZPjgYvjgonliIblspBcblxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ld1JlZ0V4cCwgJycpXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmFtZVJlZ0V4cCwgJycpXG5cbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSwgJycpXG4gIHsgLy8gaW1wb3J0IOOBrue9ruOBjeaPm+OBiFxuICAgIGxldCBpID0gMFxuICAgIHJlZmFjdG9yZWQgPSByZWZhY3RvcmVkLnJlcGxhY2UoXG4gICAgICBuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSxcbiAgICAgICgpID0+IGhhc2goaW1wb3J0c1tpKytdLmlkKVxuICAgIClcbiAgfVxuXG4gIC8vIGRhdGEg44Gu572u44GN5o+b44GIXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChkYXRhUmVnRXhwLCAnZycpLCAnJylcbiAgLy8gcmVmYWN0b3JlZCDjgYvjgonjga/mtojjgZXjgarjgYRcblxuICAvLyDjg6njgqTjg5bjg6njg6rjga7ntYLjgo/jgorjgYzljZjkvZPjgafmrovjgovjgajltKnjgozjgotcbiAge1xuICAgIGNvbnN0IGhvbGxvdyA9IGNvZGUucmVwbGFjZShtYWtlTGlicmFyeVJlZ0V4cCgnPScgKyBuYW1lLCAnZycpLCAnJylcbiAgICBpZiAobGliRW5kUmVnRXhwLnRlc3QoaG9sbG93KSkgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBpbmNsdWRlIHVuaXQgbGliIEVORCBcIi8vLyB9fX0tLS0gLy8vYFxuICAgIC8vIOOBpOOBhOOBp+OBq2hlYWTmrovjgorjgoLoqr/jgbnjgovvvI5cbiAgICBpZiAobGliSGVhZFJlZ0V4cC50ZXN0KGhvbGxvdykpIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6ICR7bmFtZX0gOiBjYW5ub3QgaW5jbHVkZSB1bml0IGxpYiBIRUFEIFwiLy8vIC0tLSB7bmFtZX0gfX19IC8vL1wiYFxuICB9XG5cbiAgY29uc3QgZW5jbG9zZWQgPSBlbmNsb3N1cmVDb3VudCA/IGNvZGUubWF0Y2gobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSkpWzBdIDogZW5jbG9zZShuYW1lLCBjb2RlKVxuXG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBkYXRhOiB7XG4gICAgICBuYW1lLFxuICAgICAgbmFtZXNwYWNlLFxuICAgICAgZmlsZW5hbWUsXG4gICAgICBjb2RlLCAvLyDjgrnjg4vjg5rjg4Pjg4jnlKhcbiAgICAgIHJlZmFjdG9yZWQsIC8vIOOCguOBqOOBruOCs+ODvOODiee9ruOBjeaPm+OBiOeUqFxuICAgICAgZW5jbG9zZWQsIC8vIOS7luOBrnJlZmFjdG9yZWTjga7jgoLjga7jgavln4vjgoHovrzjgoDnlKhcbiAgICAgIGRhdGEsXG4gICAgICBvbGQsXG4gICAgICByZXF1aXJlOiByZXF1aXJlbWVudHMsXG4gICAgICBpbXBvcnQ6IGltcG9ydHMsXG4gICAgICBmaW5pc2hlZDogZmFsc2UsXG4gICAgICBwcm9jZXNzaW5nOiBmYWxzZVxuICAgIH1cbiAgfVxufVxuIl19