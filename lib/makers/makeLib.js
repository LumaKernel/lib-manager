"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @(.+?) (.+)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?!Foo Lib)(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|&)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  const data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => el.match(dataRegExp)) // [all, name, data]
  .map(el => (el.shift(), Array.from(el))) // [name, data]
  .filter(el => el[0] !== 'import');
  let name = data.filter(el => el[0] === 'name')[0];
  if (!name) throw `${namespace || '.'}/${filename} : no name`;
  name = name[1]; //
  // ライブラリに関して

  const libraryRegExp = makeLibraryRegExp('!' + name);
  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${name} : cannot handle 2 or more encsolures "/// ---..."`;
  const requirements = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
    old: el,
    name: el.match(libraryRegExp)[2],
    id: IDMaker.next().value
  })); // {old, name}
  // ライブラリの置き換え

  {
    let i = 0;
    code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
      return (0, _id.hash)(requirements[i++].id);
    });
  } //
  // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(el => ({
    name: el[1],
    old: el[2],
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  if (libEndRegExp.test(code.replace(makeLibraryRegExp('=' + name, 'g'), ''))) throw `${name} : cannot include unit lib end`;

  if (enclosureCount === 0) {
    code = enclose(name, code);
    refactored = enclose(name, refactored);
  }

  const enclosed = code.match(makeLibraryRegExp('=' + name))[0];
  return {
    name,
    data: {
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibWFrZUxpYnJhcnlSZWdFeHAiLCJleCIsImZsYWdzIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibGliRW5kUmVnRXhwIiwiZW5jbG9zZSIsIm5hbWUiLCJjb2RlIiwibWFrZUxpYiIsIm9sZCIsIm5hbWVzcGFjZSIsImZpbGVuYW1lIiwiY29uZmlnIiwiSURNYWtlciIsImRhdGEiLCJtYXRjaCIsIm1hcCIsImVsIiwic2hpZnQiLCJBcnJheSIsImZyb20iLCJmaWx0ZXIiLCJsaWJyYXJ5UmVnRXhwIiwiZW5jbG9zdXJlQ291bnQiLCJsZW5ndGgiLCJyZXF1aXJlbWVudHMiLCJpZCIsIm5leHQiLCJ2YWx1ZSIsImkiLCJyZXBsYWNlIiwiaW1wb3J0cyIsInJlZmFjdG9yZWQiLCJ0ZXN0IiwiZW5jbG9zZWQiLCJyZXF1aXJlIiwiaW1wb3J0IiwiZmluaXNoZWQiLCJwcm9jZXNzaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQSxNQUFNQSxZQUFZLEdBQUcsMERBQXJCO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLG1DQUFuQixDLENBQ0E7O0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsQ0FBQ0MsRUFBRCxFQUFLQyxLQUFMLEtBQWUsSUFBSUMsTUFBSixDQUN2Q0MsTUFBTSxDQUFDQyxHQUFJLGlDQUFnQ0osRUFBRywyREFEUCxFQUV2Q0MsS0FGdUMsQ0FBekM7O0FBSUEsTUFBTUksWUFBWSxHQUFHLDRDQUFyQjs7QUFFQSxNQUFNQyxPQUFPLEdBQUcsQ0FBQ0MsSUFBRCxFQUFPQyxJQUFQLEtBQWlCLFdBQVVELElBQUssYUFBWUMsSUFBSyxrQkFBakU7O0FBRU8sZUFBZUMsT0FBZixDQUF3QkMsR0FBeEIsRUFBNkJDLFNBQTdCLEVBQXdDQyxRQUF4QyxFQUFrREMsTUFBbEQsRUFBMEQ7QUFDL0QsUUFBTUMsT0FBTyxH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LEVBQTBDLENBQTFDLENBQWpCO0FBRUEsU0FBTztBQUNMQSxJQUFBQSxJQURLO0FBRUxRLElBQUFBLElBQUksRUFBRTtBQUNKSixNQUFBQSxTQURJO0FBRUpDLE1BQUFBLFFBRkk7QUFHSkosTUFBQUEsSUFISTtBQUdFO0FBQ055QixNQUFBQSxVQUpJO0FBSVE7QUFDWkUsTUFBQUEsUUFMSTtBQUtNO0FBQ1ZwQixNQUFBQSxJQU5JO0FBT0pMLE1BQUFBLEdBUEk7QUFRSjBCLE1BQUFBLE9BQU8sRUFBRVYsWUFSTDtBQVNKVyxNQUFBQSxNQUFNLEVBQUVMLE9BVEo7QUFVSk0sTUFBQUEsUUFBUSxFQUFFLEtBVk47QUFXSkMsTUFBQUEsVUFBVSxFQUFFO0FBWFI7QUFGRCxHQUFQO0FBZ0JEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnLi4vZm9ybWF0dGVyJ1xuaW1wb3J0IHsgaGFzaCwgbWFrZUlETWFrZXIgfSBmcm9tICcuLi9pZCdcblxuY29uc3QgaW1wb3J0UmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQGltcG9ydCAoLispXFxuPyhbXFxzXFxTXSo/KVxcblxcL1xcLyBAQCg/PVxcbnwkKS9cbmNvbnN0IGRhdGFSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAKC4rPykgKC4rKSg/OlxcbnwkKS9cbi8vICg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/IUZvbyBMaWIpKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG5cXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKVxuY29uc3QgbWFrZUxpYnJhcnlSZWdFeHAgPSAoZXgsIGZsYWdzKSA9PiBuZXcgUmVnRXhwKFxuICBTdHJpbmcucmF3YCg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/JHtleH0pKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG5cXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKWAsXG4gIGZsYWdzXG4pXG5jb25zdCBsaWJFbmRSZWdFeHAgPSAvKD86XnxcXG4pWyBcXHRdKlxcL1xcL1xcLyB9fX0tLS0gXFwvXFwvXFwvKD86XFxufCYpL1xuXG5jb25zdCBlbmNsb3NlID0gKG5hbWUsIGNvZGUpID0+IGAvLy8gLS0tICR7bmFtZX0ge3t7IC8vL1xcbiR7Y29kZX1cXG4vLy8gfX19LS0tIC8vL2BcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1ha2VMaWIgKG9sZCwgbmFtZXNwYWNlLCBmaWxlbmFtZSwgY29uZmlnKSB7XG4gIGNvbnN0IElETWFrZXIgPSBtYWtlSURNYWtlcigpXG4gIGxldCBjb2RlID0gb2xkIC8vIOOBhOOCj+OChuOCi3NuaXBwZXTnlKjjga7jgrPjg7zjg4lcbiAgY29kZSA9IGF3YWl0IGZvcm1hdChjb2RlLCBjb25maWcpXG5cbiAgLy8g44OH44O844K/5oq95Ye6XG4gIGNvbnN0IGRhdGEgPSAoY29kZVxuICAgIC5tYXRjaChuZXcgUmVnRXhwKGRhdGFSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gZWwubWF0Y2goZGF0YVJlZ0V4cCkpIC8vIFthbGwsIG5hbWUsIGRhdGFdXG4gICAgLm1hcChlbCA9PiAoZWwuc2hpZnQoKSwgQXJyYXkuZnJvbShlbCkpKSAvLyBbbmFtZSwgZGF0YV1cbiAgICAuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnaW1wb3J0JylcbiAgbGV0IG5hbWUgPSBkYXRhLmZpbHRlcihlbCA9PiBlbFswXSA9PT0gJ25hbWUnKVswXVxuICBpZiAoIW5hbWUpIHRocm93IGAke25hbWVzcGFjZSB8fCAnLid9LyR7ZmlsZW5hbWV9IDogbm8gbmFtZWBcbiAgbmFtZSA9IG5hbWVbMV1cbiAgLy9cblxuICAvLyDjg6njgqTjg5bjg6njg6rjgavplqLjgZfjgaZcbiAgY29uc3QgbGlicmFyeVJlZ0V4cCA9IG1ha2VMaWJyYXJ5UmVnRXhwKCchJyArIG5hbWUpXG4gIGNvbnN0IGVuY2xvc3VyZUNvdW50ID1cbiAgICAgIChjb2RlLm1hdGNoKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJykpIHx8IFtdKS5sZW5ndGhcbiAgaWYgKGVuY2xvc3VyZUNvdW50ID49IDIpIHRocm93IGAke25hbWV9IDogY2Fubm90IGhhbmRsZSAyIG9yIG1vcmUgZW5jc29sdXJlcyBcIi8vLyAtLS0uLi5cImBcbiAgY29uc3QgcmVxdWlyZW1lbnRzID0gKGNvZGVcbiAgICAubWF0Y2gobmV3IFJlZ0V4cChsaWJyYXJ5UmVnRXhwLCAnZycpKSB8fCBbXSlcbiAgICAubWFwKGVsID0+ICh7XG4gICAgICBvbGQ6IGVsLCBuYW1lOiBlbC5tYXRjaChsaWJyYXJ5UmVnRXhwKVsyXSwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlXG4gICAgfSkpIC8vIHtvbGQsIG5hbWV9XG4gICAgLy8g44Op44Kk44OW44Op44Oq44Gu572u44GN5o+b44GIXG4gIHtcbiAgICBsZXQgaSA9IDBcbiAgICBjb2RlID0gY29kZS5yZXBsYWNlKFxuICAgICAgbmV3IFJlZ0V4cChsaWJyYXJ5UmVnRXhwLCAnZycpLFxuICAgICAgKCkgPT4ge1xuICAgICAgICByZXR1cm4gaGFzaChyZXF1aXJlbWVudHNbaSsrXS5pZClcbiAgICAgIH1cbiAgICApXG4gIH1cbiAgLy9cblxuICAvLyBpbXBvcnQg5oq95Ye6XG4gIGNvbnN0IGltcG9ydHMgPSAoY29kZVxuICAgIC5tYXRjaChuZXcgUmVnRXhwKGltcG9ydFJlZ0V4cCwgJ2cnKSkgfHwgW10pXG4gICAgLm1hcChlbCA9PiBBcnJheS5mcm9tKGVsLm1hdGNoKGltcG9ydFJlZ0V4cCkpKSAvLyBbYWxsLCBuYW1lLCBjb2RlXVxuICAgIC5tYXAoZWwgPT4gKHtuYW1lOiBlbFsxXSwgb2xkOiBlbFsyXSwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlfSkpXG5cbiAgbGV0IHJlZmFjdG9yZWQgPSBjb2RlIC8vIOOBk+OBk+OBi+OCieWIhuWykFxuXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJyksICcnKVxuICB7IC8vIGltcG9ydCDjga7nva7jgY3mj5vjgYhcbiAgICBsZXQgaSA9IDBcbiAgICByZWZhY3RvcmVkID0gcmVmYWN0b3JlZC5yZXBsYWNlKFxuICAgICAgbmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJyksXG4gICAgICAoKSA9PiBoYXNoKGltcG9ydHNbaSsrXS5pZClcbiAgICApXG4gIH1cblxuICAvLyBkYXRhIOOBrue9ruOBjeaPm+OBiFxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAoZGF0YVJlZ0V4cCwgJ2cnKSwgJycpXG4gIC8vIHJlZmFjdG9yZWQg44GL44KJ44Gv5raI44GV44Gq44GEXG5cbiAgLy8g44Op44Kk44OW44Op44Oq44Gu57WC44KP44KK44GM5Y2Y5L2T44Gn5q6L44KL44Go5bSp44KM44KLXG4gIGlmIChsaWJFbmRSZWdFeHAudGVzdChcbiAgICBjb2RlLnJlcGxhY2UobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSwgJ2cnKSwgJycpXG4gICkpIHRocm93IGAke25hbWV9IDogY2Fubm90IGluY2x1ZGUgdW5pdCBsaWIgZW5kYFxuXG4gIGlmIChlbmNsb3N1cmVDb3VudCA9PT0gMCkge1xuICAgIGNvZGUgPSBlbmNsb3NlKG5hbWUsIGNvZGUpXG4gICAgcmVmYWN0b3JlZCA9IGVuY2xvc2UobmFtZSwgcmVmYWN0b3JlZClcbiAgfVxuXG4gIGNvbnN0IGVuY2xvc2VkID0gY29kZS5tYXRjaChtYWtlTGlicmFyeVJlZ0V4cCgnPScgKyBuYW1lKSlbMF1cblxuICByZXR1cm4ge1xuICAgIG5hbWUsXG4gICAgZGF0YToge1xuICAgICAgbmFtZXNwYWNlLFxuICAgICAgZmlsZW5hbWUsXG4gICAgICBjb2RlLCAvLyDjgrnjg4vjg5rjg4Pjg4jnlKhcbiAgICAgIHJlZmFjdG9yZWQsIC8vIOOCguOBqOOBruOCs+ODvOODiee9ruOBjeaPm+OBiOeUqFxuICAgICAgZW5jbG9zZWQsIC8vIOS7luOBrnJlZmFjdG9yZWTjga7jgoLjga7jgavln4vjgoHovrzjgoDnlKhcbiAgICAgIGRhdGEsXG4gICAgICBvbGQsXG4gICAgICByZXF1aXJlOiByZXF1aXJlbWVudHMsXG4gICAgICBpbXBvcnQ6IGltcG9ydHMsXG4gICAgICBmaW5pc2hlZDogZmFsc2UsXG4gICAgICBwcm9jZXNzaW5nOiBmYWxzZVxuICAgIH1cbiAgfVxufVxuIl19