"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @([^ \t\n]+)[ \t]+([^ \n].*)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?!Foo Lib)(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libHeadRegExp = /(?:^|\n)([ \t]*)\/\/\/ --- (.+?) {{{ \/\/\/[\s\S]*?\n(?:\n|$)/;
const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|$)/;
const newRegExp = /^\/\/ @new(?:[ \t]+([^ \n].*))?(?:\n|$)/;
const nameRegExp = /(?<=^|\n)\/\/ @[ \t]+([^ \t\n].*)(?:\n|$)/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  let data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    // @new {name}
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1]; // @ {name}

    const nameData = code.match(nameRegExp);
    if (nameData) return nameData[1]; // @name {name}

    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  data = data.filter(el => el[0] !== 'name'); //
  // ライブラリに関して

  const libraryRegExp = makeLibraryRegExp('!' + name);
  const requirements = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
    old: el,
    name: el.match(libraryRegExp)[2],
    id: IDMaker.next().value
  })); // {old, name}
  // ライブラリの置き換え

  {
    let i = 0;
    code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
      return (0, _id.hash)(requirements[i++].id);
    });
  } //
  // ライブラリの置き換えをした跡に調べないと壊れる

  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`; // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(newRegExp, '');
  code = code.replace(nameRegExp, '');
  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  {
    const hollow = code.replace(makeLibraryRegExp('=' + name, 'g'), '');

    if (libEndRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib END "/// }}}--- ///`;
    } // ついでにhead残りも調べる．


    if (libHeadRegExp.test(hollow)) {
      console.error(hollow);
      throw `${namespace} / ${filename} : ${name} : cannot include unit lib HEAD "/// --- {name} }}} ///"`;
    }
  }
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      name,
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibWFrZUxpYnJhcnlSZWdFeHAiLCJleCIsImZsYWdzIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibGliSGVhZFJlZ0V4cCIsImxpYkVuZFJlZ0V4cCIsIm5ld1JlZ0V4cCIsIm5hbWVSZWdFeHAiLCJlbmNsb3NlIiwibmFtZSIsImNvZGUiLCJtYWtlTGliIiwib2xkIiwibmFtZXNwYWNlIiwiZmlsZW5hbWUiLCJjb25maWciLCJJRE1ha2VyIiwiZGF0YSIsIm1hdGNoIiwibWFwIiwiZWwiLCJBcnJheSIsImZyb20iLCJzaGlmdCIsImZpbHRlciIsIm5ld0RhdGEiLCJuYW1lRGF0YSIsImxpYnJhcnlSZWdFeHAiLCJyZXF1aXJlbWVudHMiLCJpZCIsIm5leHQiLCJ2YWx1ZSIsImkiLCJyZXBsYWNlIiwiZW5jbG9zdXJlQ291bnQiLCJsZW5ndGgiLCJpbXBvcnRzIiwicmVmYWN0b3JlZCIsImhvbGxvdyIsInRlc3QiLCJjb25zb2xlIiwiZXJyb3IiLCJlbmNsb3NlZCIsInJlcXVpcmUiLCJpbXBvcnQiLCJmaW5pc2hlZCIsInByb2Nlc3NpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUVBLE1BQU1BLFlBQVksR0FBRywwREFBckI7QUFFQSxNQUFNQyxVQUFVLEdBQUcsb0RBQW5CLEMsQ0FDQTs7QUFDQSxNQUFNQyxpQkFBaUIsR0FBRyxDQUFDQyxFQUFELEVBQUtDLEtBQUwsS0FBZSxJQUFJQyxNQUFKLENBQ3ZDQyxNQUFNLENBQUNDLEdBQUksaUNBQWdDSixFQUFHLDJEQURQLEVBRXZDQyxLQUZ1QyxDQUF6Qzs7QUFLQSxNQUFNSSxhQUFhLEdBQUcsK0RBQXRCO0FBQ0EsTUFBTUMsWUFBWSxHQUFHLDRDQUFyQjtBQUNBLE1BQU1DLFNBQVMsR0FBRyx5Q0FBbEI7QUFDQSxNQUFNQyxVQUFVLEdBQUcsMkNBQW5C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QixFQUEwQyxDQUExQyxDQUFILEdBQWtERCxPQUFPLENBQUNDLElBQUQsRUFBT0MsSUFBUCxDQUF4RjtBQUVBLFNBQU87QUFDTEQsSUFBQUEsSUFESztBQUVMUSxJQUFBQSxJQUFJLEVBQUU7QUFDSlIsTUFBQUEsSUFESTtBQUVKSSxNQUFBQSxTQUZJO0FBR0pDLE1BQUFBLFFBSEk7QUFJSkosTUFBQUEsSUFKSTtBQUlFO0FBQ04yQixNQUFBQSxVQUxJO0FBS1E7QUFDWkssTUFBQUEsUUFOSTtBQU1NO0FBQ1Z6QixNQUFBQSxJQVBJO0FBUUpMLE1BQUFBLEdBUkk7QUFTSitCLE1BQUFBLE9BQU8sRUFBRWYsWUFUTDtBQVVKZ0IsTUFBQUEsTUFBTSxFQUFFUixPQVZKO0FBV0pTLE1BQUFBLFFBQVEsRUFBRSxLQVhOO0FBWUpDLE1BQUFBLFVBQVUsRUFBRTtBQVpSO0FBRkQsR0FBUDtBQWlCRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZvcm1hdCB9IGZyb20gJy4uL2Zvcm1hdHRlcidcbmltcG9ydCB7IGhhc2gsIG1ha2VJRE1ha2VyIH0gZnJvbSAnLi4vaWQnXG5cbmNvbnN0IGltcG9ydFJlZ0V4cCA9IC8oPzw9XnxcXG4pXFwvXFwvIEBpbXBvcnQgKC4rKVxcbj8oW1xcc1xcU10qPylcXG5cXC9cXC8gQEAoPz1cXG58JCkvXG5cbmNvbnN0IGRhdGFSZWdFeHAgPSAvKD88PV58XFxuKVxcL1xcLyBAKFteIFxcdFxcbl0rKVsgXFx0XSsoW14gXFxuXS4qKSg/OlxcbnwkKS9cbi8vICg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/IUZvbyBMaWIpKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG5cXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKVxuY29uc3QgbWFrZUxpYnJhcnlSZWdFeHAgPSAoZXgsIGZsYWdzKSA9PiBuZXcgUmVnRXhwKFxuICBTdHJpbmcucmF3YCg/PD1efFxcbikoWyBcXHRdKilcXC9cXC9cXC8gLS0tICg/JHtleH0pKC4rPykge3t7IFxcL1xcL1xcL1tcXHNcXFNdKj9cXG5cXDFcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/PVxcbnwkKWAsXG4gIGZsYWdzXG4pXG5cbmNvbnN0IGxpYkhlYWRSZWdFeHAgPSAvKD86XnxcXG4pKFsgXFx0XSopXFwvXFwvXFwvIC0tLSAoLis/KSB7e3sgXFwvXFwvXFwvW1xcc1xcU10qP1xcbig/OlxcbnwkKS9cbmNvbnN0IGxpYkVuZFJlZ0V4cCA9IC8oPzpefFxcbilbIFxcdF0qXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPzpcXG58JCkvXG5jb25zdCBuZXdSZWdFeHAgPSAvXlxcL1xcLyBAbmV3KD86WyBcXHRdKyhbXiBcXG5dLiopKT8oPzpcXG58JCkvXG5jb25zdCBuYW1lUmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQFsgXFx0XSsoW14gXFx0XFxuXS4qKSg/OlxcbnwkKS9cblxuY29uc3QgZW5jbG9zZSA9IChuYW1lLCBjb2RlKSA9PiBgLy8vIC0tLSAke25hbWV9IHt7eyAvLy9cXG4ke2NvZGV9XFxuLy8vIH19fS0tLSAvLy9gXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWtlTGliIChvbGQsIG5hbWVzcGFjZSwgZmlsZW5hbWUsIGNvbmZpZykge1xuICBjb25zdCBJRE1ha2VyID0gbWFrZUlETWFrZXIoKVxuICBsZXQgY29kZSA9IG9sZCAvLyDjgYTjgo/jgobjgotzbmlwcGV055So44Gu44Kz44O844OJXG4gIGNvZGUgPSBhd2FpdCBmb3JtYXQoY29kZSwgY29uZmlnKVxuXG4gIC8vIOODh+ODvOOCv+aKveWHulxuICBsZXQgZGF0YSA9IChjb2RlLm1hdGNoKG5ldyBSZWdFeHAoZGF0YVJlZ0V4cCwgJ2cnKSkgfHwgW10pXG4gICAgLm1hcChlbCA9PiBBcnJheS5mcm9tKGVsLm1hdGNoKGRhdGFSZWdFeHApKSkgLy8gW2FsbCwgbmFtZSwgZGF0YV1cbiAgICAubWFwKGVsID0+IChlbC5zaGlmdCgpLCBlbCkpIC8vIFtuYW1lLCBkYXRhXVxuICAgIC5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICdpbXBvcnQnKVxuICAgIC5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICduZXcnKVxuICBjb25zdCBuYW1lID0gKCgpID0+IHtcbiAgICAvLyBAbmV3IHtuYW1lfVxuICAgIGNvbnN0IG5ld0RhdGEgPSBjb2RlLm1hdGNoKG5ld1JlZ0V4cClcbiAgICBpZiAobmV3RGF0YSAmJiBuZXdEYXRhWzFdKSByZXR1cm4gbmV3RGF0YVsxXVxuICAgIC8vIEAge25hbWV9XG4gICAgY29uc3QgbmFtZURhdGEgPSBjb2RlLm1hdGNoKG5hbWVSZWdFeHApXG4gICAgaWYgKG5hbWVEYXRhKSByZXR1cm4gbmFtZURhdGFbMV1cbiAgICAvLyBAbmFtZSB7bmFtZX1cbiAgICBsZXQgbmFtZSA9IGRhdGEuZmlsdGVyKGVsID0+IGVsWzBdID09PSAnbmFtZScpWzBdXG4gICAgaWYgKCFuYW1lKSB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiBubyBuYW1lYFxuICAgIHJldHVybiBuYW1lWzFdXG4gIH0pKClcbiAgZGF0YSA9IGRhdGEuZmlsdGVyKGVsID0+IGVsWzBdICE9PSAnbmFtZScpXG4gIC8vXG5cbiAgLy8g44Op44Kk44OW44Op44Oq44Gr6Zai44GX44GmXG4gIGNvbnN0IGxpYnJhcnlSZWdFeHAgPSBtYWtlTGlicmFyeVJlZ0V4cCgnIScgKyBuYW1lKVxuICBjb25zdCByZXF1aXJlbWVudHMgPSAoY29kZVxuICAgIC5tYXRjaChuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gKHtcbiAgICAgIG9sZDogZWwsIG5hbWU6IGVsLm1hdGNoKGxpYnJhcnlSZWdFeHApWzJdLCBpZDogSURNYWtlci5uZXh0KCkudmFsdWVcbiAgICB9KSkgLy8ge29sZCwgbmFtZX1cbiAgICAvLyDjg6njgqTjg5bjg6njg6rjga7nva7jgY3mj5vjgYhcbiAge1xuICAgIGxldCBpID0gMFxuICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UoXG4gICAgICBuZXcgUmVnRXhwKGxpYnJhcnlSZWdFeHAsICdnJyksXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHJldHVybiBoYXNoKHJlcXVpcmVtZW50c1tpKytdLmlkKVxuICAgICAgfVxuICAgIClcbiAgfVxuICAvL1xuICAvLyDjg6njgqTjg5bjg6njg6rjga7nva7jgY3mj5vjgYjjgpLjgZfjgZ/ot6Hjgavoqr/jgbnjgarjgYTjgajlo4rjgozjgotcbiAgY29uc3QgZW5jbG9zdXJlQ291bnQgPVxuICAgICAgKGNvZGUubWF0Y2gobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSwgJ2cnKSkgfHwgW10pLmxlbmd0aFxuICBpZiAoZW5jbG9zdXJlQ291bnQgPj0gMikgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBoYW5kbGUgMiBvciBtb3JlIGVuY2xvc3VyZXMgXCIvLy8gLS0tLi4uXCJgXG5cbiAgLy8gaW1wb3J0IOaKveWHulxuICBjb25zdCBpbXBvcnRzID0gKGNvZGVcbiAgICAubWF0Y2gobmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gQXJyYXkuZnJvbShlbC5tYXRjaChpbXBvcnRSZWdFeHApKSkgLy8gW2FsbCwgbmFtZSwgY29kZV1cbiAgICAubWFwKChbLCBuYW1lLCBvbGRdKSA9PiAoe25hbWUsIG9sZCwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlfSkpXG5cbiAgbGV0IHJlZmFjdG9yZWQgPSBjb2RlIC8vIOOBk+OBk+OBi+OCieWIhuWykFxuXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3UmVnRXhwLCAnJylcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuYW1lUmVnRXhwLCAnJylcblxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpLCAnJylcbiAgeyAvLyBpbXBvcnQg44Gu572u44GN5o+b44GIXG4gICAgbGV0IGkgPSAwXG4gICAgcmVmYWN0b3JlZCA9IHJlZmFjdG9yZWQucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAoaW1wb3J0UmVnRXhwLCAnZycpLFxuICAgICAgKCkgPT4gaGFzaChpbXBvcnRzW2krK10uaWQpXG4gICAgKVxuICB9XG5cbiAgLy8gZGF0YSDjga7nva7jgY3mj5vjgYhcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXcgUmVnRXhwKGRhdGFSZWdFeHAsICdnJyksICcnKVxuICAvLyByZWZhY3RvcmVkIOOBi+OCieOBr+a2iOOBleOBquOBhFxuXG4gIC8vIOODqeOCpOODluODqeODquOBrue1guOCj+OCiuOBjOWNmOS9k+OBp+aui+OCi+OBqOW0qeOCjOOCi1xuICB7XG4gICAgY29uc3QgaG9sbG93ID0gY29kZS5yZXBsYWNlKG1ha2VMaWJyYXJ5UmVnRXhwKCc9JyArIG5hbWUsICdnJyksICcnKVxuICAgIGlmIChsaWJFbmRSZWdFeHAudGVzdChob2xsb3cpKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGhvbGxvdylcbiAgICAgIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6ICR7bmFtZX0gOiBjYW5ub3QgaW5jbHVkZSB1bml0IGxpYiBFTkQgXCIvLy8gfX19LS0tIC8vL2BcbiAgICB9XG4gICAgLy8g44Gk44GE44Gn44GraGVhZOaui+OCiuOCguiqv+OBueOCi++8jlxuICAgIGlmIChsaWJIZWFkUmVnRXhwLnRlc3QoaG9sbG93KSkge1xuICAgICAgY29uc29sZS5lcnJvcihob2xsb3cpXG4gICAgICB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiAke25hbWV9IDogY2Fubm90IGluY2x1ZGUgdW5pdCBsaWIgSEVBRCBcIi8vLyAtLS0ge25hbWV9IH19fSAvLy9cImBcbiAgICB9XG4gIH1cblxuICBjb25zdCBlbmNsb3NlZCA9IGVuY2xvc3VyZUNvdW50ID8gY29kZS5tYXRjaChtYWtlTGlicmFyeVJlZ0V4cCgnPScgKyBuYW1lKSlbMF0gOiBlbmNsb3NlKG5hbWUsIGNvZGUpXG5cbiAgcmV0dXJuIHtcbiAgICBuYW1lLFxuICAgIGRhdGE6IHtcbiAgICAgIG5hbWUsXG4gICAgICBuYW1lc3BhY2UsXG4gICAgICBmaWxlbmFtZSxcbiAgICAgIGNvZGUsIC8vIOOCueODi+ODmuODg+ODiOeUqFxuICAgICAgcmVmYWN0b3JlZCwgLy8g44KC44Go44Gu44Kz44O844OJ572u44GN5o+b44GI55SoXG4gICAgICBlbmNsb3NlZCwgLy8g5LuW44GucmVmYWN0b3JlZOOBruOCguOBruOBq+Wfi+OCgei+vOOCgOeUqFxuICAgICAgZGF0YSxcbiAgICAgIG9sZCxcbiAgICAgIHJlcXVpcmU6IHJlcXVpcmVtZW50cyxcbiAgICAgIGltcG9ydDogaW1wb3J0cyxcbiAgICAgIGZpbmlzaGVkOiBmYWxzZSxcbiAgICAgIHByb2Nlc3Npbmc6IGZhbHNlXG4gICAgfVxuICB9XG59XG4iXX0=