"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.makeLib = makeLib;

require("source-map-support/register");

var _formatter = require("../formatter");

var _id = require("../id");

const importRegExp = /(?<=^|\n)\/\/ @import (.+)\n?([\s\S]*?)\n\/\/ @@(?=\n|$)/;
const dataRegExp = /(?<=^|\n)\/\/ @(.+?) (.+)(?:\n|$)/; // (?<=^|\n)([ \t]*)\/\/\/ --- (?!Foo Lib)(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)

const makeLibraryRegExp = (ex, flags) => new RegExp(String.raw`(?<=^|\n)([ \t]*)\/\/\/ --- (?${ex})(.+?) {{{ \/\/\/[\s\S]*?\n\1\/\/\/ }}}--- \/\/\/(?=\n|$)`, flags);

const libEndRegExp = /(?:^|\n)[ \t]*\/\/\/ }}}--- \/\/\/(?:\n|&)/;
const newRegExp = /^\/\/ @new(?: (.*))\n/;

const enclose = (name, code) => `/// --- ${name} {{{ ///\n${code}\n/// }}}--- ///`;

async function makeLib(old, namespace, filename, config) {
  const IDMaker = (0, _id.makeIDMaker)();
  let code = old; // いわゆるsnippet用のコード

  code = await (0, _formatter.format)(code, config); // データ抽出

  const data = (code.match(new RegExp(dataRegExp, 'g')) || []).map(el => Array.from(el.match(dataRegExp))) // [all, name, data]
  .map(el => (el.shift(), el)) // [name, data]
  .filter(el => el[0] !== 'import').filter(el => el[0] !== 'new');

  const name = (() => {
    const newData = code.match(newRegExp);
    if (newData && newData[1]) return newData[1];
    let name = data.filter(el => el[0] === 'name')[0];
    if (!name) throw `${namespace} / ${filename} : no name`;
    return name[1];
  })();

  code = code.replace(newRegExp, ''); //
  // ライブラリに関して

  const libraryRegExp = makeLibraryRegExp('!' + name);
  const enclosureCount = (code.match(makeLibraryRegExp('=' + name, 'g')) || []).length;
  if (enclosureCount >= 2) throw `${namespace} / ${filename} : ${name} : cannot handle 2 or more enclosures "/// ---..."`;
  const requirements = (code.match(new RegExp(libraryRegExp, 'g')) || []).map(el => ({
    old: el,
    name: el.match(libraryRegExp)[2],
    id: IDMaker.next().value
  })); // {old, name}
  // ライブラリの置き換え

  {
    let i = 0;
    code = code.replace(new RegExp(libraryRegExp, 'g'), () => {
      return (0, _id.hash)(requirements[i++].id);
    });
  } //
  // import 抽出

  const imports = (code.match(new RegExp(importRegExp, 'g')) || []).map(el => Array.from(el.match(importRegExp))) // [all, name, code]
  .map(([, name, old]) => ({
    name,
    old,
    id: IDMaker.next().value
  }));
  let refactored = code; // ここから分岐

  code = code.replace(new RegExp(importRegExp, 'g'), '');
  {
    // import の置き換え
    let i = 0;
    refactored = refactored.replace(new RegExp(importRegExp, 'g'), () => (0, _id.hash)(imports[i++].id));
  } // data の置き換え

  code = code.replace(new RegExp(dataRegExp, 'g'), ''); // refactored からは消さない
  // ライブラリの終わりが単体で残ると崩れる

  if (libEndRegExp.test(code.replace(makeLibraryRegExp('=' + name, 'g'), ''))) throw `${namespace} / ${filename} : ${name} : cannot include unit lib end`;
  const enclosed = enclosureCount ? code.match(makeLibraryRegExp('=' + name))[0] : enclose(name, code);
  return {
    name,
    data: {
      namespace,
      filename,
      code,
      // スニペット用
      refactored,
      // もとのコード置き換え用
      enclosed,
      // 他のrefactoredのものに埋め込む用
      data,
      old,
      require: requirements,
      import: imports,
      finished: false,
      processing: false
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWtlcnMvbWFrZUxpYi5qcyJdLCJuYW1lcyI6WyJpbXBvcnRSZWdFeHAiLCJkYXRhUmVnRXhwIiwibWFrZUxpYnJhcnlSZWdFeHAiLCJleCIsImZsYWdzIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibGliRW5kUmVnRXhwIiwibmV3UmVnRXhwIiwiZW5jbG9zZSIsIm5hbWUiLCJjb2RlIiwibWFrZUxpYiIsIm9sZCIsIm5hbWVzcGFjZSIsImZpbGVuYW1lIiwiY29uZmlnIiwiSURNYWtlciIsImRhdGEiLCJtYXRjaCIsIm1hcCIsImVsIiwiQXJyYXkiLCJmcm9tIiwic2hpZnQiLCJmaWx0ZXIiLCJuZXdEYXRhIiwicmVwbGFjZSIsImxpYnJhcnlSZWdFeHAiLCJlbmNsb3N1cmVDb3VudCIsImxlbmd0aCIsInJlcXVpcmVtZW50cyIsImlkIiwibmV4dCIsInZhbHVlIiwiaSIsImltcG9ydHMiLCJyZWZhY3RvcmVkIiwidGVzdCIsImVuY2xvc2VkIiwicmVxdWlyZSIsImltcG9ydCIsImZpbmlzaGVkIiwicHJvY2Vzc2luZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEsWUFBWSxHQUFHLDBEQUFyQjtBQUNBLE1BQU1DLFVBQVUsR0FBRyxtQ0FBbkIsQyxDQUNBOztBQUNBLE1BQU1DLGlCQUFpQixHQUFHLENBQUNDLEVBQUQsRUFBS0MsS0FBTCxLQUFlLElBQUlDLE1BQUosQ0FDdkNDLE1BQU0sQ0FBQ0MsR0FBSSxpQ0FBZ0NKLEVBQUcsMkRBRFAsRUFFdkNDLEtBRnVDLENBQXpDOztBQUlBLE1BQU1JLFlBQVksR0FBRyw0Q0FBckI7QUFDQSxNQUFNQyxTQUFTLEdBQUcsdUJBQWxCOztBQUVBLE1BQU1DLE9BQU8sR0FBRyxDQUFDQyxJQUFELEVBQU9DLElBQVAsS0FBaUIsV0FBVUQsSUFBSyxhQUFZQyxJQUFLLGtCQUFqRTs7QUFFTyxlQUFlQyxPQUFmLENBQXdCQyxHQUF4QixFQUE2QkMsU0FBN0Is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LENBQUNnQixPQUFMLENBQWExQixpQkFBaUIsQ0FBQyxNQUFNUyxJQUFQLEVBQWEsR0FBYixDQUE5QixFQUFpRCxFQUFqRCxDQURFLENBQUosRUFFRyxNQUFPLEdBQUVJLFNBQVUsTUFBS0MsUUFBUyxNQUFLTCxJQUFLLGdDQUEzQztBQUVILFFBQU02QixRQUFRLEdBQUdWLGNBQWMsR0FBR2xCLElBQUksQ0FBQ1EsS0FBTCxDQUFXbEIsaUJBQWlCLENBQUMsTUFBTVMsSUFBUCxDQUE1QixFQUEwQyxDQUExQyxDQUFILEdBQWtERCxPQUFPLENBQUNDLElBQUQsRUFBT0MsSUFBUCxDQUF4RjtBQUVBLFNBQU87QUFDTEQsSUFBQUEsSUFESztBQUVMUSxJQUFBQSxJQUFJLEVBQUU7QUFDSkosTUFBQUEsU0FESTtBQUVKQyxNQUFBQSxRQUZJO0FBR0pKLE1BQUFBLElBSEk7QUFHRTtBQUNOMEIsTUFBQUEsVUFKSTtBQUlRO0FBQ1pFLE1BQUFBLFFBTEk7QUFLTTtBQUNWckIsTUFBQUEsSUFOSTtBQU9KTCxNQUFBQSxHQVBJO0FBUUoyQixNQUFBQSxPQUFPLEVBQUVULFlBUkw7QUFTSlUsTUFBQUEsTUFBTSxFQUFFTCxPQVRKO0FBVUpNLE1BQUFBLFFBQVEsRUFBRSxLQVZOO0FBV0pDLE1BQUFBLFVBQVUsRUFBRTtBQVhSO0FBRkQsR0FBUDtBQWdCRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZvcm1hdCB9IGZyb20gJy4uL2Zvcm1hdHRlcidcbmltcG9ydCB7IGhhc2gsIG1ha2VJRE1ha2VyIH0gZnJvbSAnLi4vaWQnXG5cbmNvbnN0IGltcG9ydFJlZ0V4cCA9IC8oPzw9XnxcXG4pXFwvXFwvIEBpbXBvcnQgKC4rKVxcbj8oW1xcc1xcU10qPylcXG5cXC9cXC8gQEAoPz1cXG58JCkvXG5jb25zdCBkYXRhUmVnRXhwID0gLyg/PD1efFxcbilcXC9cXC8gQCguKz8pICguKykoPzpcXG58JCkvXG4vLyAoPzw9XnxcXG4pKFsgXFx0XSopXFwvXFwvXFwvIC0tLSAoPyFGb28gTGliKSguKz8pIHt7eyBcXC9cXC9cXC9bXFxzXFxTXSo/XFxuXFwxXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPz1cXG58JClcbmNvbnN0IG1ha2VMaWJyYXJ5UmVnRXhwID0gKGV4LCBmbGFncykgPT4gbmV3IFJlZ0V4cChcbiAgU3RyaW5nLnJhd2AoPzw9XnxcXG4pKFsgXFx0XSopXFwvXFwvXFwvIC0tLSAoPyR7ZXh9KSguKz8pIHt7eyBcXC9cXC9cXC9bXFxzXFxTXSo/XFxuXFwxXFwvXFwvXFwvIH19fS0tLSBcXC9cXC9cXC8oPz1cXG58JClgLFxuICBmbGFnc1xuKVxuY29uc3QgbGliRW5kUmVnRXhwID0gLyg/Ol58XFxuKVsgXFx0XSpcXC9cXC9cXC8gfX19LS0tIFxcL1xcL1xcLyg/OlxcbnwmKS9cbmNvbnN0IG5ld1JlZ0V4cCA9IC9eXFwvXFwvIEBuZXcoPzogKC4qKSlcXG4vXG5cbmNvbnN0IGVuY2xvc2UgPSAobmFtZSwgY29kZSkgPT4gYC8vLyAtLS0gJHtuYW1lfSB7e3sgLy8vXFxuJHtjb2RlfVxcbi8vLyB9fX0tLS0gLy8vYFxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWFrZUxpYiAob2xkLCBuYW1lc3BhY2UsIGZpbGVuYW1lLCBjb25maWcpIHtcbiAgY29uc3QgSURNYWtlciA9IG1ha2VJRE1ha2VyKClcbiAgbGV0IGNvZGUgPSBvbGQgLy8g44GE44KP44KG44KLc25pcHBldOeUqOOBruOCs+ODvOODiVxuICBjb2RlID0gYXdhaXQgZm9ybWF0KGNvZGUsIGNvbmZpZylcblxuICAvLyDjg4fjg7zjgr/mir3lh7pcbiAgY29uc3QgZGF0YSA9IChjb2RlLm1hdGNoKG5ldyBSZWdFeHAoZGF0YVJlZ0V4cCwgJ2cnKSkgfHwgW10pXG4gICAgLm1hcChlbCA9PiBBcnJheS5mcm9tKGVsLm1hdGNoKGRhdGFSZWdFeHApKSkgLy8gW2FsbCwgbmFtZSwgZGF0YV1cbiAgICAubWFwKGVsID0+IChlbC5zaGlmdCgpLCBlbCkpIC8vIFtuYW1lLCBkYXRhXVxuICAgIC5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICdpbXBvcnQnKVxuICAgIC5maWx0ZXIoZWwgPT4gZWxbMF0gIT09ICduZXcnKVxuICBjb25zdCBuYW1lID0gKCgpID0+IHtcbiAgICBjb25zdCBuZXdEYXRhID0gY29kZS5tYXRjaChuZXdSZWdFeHApXG4gICAgaWYgKG5ld0RhdGEgJiYgbmV3RGF0YVsxXSkgcmV0dXJuIG5ld0RhdGFbMV1cbiAgICBsZXQgbmFtZSA9IGRhdGEuZmlsdGVyKGVsID0+IGVsWzBdID09PSAnbmFtZScpWzBdXG4gICAgaWYgKCFuYW1lKSB0aHJvdyBgJHtuYW1lc3BhY2V9IC8gJHtmaWxlbmFtZX0gOiBubyBuYW1lYFxuICAgIHJldHVybiBuYW1lWzFdXG4gIH0pKClcbiAgY29kZSA9IGNvZGUucmVwbGFjZShuZXdSZWdFeHAsICcnKVxuICAvL1xuXG4gIC8vIOODqeOCpOODluODqeODquOBq+mWouOBl+OBplxuICBjb25zdCBsaWJyYXJ5UmVnRXhwID0gbWFrZUxpYnJhcnlSZWdFeHAoJyEnICsgbmFtZSlcbiAgY29uc3QgZW5jbG9zdXJlQ291bnQgPVxuICAgICAgKGNvZGUubWF0Y2gobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSwgJ2cnKSkgfHwgW10pLmxlbmd0aFxuICBpZiAoZW5jbG9zdXJlQ291bnQgPj0gMikgdGhyb3cgYCR7bmFtZXNwYWNlfSAvICR7ZmlsZW5hbWV9IDogJHtuYW1lfSA6IGNhbm5vdCBoYW5kbGUgMiBvciBtb3JlIGVuY2xvc3VyZXMgXCIvLy8gLS0tLi4uXCJgXG4gIGNvbnN0IHJlcXVpcmVtZW50cyA9IChjb2RlXG4gICAgLm1hdGNoKG5ldyBSZWdFeHAobGlicmFyeVJlZ0V4cCwgJ2cnKSkgfHwgW10pXG4gICAgLm1hcChlbCA9PiAoe1xuICAgICAgb2xkOiBlbCwgbmFtZTogZWwubWF0Y2gobGlicmFyeVJlZ0V4cClbMl0sIGlkOiBJRE1ha2VyLm5leHQoKS52YWx1ZVxuICAgIH0pKSAvLyB7b2xkLCBuYW1lfVxuICAgIC8vIOODqeOCpOODluODqeODquOBrue9ruOBjeaPm+OBiFxuICB7XG4gICAgbGV0IGkgPSAwXG4gICAgY29kZSA9IGNvZGUucmVwbGFjZShcbiAgICAgIG5ldyBSZWdFeHAobGlicmFyeVJlZ0V4cCwgJ2cnKSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgcmV0dXJuIGhhc2gocmVxdWlyZW1lbnRzW2krK10uaWQpXG4gICAgICB9XG4gICAgKVxuICB9XG4gIC8vXG5cbiAgLy8gaW1wb3J0IOaKveWHulxuICBjb25zdCBpbXBvcnRzID0gKGNvZGVcbiAgICAubWF0Y2gobmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJykpIHx8IFtdKVxuICAgIC5tYXAoZWwgPT4gQXJyYXkuZnJvbShlbC5tYXRjaChpbXBvcnRSZWdFeHApKSkgLy8gW2FsbCwgbmFtZSwgY29kZV1cbiAgICAubWFwKChbLCBuYW1lLCBvbGRdKSA9PiAoe25hbWUsIG9sZCwgaWQ6IElETWFrZXIubmV4dCgpLnZhbHVlfSkpXG5cbiAgbGV0IHJlZmFjdG9yZWQgPSBjb2RlIC8vIOOBk+OBk+OBi+OCieWIhuWykFxuXG4gIGNvZGUgPSBjb2RlLnJlcGxhY2UobmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJyksICcnKVxuICB7IC8vIGltcG9ydCDjga7nva7jgY3mj5vjgYhcbiAgICBsZXQgaSA9IDBcbiAgICByZWZhY3RvcmVkID0gcmVmYWN0b3JlZC5yZXBsYWNlKFxuICAgICAgbmV3IFJlZ0V4cChpbXBvcnRSZWdFeHAsICdnJyksXG4gICAgICAoKSA9PiBoYXNoKGltcG9ydHNbaSsrXS5pZClcbiAgICApXG4gIH1cblxuICAvLyBkYXRhIOOBrue9ruOBjeaPm+OBiFxuICBjb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAoZGF0YVJlZ0V4cCwgJ2cnKSwgJycpXG4gIC8vIHJlZmFjdG9yZWQg44GL44KJ44Gv5raI44GV44Gq44GEXG5cbiAgLy8g44Op44Kk44OW44Op44Oq44Gu57WC44KP44KK44GM5Y2Y5L2T44Gn5q6L44KL44Go5bSp44KM44KLXG4gIGlmIChsaWJFbmRSZWdFeHAudGVzdChcbiAgICBjb2RlLnJlcGxhY2UobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSwgJ2cnKSwgJycpXG4gICkpIHRocm93IGAke25hbWVzcGFjZX0gLyAke2ZpbGVuYW1lfSA6ICR7bmFtZX0gOiBjYW5ub3QgaW5jbHVkZSB1bml0IGxpYiBlbmRgXG5cbiAgY29uc3QgZW5jbG9zZWQgPSBlbmNsb3N1cmVDb3VudCA/IGNvZGUubWF0Y2gobWFrZUxpYnJhcnlSZWdFeHAoJz0nICsgbmFtZSkpWzBdIDogZW5jbG9zZShuYW1lLCBjb2RlKVxuXG4gIHJldHVybiB7XG4gICAgbmFtZSxcbiAgICBkYXRhOiB7XG4gICAgICBuYW1lc3BhY2UsXG4gICAgICBmaWxlbmFtZSxcbiAgICAgIGNvZGUsIC8vIOOCueODi+ODmuODg+ODiOeUqFxuICAgICAgcmVmYWN0b3JlZCwgLy8g44KC44Go44Gu44Kz44O844OJ572u44GN5o+b44GI55SoXG4gICAgICBlbmNsb3NlZCwgLy8g5LuW44GucmVmYWN0b3JlZOOBruOCguOBruOBq+Wfi+OCgei+vOOCgOeUqFxuICAgICAgZGF0YSxcbiAgICAgIG9sZCxcbiAgICAgIHJlcXVpcmU6IHJlcXVpcmVtZW50cyxcbiAgICAgIGltcG9ydDogaW1wb3J0cyxcbiAgICAgIGZpbmlzaGVkOiBmYWxzZSxcbiAgICAgIHByb2Nlc3Npbmc6IGZhbHNlXG4gICAgfVxuICB9XG59XG4iXX0=