"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = transformWiki;

require("source-map-support/register");

var _jsYaml = _interopRequireDefault(require("js-yaml"));

var _escape = require("../helpers/escape");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const libRegExp = name => new RegExp(String.raw`(?<=^|\n)// @ ${name}(?=\n|$)`, 'g');

const mdYAMlRegExp = /^---\n(.*?)\n---(?:\n|$)/s; // dfs

/**
 * 破壊する
 */

function transformWiki(wikiYAML, wikis, libs, paths = [], ids = []) {
  const namespace = paths.filter(e => e).join('/');

  const lib = (() => {
    const tmp = Object.values(libs).filter(el => el.namespace === namespace && el.filename === `${wikis.path}.cpp`);
    if (tmp && tmp.length === 1) return tmp[0];else return null;
  })();

  const data = (() => {
    let _data = { ...wikiYAML
    };

    if (wikis.wiki && wikis.wiki.match(mdYAMlRegExp)) {
      const innerData = _jsYaml.default.safeLoad(wikis.wiki.match(mdYAMlRegExp)[1]);

      _data = { ..._data,
        ...innerData
      };
      Object.keys(innerData).forEach(key => {
        wikis[key] = innerData[key];
      });
      wikis.wiki = wikis.wiki.replace(mdYAMlRegExp, '');
    }

    return _data;
  })();

  const id = (() => {
    if (data.id) return data.id;

    if (lib) {
      const _id = lib.data.filter(([name, value]) => name === 'id')[0];
      if (_id) return _id[1];
    }

    return wikis.path;
  })();

  const title = (() => {
    if (data.title) return data.title;
    if (wikis.title) return wikis.title;

    if (lib) {
      const _title = lib.data.filter(([name]) => name === 'title')[0];
      if (_title) return _title[1];
    }

    return wikis.path;
  })();

  paths = [...paths, wikis.path];
  ids = [...ids, id];
  const permalink = wikis.permalink || ids.filter(e => e).join('/'); // TODO : 計算量破滅してないかここ

  if (wikis.wiki) {
    Object.entries(libs).forEach(([key, value]) => {
      wikis.wiki = wikis.wiki.replace(libRegExp(key), () => `\n${'```cpp'}\n${(0, _escape.mdEscape)(value.code)}\n${'```'}\n`);
    });
  } // データは後入れ（順序関係がバグる）


  data.title = wikis.title = title;
  data.permalink = wikis.permalink = permalink;
  if (wikis.wiki) wikis.wiki = `---\n${_jsYaml.default.safeDump(data)}\n---\n\n${wikis.wiki}`;

  if (wikis.child) {
    wikis.child.forEach(child => {
      transformWiki(wikiYAML, child, libs, paths, ids);
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmFuc2Zvcm1lcnMvdHJhbnNmb3JtV2lraS5qcyJdLCJuYW1lcyI6WyJsaWJSZWdFeHAiLCJuYW1lIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibWRZQU1sUmVnRXhwIiwidHJhbnNmb3JtV2lraSIsIndpa2lZQU1MIiwid2lraXMiLCJsaWJzIiwicGF0aHMiLCJpZHMiLCJuYW1lc3BhY2UiLCJmaWx0ZXIiLCJlIiwiam9pbiIsImxpYiIsInRtcCIsIk9iamVjdCIsInZhbHVlcyIsImVsIiwiZmlsZW5hbWUiLCJwYXRoIiwibGVuZ3RoIiwiZGF0YSIsIl9kYXRhIiwid2lraSIsIm1hdGNoIiwiaW5uZXJEYXRhIiwieWFtbCIsInNhZmVMb2FkIiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJyZXBsYWNlIiwiaWQiLCJfaWQiLCJ2YWx1ZSIsInRpdGxlIiwiX3RpdGxlIiwicGVybWFsaW5rIiwiZW50cmllcyIsImNvZGUiLCJzYWZlRHVtcCIsImNoaWxkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBLE1BQU1BLFNBQVMsR0FBR0MsSUFBSSxJQUFJLElBQUlDLE1BQUosQ0FDeEJDLE1BQU0sQ0FBQ0MsR0FBSSxpQkFBZ0JILElBQUssVUFEUixFQUNtQixHQURuQixDQUExQjs7QUFHQSxNQUFNSSxZQUFZLEdBQUcsMkJBQXJCLEMsQ0FFQTs7QUFDQTs7OztBQUdlLFNBQVNDLGFBQVQsQ0FBd0JDLFFBQXhCLEVBQWtDQyxLQUFsQyxFQUF5Q0MsSUFBekMsRUFBK0NDLEtBQUssR0FBRyxFQUF2RCxFQUEyREMsR0FBRyxHQUFHLEVBQWpFLEVBQXFFO0FBQ2xGLFFBQU1DLFNBQVMsR0FBR0YsS0FBSyxDQUFDRyxNQUFOLENBQWFDLENBQUMsSUFBSUEsQ0FBbEIsRUFBcUJDLElBQXJCLENBQTBCLEdBQTFCLENBQWxCOztBQUNBLFFBQU1DLEdBQUcsR0FBRyxDQUFDLE1BQU07QUFDakIsVUFBTUMsR0FBRyxHQUFHQyxN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bXBvcnQgeyBtZEVzY2FwZSB9IGZyb20gJy4uL2hlbHBlcnMvZXNjYXBlJ1xyXG5cclxuY29uc3QgbGliUmVnRXhwID0gbmFtZSA9PiBuZXcgUmVnRXhwKFxyXG4gIFN0cmluZy5yYXdgKD88PV58XFxuKS8vIEAgJHtuYW1lfSg/PVxcbnwkKWAsICdnJylcclxuXHJcbmNvbnN0IG1kWUFNbFJlZ0V4cCA9IC9eLS0tXFxuKC4qPylcXG4tLS0oPzpcXG58JCkvc1xyXG5cclxuLy8gZGZzXHJcbi8qKlxyXG4gKiDnoLTlo4rjgZnjgotcclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYW5zZm9ybVdpa2kgKHdpa2lZQU1MLCB3aWtpcywgbGlicywgcGF0aHMgPSBbXSwgaWRzID0gW10pIHtcclxuICBjb25zdCBuYW1lc3BhY2UgPSBwYXRocy5maWx0ZXIoZSA9PiBlKS5qb2luKCcvJylcclxuICBjb25zdCBsaWIgPSAoKCkgPT4ge1xyXG4gICAgY29uc3QgdG1wID0gT2JqZWN0LnZhbHVlcyhsaWJzKVxyXG4gICAgICAuZmlsdGVyKGVsID0+IGVsLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlICYmIGVsLmZpbGVuYW1lID09PSBgJHt3aWtpcy5wYXRofS5jcHBgKVxyXG4gICAgaWYgKHRtcCAmJiB0bXAubGVuZ3RoID09PSAxKSByZXR1cm4gdG1wWzBdXHJcbiAgICBlbHNlIHJldHVybiBudWxsXHJcbiAgfSkoKVxyXG4gIGNvbnN0IGRhdGEgPSAoKCkgPT4ge1xyXG4gICAgbGV0IF9kYXRhID0ge1xyXG4gICAgICAuLi53aWtpWUFNTCxcclxuICAgIH1cclxuICAgIGlmICh3aWtpcy53aWtpICYmIHdpa2lzLndpa2kubWF0Y2gobWRZQU1sUmVnRXhwKSkge1xyXG4gICAgICBjb25zdCBpbm5lckRhdGEgPSB5YW1sLnNhZmVMb2FkKHdpa2lzLndpa2kubWF0Y2gobWRZQU1sUmVnRXhwKVsxXSlcclxuICAgICAgX2RhdGEgPSB7XHJcbiAgICAgICAgLi4uX2RhdGEsXHJcbiAgICAgICAgLi4uaW5uZXJEYXRhLFxyXG4gICAgICB9XHJcbiAgICAgIE9iamVjdC5rZXlzKGlubmVyRGF0YSkuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICAgIHdpa2lzW2tleV0gPSBpbm5lckRhdGFba2V5XVxyXG4gICAgICB9KVxyXG4gICAgICB3aWtpcy53aWtpID0gd2lraXMud2lraS5yZXBsYWNlKG1kWUFNbFJlZ0V4cCwgJycpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gX2RhdGFcclxuICB9KSgpXHJcbiAgY29uc3QgaWQgPSAoKCkgPT4ge1xyXG4gICAgaWYgKGRhdGEuaWQpIHJldHVybiBkYXRhLmlkXHJcbiAgICBpZiAobGliKSB7XHJcbiAgICAgIGNvbnN0IF9pZCA9IGxpYi5kYXRhLmZpbHRlcigoW25hbWUsIHZhbHVlXSkgPT4gbmFtZSA9PT0gJ2lkJylbMF1cclxuICAgICAgaWYgKF9pZCkgcmV0dXJuIF9pZFsxXVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHdpa2lzLnBhdGhcclxuICB9KSgpXHJcbiAgY29uc3QgdGl0bGUgPSAoKCkgPT4ge1xyXG4gICAgaWYgKGRhdGEudGl0bGUpIHJldHVybiBkYXRhLnRpdGxlXHJcbiAgICBpZiAod2lraXMudGl0bGUpIHJldHVybiB3aWtpcy50aXRsZVxyXG4gICAgaWYgKGxpYikge1xyXG4gICAgICBjb25zdCBfdGl0bGUgPSBsaWIuZGF0YS5maWx0ZXIoKFtuYW1lXSkgPT4gbmFtZSA9PT0gJ3RpdGxlJylbMF1cclxuICAgICAgaWYgKF90aXRsZSkgcmV0dXJuIF90aXRsZVsxXVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHdpa2lzLnBhdGhcclxuICB9KSgpXHJcblxyXG4gIHBhdGhzID0gWy4uLnBhdGhzLCB3aWtpcy5wYXRoXVxyXG4gIGlkcyA9IFsuLi5pZHMsIGlkXVxyXG4gIGNvbnN0IHBlcm1hbGluayA9IHdpa2lzLnBlcm1hbGluayB8fCBpZHMuZmlsdGVyKGUgPT4gZSkuam9pbignLycpXHJcblxyXG4gIC8vIFRPRE8gOiDoqIjnrpfph4/noLTmu4XjgZfjgabjgarjgYTjgYvjgZPjgZNcclxuICBpZiAod2lraXMud2lraSkge1xyXG4gICAgT2JqZWN0LmVudHJpZXMobGlicykuZm9yRWFjaCgoW2tleSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgIHdpa2lzLndpa2kgPSB3aWtpcy53aWtpXHJcbiAgICAgICAgLnJlcGxhY2UobGliUmVnRXhwKGtleSksXHJcbiAgICAgICAgICAoKSA9PiBgXFxuJHsnYGBgY3BwJ31cXG4ke21kRXNjYXBlKHZhbHVlLmNvZGUpfVxcbiR7J2BgYCd9XFxuYClcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICAvLyDjg4fjg7zjgr/jga/lvozlhaXjgozvvIjpoIbluo/plqLkv4LjgYzjg5DjgrDjgovvvIlcclxuXHJcbiAgZGF0YS50aXRsZSA9IHdpa2lzLnRpdGxlID0gdGl0bGVcclxuICBkYXRhLnBlcm1hbGluayA9IHdpa2lzLnBlcm1hbGluayA9IHBlcm1hbGlua1xyXG4gIGlmICh3aWtpcy53aWtpKSB3aWtpcy53aWtpID0gYC0tLVxcbiR7eWFtbC5zYWZlRHVtcChkYXRhKX1cXG4tLS1cXG5cXG4ke3dpa2lzLndpa2l9YFxyXG5cclxuICBpZiAod2lraXMuY2hpbGQpIHtcclxuICAgIHdpa2lzLmNoaWxkLmZvckVhY2goY2hpbGQgPT4ge1xyXG4gICAgICB0cmFuc2Zvcm1XaWtpKHdpa2lZQU1MLCBjaGlsZCwgbGlicywgcGF0aHMsIGlkcylcclxuICAgIH0pXHJcbiAgfVxyXG59XHJcbiJdfQ==