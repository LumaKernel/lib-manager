"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = transformWiki;

require("source-map-support/register");

var _jsYaml = _interopRequireDefault(require("js-yaml"));

var _escape = require("../helpers/escape");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const libRegExp = name => new RegExp(String.raw`(?<=^|\n)// @ ${name}(?=\n|$)`, 'g');

const mdYAMlRegExp = /^---\n(.*?)\n---(?:\n|$)/s; // dfs

/**
 * 破壊する
 */

function transformWiki(wikiYAML, wikis, libs, paths = [], ids = []) {
  const namespace = paths.filter(e => e).join('/');

  const lib = (() => {
    const tmp = Object.values(libs).filter(el => el.namespace === namespace && el.filename === `${wikis.path}.cpp`);
    if (tmp && tmp.length === 1) return tmp[0];else return null;
  })();

  const data = (() => {
    let _data = { ...wikiYAML
    };

    if (wikis.wiki && wikis.wiki.match(mdYAMlRegExp)) {
      const innerData = _jsYaml.default.safeLoad(wikis.wiki.match(mdYAMlRegExp)[1]);

      _data = { ..._data,
        ...innerData
      };
      Object.keys(innerData).forEach(key => {
        wikis[key] = innerData[key];
      });
      wikis.wiki = wikis.wiki.replace(mdYAMlRegExp, '');
    }

    return _data;
  })();

  const id = (() => {
    if (data.id) return data.id;

    if (lib) {
      const _id = lib.data.filter(([name, value]) => name === 'id')[0];
      if (_id) return _id[1];
    }

    return wikis.path;
  })();

  const title = (() => {
    if (data.title) return data.title;
    if (wikis.title) return wikis.title;

    if (lib) {
      const _title = lib.data.filter(([name]) => name === 'title')[0];
      if (_title) return _title[1];
    }

    return wikis.path;
  })();

  paths = [...paths, wikis.path];
  ids = [...ids, id];
  const permalink = wikis.permalink || ids.filter(e => e).join('/'); // TODO : 計算量破滅してないかここ

  if (wikis.wiki) {
    Object.entries(libs).forEach(([key, value]) => {
      wikis.wiki = wikis.wiki.replace(libRegExp(key), () => `\n${'```cpp'}\n${(0, _escape.mdEscape)(value.code)}\n${'```'}\n`);
    });
  } // データは後入れ（順序関係がバグる）


  data.title = wikis.title = title;
  data.permalink = wikis.permalink = permalink;
  if (wikis.wiki) wikis.wiki = `---\n${_jsYaml.default.safeDump(data)}\n---\n\n${wikis.wiki}`;

  if (wikis.child) {
    wikis.child.forEach(child => {
      transformWiki(wikiYAML, child, libs, paths, ids);
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90cmFuc2Zvcm1lcnMvdHJhbnNmb3JtV2lraS5qcyJdLCJuYW1lcyI6WyJsaWJSZWdFeHAiLCJuYW1lIiwiUmVnRXhwIiwiU3RyaW5nIiwicmF3IiwibWRZQU1sUmVnRXhwIiwidHJhbnNmb3JtV2lraSIsIndpa2lZQU1MIiwid2lraXMiLCJsaWJzIiwicGF0aHMiLCJpZHMiLCJuYW1lc3BhY2UiLCJmaWx0ZXIiLCJlIiwiam9pbiIsImxpYiIsInRtcCIsIk9iamVjdCIsInZhbHVlcyIsImVsIiwiZmlsZW5hbWUiLCJwYXRoIiwibGVuZ3RoIiwiZGF0YSIsIl9kYXRhIiwid2lraSIsIm1hdGNoIiwiaW5uZXJEYXRhIiwieWFtbCIsInNhZmVMb2FkIiwia2V5cyIsImZvckVhY2giLCJrZXkiLCJyZXBsYWNlIiwiaWQiLCJfaWQiLCJ2YWx1ZSIsInRpdGxlIiwiX3RpdGxlIiwicGVybWFsaW5rIiwiZW50cmllcyIsImNvZGUiLCJzYWZlRHVtcCIsImNoaWxkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUVBLE1BQU1BLFNBQVMsR0FBR0MsSUFBSSxJQUFJLElBQUlDLE1BQUosQ0FDeEJDLE1BQU0sQ0FBQ0MsR0FBSSxpQkFBZ0JILElBQUssVUFEUixFQUNtQixHQURuQixDQUExQjs7QUFHQSxNQUFNSSxZQUFZLEdBQUcsMkJBQXJCLEMsQ0FFQTs7QUFDQTs7OztBQUdlLFNBQVNDLGFBQVQsQ0FBd0JDLFFBQXhCLEVBQWtDQyxLQUFsQyxFQUF5Q0MsSUFBekMsRUFBK0NDLEtBQUssR0FBRyxFQUF2RCxFQUEyREMsR0FBRyxHQUFHLEVBQWpFLEVBQXFFO0FBQ2xGLFFBQU1DLFNBQVMsR0FBR0YsS0FBSyxDQUFDRyxNQUFOLENBQWFDLENBQUMsSUFBSUEsQ0FBbEIsRUFBcUJDLElBQXJCLENBQTBCLEdBQTFCLENBQWxCOztBQUNBLFFBQU1DLEdBQUcsR0FBRyxDQUFDLE1BQU07QUFDakIsVUFBTUMsR0FBRyxHQUFHQyxN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b3J0IHsgbWRFc2NhcGUgfSBmcm9tICcuLi9oZWxwZXJzL2VzY2FwZSdcblxuY29uc3QgbGliUmVnRXhwID0gbmFtZSA9PiBuZXcgUmVnRXhwKFxuICBTdHJpbmcucmF3YCg/PD1efFxcbikvLyBAICR7bmFtZX0oPz1cXG58JClgLCAnZycpXG5cbmNvbnN0IG1kWUFNbFJlZ0V4cCA9IC9eLS0tXFxuKC4qPylcXG4tLS0oPzpcXG58JCkvc1xuXG4vLyBkZnNcbi8qKlxuICog56C05aOK44GZ44KLXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYW5zZm9ybVdpa2kgKHdpa2lZQU1MLCB3aWtpcywgbGlicywgcGF0aHMgPSBbXSwgaWRzID0gW10pIHtcbiAgY29uc3QgbmFtZXNwYWNlID0gcGF0aHMuZmlsdGVyKGUgPT4gZSkuam9pbignLycpXG4gIGNvbnN0IGxpYiA9ICgoKSA9PiB7XG4gICAgY29uc3QgdG1wID0gT2JqZWN0LnZhbHVlcyhsaWJzKVxuICAgICAgLmZpbHRlcihlbCA9PiBlbC5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSAmJiBlbC5maWxlbmFtZSA9PT0gYCR7d2lraXMucGF0aH0uY3BwYClcbiAgICBpZiAodG1wICYmIHRtcC5sZW5ndGggPT09IDEpIHJldHVybiB0bXBbMF1cbiAgICBlbHNlIHJldHVybiBudWxsXG4gIH0pKClcbiAgY29uc3QgZGF0YSA9ICgoKSA9PiB7XG4gICAgbGV0IF9kYXRhID0ge1xuICAgICAgLi4ud2lraVlBTUwsXG4gICAgfVxuICAgIGlmICh3aWtpcy53aWtpICYmIHdpa2lzLndpa2kubWF0Y2gobWRZQU1sUmVnRXhwKSkge1xuICAgICAgY29uc3QgaW5uZXJEYXRhID0geWFtbC5zYWZlTG9hZCh3aWtpcy53aWtpLm1hdGNoKG1kWUFNbFJlZ0V4cClbMV0pXG4gICAgICBfZGF0YSA9IHtcbiAgICAgICAgLi4uX2RhdGEsXG4gICAgICAgIC4uLmlubmVyRGF0YSxcbiAgICAgIH1cbiAgICAgIE9iamVjdC5rZXlzKGlubmVyRGF0YSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICB3aWtpc1trZXldID0gaW5uZXJEYXRhW2tleV1cbiAgICAgIH0pXG4gICAgICB3aWtpcy53aWtpID0gd2lraXMud2lraS5yZXBsYWNlKG1kWUFNbFJlZ0V4cCwgJycpXG4gICAgfVxuICAgIHJldHVybiBfZGF0YVxuICB9KSgpXG4gIGNvbnN0IGlkID0gKCgpID0+IHtcbiAgICBpZiAoZGF0YS5pZCkgcmV0dXJuIGRhdGEuaWRcbiAgICBpZiAobGliKSB7XG4gICAgICBjb25zdCBfaWQgPSBsaWIuZGF0YS5maWx0ZXIoKFtuYW1lLCB2YWx1ZV0pID0+IG5hbWUgPT09ICdpZCcpWzBdXG4gICAgICBpZiAoX2lkKSByZXR1cm4gX2lkWzFdXG4gICAgfVxuICAgIHJldHVybiB3aWtpcy5wYXRoXG4gIH0pKClcbiAgY29uc3QgdGl0bGUgPSAoKCkgPT4ge1xuICAgIGlmIChkYXRhLnRpdGxlKSByZXR1cm4gZGF0YS50aXRsZVxuICAgIGlmICh3aWtpcy50aXRsZSkgcmV0dXJuIHdpa2lzLnRpdGxlXG4gICAgaWYgKGxpYikge1xuICAgICAgY29uc3QgX3RpdGxlID0gbGliLmRhdGEuZmlsdGVyKChbbmFtZV0pID0+IG5hbWUgPT09ICd0aXRsZScpWzBdXG4gICAgICBpZiAoX3RpdGxlKSByZXR1cm4gX3RpdGxlWzFdXG4gICAgfVxuICAgIHJldHVybiB3aWtpcy5wYXRoXG4gIH0pKClcblxuICBwYXRocyA9IFsuLi5wYXRocywgd2lraXMucGF0aF1cbiAgaWRzID0gWy4uLmlkcywgaWRdXG4gIGNvbnN0IHBlcm1hbGluayA9IHdpa2lzLnBlcm1hbGluayB8fCBpZHMuZmlsdGVyKGUgPT4gZSkuam9pbignLycpXG5cbiAgLy8gVE9ETyA6IOioiOeul+mHj+egtOa7heOBl+OBpuOBquOBhOOBi+OBk+OBk1xuICBpZiAod2lraXMud2lraSkge1xuICAgIE9iamVjdC5lbnRyaWVzKGxpYnMpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgd2lraXMud2lraSA9IHdpa2lzLndpa2lcbiAgICAgICAgLnJlcGxhY2UobGliUmVnRXhwKGtleSksXG4gICAgICAgICAgKCkgPT4gYFxcbiR7J2BgYGNwcCd9XFxuJHttZEVzY2FwZSh2YWx1ZS5jb2RlKX1cXG4keydgYGAnfVxcbmApXG4gICAgfSlcbiAgfVxuXG4gIC8vIOODh+ODvOOCv+OBr+W+jOWFpeOCjO+8iOmghuW6j+mWouS/guOBjOODkOOCsOOCi++8iVxuXG4gIGRhdGEudGl0bGUgPSB3aWtpcy50aXRsZSA9IHRpdGxlXG4gIGRhdGEucGVybWFsaW5rID0gd2lraXMucGVybWFsaW5rID0gcGVybWFsaW5rXG4gIGlmICh3aWtpcy53aWtpKSB3aWtpcy53aWtpID0gYC0tLVxcbiR7eWFtbC5zYWZlRHVtcChkYXRhKX1cXG4tLS1cXG5cXG4ke3dpa2lzLndpa2l9YFxuXG4gIGlmICh3aWtpcy5jaGlsZCkge1xuICAgIHdpa2lzLmNoaWxkLmZvckVhY2goY2hpbGQgPT4ge1xuICAgICAgdHJhbnNmb3JtV2lraSh3aWtpWUFNTCwgY2hpbGQsIGxpYnMsIHBhdGhzLCBpZHMpXG4gICAgfSlcbiAgfVxufVxuIl19