"use strict";

require("source-map-support/register");

var _commander = _interopRequireDefault(require("commander"));

var _fsExtra = require("fs-extra");

var _jsYaml = _interopRequireDefault(require("js-yaml"));

var _path = _interopRequireDefault(require("path"));

var _shelljs = _interopRequireDefault(require("shelljs"));

var _buidInit = _interopRequireDefault(require("./commands/buidInit"));

var _build = _interopRequireDefault(require("./commands/build"));

var _check = require("./commands/check");

var _fix = require("./commands/fix");

var _defaultConfig = _interopRequireDefault(require("./constants/defaultConfig"));

var _makeConfig = _interopRequireDefault(require("./makeConfig"));

var _makeProject = _interopRequireDefault(require("./makers/makeProject"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  resolve
} = _path.default;
const {
  exit
} = _shelljs.default;
const version = "0.3.0";
const defaultSettingFile = 'libman.yml';

_commander.default.version(version, '-v, --version').option('-s, --setting', 'YAML setting file path');

_commander.default.command('check').description('check only').usage('[options]').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const project = await (0, _makeProject.default)(config);
    const changes = (0, _check.check)(config, project);

    if (changes.length === 0) {
      console.log('no file needs fixing');
    } else {
      console.log('these files will be replaced when fixing');
      changes.forEach(change => {
        console.log(change);
      });
    }
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('fix').description('check and fix it').usage('[options]').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const project = await (0, _makeProject.default)(config);
    const changes = (0, _check.check)(config, project);
    console.log(`${changes.length} files will be fixed`);
    (0, _fix.fix)(config, project);
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('build').usage('[options]').option('-i, --init', 'put printlist.json').option('-f, --fix', 'when check is failed, fix and build').option('-o, --one', 'output one-printable-page').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const project = await (0, _makeProject.default)(config);

    if (cmd.init) {
      (0, _buidInit.default)(config, project);
      return;
    }

    const changes = (0, _check.check)(config, project);

    if (changes.length !== 0) {
      if (cmd.fix) {
        console.console(`fixing...`);
        (0, _fix.fix)(config, project);
      } else {
        console.error(`you need to fix`);
        exit(1);
      }
    } else {
      console.log(`passed checking`);
    }

    console.log('building...');
    (0, _build.default)(config, project, cmd.one);
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('init').description('make config file').usage('[options]').option('-d, --default', 'use default setting').option('-f, --force', "when there's already a setting, replace").action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;

    if ((0, _fsExtra.existsSync)(setting) && !cmd.force) {
      throw `${setting} already exists`;
    }

    const cfgObj = cmd.default ? (0, _defaultConfig.default)() : {};
    (0, _fsExtra.writeFileSync)(resolve(process.cwd(), setting), _jsYaml.default.safeDump(cfgObj));
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('clean').description('delete tmp, dist dir').usage('[options]').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const work = resolve(process.cwd(), config.WorkingDir);
    const tmp = resolve(work, config.TempDir);
    const dist = resolve(work, config.DistDir);
    if ((0, _fsExtra.existsSync)(tmp)) (0, _fsExtra.removeSync)(tmp);
    if ((0, _fsExtra.existsSync)(dist)) (0, _fsExtra.removeSync)(dist);
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
}); // error on unknown commands


_commander.default.on('command:*', function () {
  console.error('Invalid command: %s\nSee --help for a list of available commands.', _commander.default.args.join(' '));
});

_commander.default.parse(process.argv);

if (!process.argv.slice(2).length) {
  _commander.default.help();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGkuanMiXSwibmFtZXMiOlsicmVzb2x2ZSIsInBhdGgiLCJleGl0Iiwic2hlbGxqcyIsInZlcnNpb24iLCJkZWZhdWx0U2V0dGluZ0ZpbGUiLCJwcm9ncmFtIiwib3B0aW9uIiwiY29tbWFuZCIsImRlc2NyaXB0aW9uIiwidXNhZ2UiLCJhY3Rpb24iLCJjbWQiLCJzZXR0aW5nIiwiY29uZmlnIiwicHJvamVjdCIsImNoYW5nZXMiLCJsZW5ndGgiLCJjb25zb2xlIiwibG9nIiwiZm9yRWFjaCIsImNoYW5nZSIsImUiLCJlcnJvciIsImluaXQiLCJmaXgiLCJvbmUiLCJmb3JjZSIsImNmZ09iaiIsImRlZmF1bHQiLCJwcm9jZXNzIiwiY3dkIiwieWFtbCIsInNhZmVEdW1wIiwid29yayIsIldvcmtpbmdEaXIiLCJ0bXAiLCJUZW1wRGlyIiwiZGlzdCIsIkRpc3REaXIiLCJvbiIsImFyZ3MiLCJqb2luIiwicGFyc2UiLCJhcmd2Iiwic2xpY2UiLCJoZWxwIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBY0MsYUFBcEI7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBV0MsZ0JBQWpCO0FBRUEsTUFBTUMsT0FBTyxVQUFiO0FBRUEsTUFBTUMsa0JBQWtCLEdBQUcsWUFBM0I7O0FBRUFDLG1CQUNHRixPQURILENBQ1dBLE9BRFgsRUFDb0IsZUFEcEIsRUFFR0csTUFGSCxDQUVVLGVBRlYsRUFFMkIsd0JBRjNCOztBQUlBRCxtQkFDR0UsT0FESCxDQUNXLE9BRFgsRUFFR0MsV0FGSCxDQUVlLFlBRmYsRUFHR0MsS0FISCxDQUdTLFdBSFQsRUFJR0MsTUFKSCxDQUlVLE1BQU9DLEdBQVAsSUFBZTtBQUNyQixNQUFJO0FBQ0YsVUFBTUMsT0FBTyxHQUFHRCxHQUFHLENBQUND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Q2pDWCxxQkFBUXdDLElBQVI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwcm9ncmFtIGZyb20gJ2NvbW1hbmRlcidcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlbW92ZVN5bmMsIHdyaXRlRmlsZVN5bmMgfSBmcm9tICdmcy1leHRyYSdcbmltcG9ydCB5YW1sIGZyb20gJ2pzLXlhbWwnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHNoZWxsanMgZnJvbSAnc2hlbGxqcydcbmltcG9ydCBidWlsZEluaXQgZnJvbSAnLi9jb21tYW5kcy9idWlkSW5pdCdcbmltcG9ydCBidWlsZCBmcm9tICcuL2NvbW1hbmRzL2J1aWxkJ1xuaW1wb3J0IHsgY2hlY2sgfSBmcm9tICcuL2NvbW1hbmRzL2NoZWNrJ1xuaW1wb3J0IHsgZml4IH0gZnJvbSAnLi9jb21tYW5kcy9maXgnXG5pbXBvcnQgZGVmYXVsdENvbmZpZyBmcm9tICcuL2NvbnN0YW50cy9kZWZhdWx0Q29uZmlnJ1xuaW1wb3J0IG1ha2VDb25maWcgZnJvbSAnLi9tYWtlQ29uZmlnJ1xuaW1wb3J0IG1ha2VQcm9qZWN0IGZyb20gJy4vbWFrZXJzL21ha2VQcm9qZWN0J1xuY29uc3QgeyByZXNvbHZlIH0gPSBwYXRoXG5jb25zdCB7IGV4aXQgfSA9IHNoZWxsanNcblxuY29uc3QgdmVyc2lvbiA9IHJlcXVpcmUoJy4uL3BhY2thZ2UuanNvbicpLnZlcnNpb25cblxuY29uc3QgZGVmYXVsdFNldHRpbmdGaWxlID0gJ2xpYm1hbi55bWwnXG5cbnByb2dyYW1cbiAgLnZlcnNpb24odmVyc2lvbiwgJy12LCAtLXZlcnNpb24nKVxuICAub3B0aW9uKCctcywgLS1zZXR0aW5nJywgJ1lBTUwgc2V0dGluZyBmaWxlIHBhdGgnKVxuXG5wcm9ncmFtXG4gIC5jb21tYW5kKCdjaGVjaycpXG4gIC5kZXNjcmlwdGlvbignY2hlY2sgb25seScpXG4gIC51c2FnZSgnW29wdGlvbnNdJylcbiAgLmFjdGlvbihhc3luYyAoY21kKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNldHRpbmcgPSBjbWQuc2V0dGluZyB8fCBkZWZhdWx0U2V0dGluZ0ZpbGVcbiAgICAgIGNvbnN0IGNvbmZpZyA9IG1ha2VDb25maWcoc2V0dGluZylcbiAgICAgIGNvbnN0IHByb2plY3QgPSBhd2FpdCBtYWtlUHJvamVjdChjb25maWcpXG4gICAgICBjb25zdCBjaGFuZ2VzID0gY2hlY2soY29uZmlnLCBwcm9qZWN0KVxuICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdubyBmaWxlIG5lZWRzIGZpeGluZycpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZygndGhlc2UgZmlsZXMgd2lsbCBiZSByZXBsYWNlZCB3aGVuIGZpeGluZycpXG4gICAgICAgIGNoYW5nZXMuZm9yRWFjaChjaGFuZ2UgPT4geyBjb25zb2xlLmxvZyhjaGFuZ2UpIH0pXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG5wcm9ncmFtXG4gIC5jb21tYW5kKCdmaXgnKVxuICAuZGVzY3JpcHRpb24oJ2NoZWNrIGFuZCBmaXggaXQnKVxuICAudXNhZ2UoJ1tvcHRpb25zXScpXG4gIC5hY3Rpb24oYXN5bmMgKGNtZCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXR0aW5nID0gY21kLnNldHRpbmcgfHwgZGVmYXVsdFNldHRpbmdGaWxlXG4gICAgICBjb25zdCBjb25maWcgPSBtYWtlQ29uZmlnKHNldHRpbmcpXG4gICAgICBjb25zdCBwcm9qZWN0ID0gYXdhaXQgbWFrZVByb2plY3QoY29uZmlnKVxuICAgICAgY29uc3QgY2hhbmdlcyA9IGNoZWNrKGNvbmZpZywgcHJvamVjdClcbiAgICAgIGNvbnNvbGUubG9nKGAke2NoYW5nZXMubGVuZ3RofSBmaWxlcyB3aWxsIGJlIGZpeGVkYClcbiAgICAgIGZpeChjb25maWcsIHByb2plY3QpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG5wcm9ncmFtXG4gIC5jb21tYW5kKCdidWlsZCcpXG4gIC51c2FnZSgnW29wdGlvbnNdJylcbiAgLm9wdGlvbignLWksIC0taW5pdCcsICdwdXQgcHJpbnRsaXN0Lmpzb24nKVxuICAub3B0aW9uKCctZiwgLS1maXgnLCAnd2hlbiBjaGVjayBpcyBmYWlsZWQsIGZpeCBhbmQgYnVpbGQnKVxuICAub3B0aW9uKCctbywgLS1vbmUnLCAnb3V0cHV0IG9uZS1wcmludGFibGUtcGFnZScpXG4gIC5hY3Rpb24oYXN5bmMgKGNtZCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXR0aW5nID0gY21kLnNldHRpbmcgfHwgZGVmYXVsdFNldHRpbmdGaWxlXG4gICAgICBjb25zdCBjb25maWcgPSBtYWtlQ29uZmlnKHNldHRpbmcpXG4gICAgICBjb25zdCBwcm9qZWN0ID0gYXdhaXQgbWFrZVByb2plY3QoY29uZmlnKVxuICAgICAgaWYgKGNtZC5pbml0KSB7XG4gICAgICAgIGJ1aWxkSW5pdChjb25maWcsIHByb2plY3QpXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgY29uc3QgY2hhbmdlcyA9IGNoZWNrKGNvbmZpZywgcHJvamVjdClcbiAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICBpZiAoY21kLmZpeCkge1xuICAgICAgICAgIGNvbnNvbGUuY29uc29sZShgZml4aW5nLi4uYClcbiAgICAgICAgICBmaXgoY29uZmlnLCBwcm9qZWN0KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYHlvdSBuZWVkIHRvIGZpeGApXG4gICAgICAgICAgZXhpdCgxKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhgcGFzc2VkIGNoZWNraW5nYClcbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKCdidWlsZGluZy4uLicpXG4gICAgICBidWlsZChjb25maWcsIHByb2plY3QsIGNtZC5vbmUpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG5wcm9ncmFtXG4gIC5jb21tYW5kKCdpbml0JylcbiAgLmRlc2NyaXB0aW9uKCdtYWtlIGNvbmZpZyBmaWxlJylcbiAgLnVzYWdlKCdbb3B0aW9uc10nKVxuICAub3B0aW9uKCctZCwgLS1kZWZhdWx0JywgJ3VzZSBkZWZhdWx0IHNldHRpbmcnKVxuICAub3B0aW9uKCctZiwgLS1mb3JjZScsIFwid2hlbiB0aGVyZSdzIGFscmVhZHkgYSBzZXR0aW5nLCByZXBsYWNlXCIpXG4gIC5hY3Rpb24oYXN5bmMgKGNtZCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXR0aW5nID0gY21kLnNldHRpbmcgfHwgZGVmYXVsdFNldHRpbmdGaWxlXG4gICAgICBpZiAoZXhpc3RzU3luYyhzZXR0aW5nKSAmJiAhY21kLmZvcmNlKSB7XG4gICAgICAgIHRocm93IGAke3NldHRpbmd9IGFscmVhZHkgZXhpc3RzYFxuICAgICAgfVxuICAgICAgY29uc3QgY2ZnT2JqID0gY21kLmRlZmF1bHQgPyBkZWZhdWx0Q29uZmlnKCkgOiB7fVxuICAgICAgd3JpdGVGaWxlU3luYyhyZXNvbHZlKHByb2Nlc3MuY3dkKCksIHNldHRpbmcpLCB5YW1sLnNhZmVEdW1wKGNmZ09iaikpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG5wcm9ncmFtXG4gIC5jb21tYW5kKCdjbGVhbicpXG4gIC5kZXNjcmlwdGlvbignZGVsZXRlIHRtcCwgZGlzdCBkaXInKVxuICAudXNhZ2UoJ1tvcHRpb25zXScpXG4gIC5hY3Rpb24oYXN5bmMgKGNtZCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXR0aW5nID0gY21kLnNldHRpbmcgfHwgZGVmYXVsdFNldHRpbmdGaWxlXG4gICAgICBjb25zdCBjb25maWcgPSBtYWtlQ29uZmlnKHNldHRpbmcpXG4gICAgICBjb25zdCB3b3JrID0gcmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBjb25maWcuV29ya2luZ0RpcilcbiAgICAgIGNvbnN0IHRtcCA9IHJlc29sdmUod29yaywgY29uZmlnLlRlbXBEaXIpXG4gICAgICBjb25zdCBkaXN0ID0gcmVzb2x2ZSh3b3JrLCBjb25maWcuRGlzdERpcilcbiAgICAgIGlmIChleGlzdHNTeW5jKHRtcCkpcmVtb3ZlU3luYyh0bXApXG4gICAgICBpZiAoZXhpc3RzU3luYyhkaXN0KSlyZW1vdmVTeW5jKGRpc3QpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG4vLyBlcnJvciBvbiB1bmtub3duIGNvbW1hbmRzXG5wcm9ncmFtLm9uKCdjb21tYW5kOionLCBmdW5jdGlvbiAoKSB7XG4gIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgY29tbWFuZDogJXNcXG5TZWUgLS1oZWxwIGZvciBhIGxpc3Qgb2YgYXZhaWxhYmxlIGNvbW1hbmRzLicsIHByb2dyYW0uYXJncy5qb2luKCcgJykpXG59KVxuXG5wcm9ncmFtLnBhcnNlKHByb2Nlc3MuYXJndilcblxuaWYgKCFwcm9jZXNzLmFyZ3Yuc2xpY2UoMikubGVuZ3RoKSB7XG4gIHByb2dyYW0uaGVscCgpXG59XG4iXX0=