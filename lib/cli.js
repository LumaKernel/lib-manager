"use strict";

require("source-map-support/register");

var _commander = _interopRequireDefault(require("commander"));

var _fsExtra = require("fs-extra");

var _jsYaml = _interopRequireDefault(require("js-yaml"));

var _path = _interopRequireDefault(require("path"));

var _shelljs = _interopRequireDefault(require("shelljs"));

var _buidInit = _interopRequireDefault(require("./commands/buidInit"));

var _build = _interopRequireDefault(require("./commands/build"));

var _check = require("./commands/check");

var _fix = require("./commands/fix");

var _defaultConfig = _interopRequireDefault(require("./constants/defaultConfig"));

var _makeConfig = _interopRequireDefault(require("./makeConfig"));

var _makeProject = _interopRequireDefault(require("./makers/makeProject"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const {
  resolve
} = _path.default;
const {
  exit
} = _shelljs.default;
const version = "0.4.1";
const defaultSettingFile = 'libman.yml';

_commander.default.version(version, '-v, --version').option('-s, --setting', 'YAML setting file path');

_commander.default.command('check').description('check only').usage('[options]').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const project = await (0, _makeProject.default)(config);
    const changes = (0, _check.check)(config, project);

    if (changes.length === 0) {
      console.log('no file needs fixing');
    } else {
      console.log('these files will be replaced when fixing');
      changes.forEach(change => {
        console.log(change);
      });
    }
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('fix').description('check and fix it').usage('[options]').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const project = await (0, _makeProject.default)(config);
    const changes = (0, _check.check)(config, project);
    console.log(`${changes.length} files will be fixed`);
    (0, _fix.fix)(config, project);
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('build').usage('[options]').option('-i, --init', 'put printlist.json').option('-f, --fix', 'when check is failed, fix and build').option('-o, --one', 'output one-printable-page').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const project = await (0, _makeProject.default)(config);

    if (cmd.init) {
      (0, _buidInit.default)(config, project);
      return;
    }

    const changes = (0, _check.check)(config, project);

    if (changes.length !== 0) {
      if (cmd.fix) {
        console.log(`fixing...`);
        (0, _fix.fix)(config, project);
      } else {
        console.error(`you need to fix`);
        exit(1);
      }
    } else {
      console.log(`passed checking`);
    }

    console.log('building...');
    (0, _build.default)(config, project, cmd.one);
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('init').description('make config file').usage('[options]').option('-d, --default', 'use default setting').option('-f, --force', "when there's already a setting, replace").action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;

    if ((0, _fsExtra.existsSync)(setting) && !cmd.force) {
      throw `${setting} already exists`;
    }

    const cfgObj = cmd.default ? (0, _defaultConfig.default)() : {};
    (0, _fsExtra.writeFileSync)(resolve(process.cwd(), setting), _jsYaml.default.safeDump(cfgObj));
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
});

_commander.default.command('clean').description('delete tmp, dist dir').usage('[options]').action(async cmd => {
  try {
    const setting = cmd.setting || defaultSettingFile;
    const config = (0, _makeConfig.default)(setting);
    const work = resolve(process.cwd(), config.WorkingDir);
    const tmp = resolve(work, config.TempDir);
    const dist = resolve(work, config.DistDir);
    if ((0, _fsExtra.existsSync)(tmp)) (0, _fsExtra.removeSync)(tmp);
    if ((0, _fsExtra.existsSync)(dist)) (0, _fsExtra.removeSync)(dist);
  } catch (e) {
    if (typeof e === 'string') console.error(e);else throw e;
  }
}); // error on unknown commands


_commander.default.on('command:*', function () {
  console.error('Invalid command: %s\nSee --help for a list of available commands.', _commander.default.args.join(' '));
});

_commander.default.parse(process.argv);

if (!process.argv.slice(2).length) {
  _commander.default.help();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jbGkuanMiXSwibmFtZXMiOlsicmVzb2x2ZSIsInBhdGgiLCJleGl0Iiwic2hlbGxqcyIsInZlcnNpb24iLCJkZWZhdWx0U2V0dGluZ0ZpbGUiLCJwcm9ncmFtIiwib3B0aW9uIiwiY29tbWFuZCIsImRlc2NyaXB0aW9uIiwidXNhZ2UiLCJhY3Rpb24iLCJjbWQiLCJzZXR0aW5nIiwiY29uZmlnIiwicHJvamVjdCIsImNoYW5nZXMiLCJsZW5ndGgiLCJjb25zb2xlIiwibG9nIiwiZm9yRWFjaCIsImNoYW5nZSIsImUiLCJlcnJvciIsImluaXQiLCJmaXgiLCJvbmUiLCJmb3JjZSIsImNmZ09iaiIsImRlZmF1bHQiLCJwcm9jZXNzIiwiY3dkIiwieWFtbCIsInNhZmVEdW1wIiwid29yayIsIldvcmtpbmdEaXIiLCJ0bXAiLCJUZW1wRGlyIiwiZGlzdCIsIkRpc3REaXIiLCJvbiIsImFyZ3MiLCJqb2luIiwicGFyc2UiLCJhcmd2Iiwic2xpY2UiLCJoZWxwIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBY0MsYUFBcEI7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBV0MsZ0JBQWpCO0FBRUEsTUFBTUMsT0FBTyxVQUFiO0FBRUEsTUFBTUMsa0JBQWtCLEdBQUcsWUFBM0I7O0FBRUFDLG1CQUNHRixPQURILENBQ1dBLE9BRFgsRUFDb0IsZUFEcEIsRUFFR0csTUFGSCxDQUVVLGVBRlYsRUFFMkIsd0JBRjNCOztBQUlBRCxtQkFDR0UsT0FESCxDQUNXLE9BRFgsRUFFR0MsV0FGSCxDQUVlLFlBRmYsRUFHR0MsS0FISCxDQUdTLFdBSFQsRUFJR0MsTUFKSCxDQUlVLE1BQU9DLEdBQVAsSUFBZTtBQUNyQixNQUFJO0FBQ0YsVUFBTUMsT0FBTyxHQUFHRCxHQUFHLENBQUND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Q1gscUJBQVF3QyxJQUFSO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcHJvZ3JhbSBmcm9tICdjb21tYW5kZXInXG5pbXBvcnQgeyBleGlzdHNTeW5jLCByZW1vdmVTeW5jLCB3cml0ZUZpbGVTeW5jIH0gZnJvbSAnZnMtZXh0cmEnXG5pbXBvcnQgeWFtbCBmcm9tICdqcy15YW1sJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBzaGVsbGpzIGZyb20gJ3NoZWxsanMnXG5pbXBvcnQgYnVpbGRJbml0IGZyb20gJy4vY29tbWFuZHMvYnVpZEluaXQnXG5pbXBvcnQgYnVpbGQgZnJvbSAnLi9jb21tYW5kcy9idWlsZCdcbmltcG9ydCB7IGNoZWNrIH0gZnJvbSAnLi9jb21tYW5kcy9jaGVjaydcbmltcG9ydCB7IGZpeCB9IGZyb20gJy4vY29tbWFuZHMvZml4J1xuaW1wb3J0IGRlZmF1bHRDb25maWcgZnJvbSAnLi9jb25zdGFudHMvZGVmYXVsdENvbmZpZydcbmltcG9ydCBtYWtlQ29uZmlnIGZyb20gJy4vbWFrZUNvbmZpZydcbmltcG9ydCBtYWtlUHJvamVjdCBmcm9tICcuL21ha2Vycy9tYWtlUHJvamVjdCdcbmNvbnN0IHsgcmVzb2x2ZSB9ID0gcGF0aFxuY29uc3QgeyBleGl0IH0gPSBzaGVsbGpzXG5cbmNvbnN0IHZlcnNpb24gPSByZXF1aXJlKCcuLi9wYWNrYWdlLmpzb24nKS52ZXJzaW9uXG5cbmNvbnN0IGRlZmF1bHRTZXR0aW5nRmlsZSA9ICdsaWJtYW4ueW1sJ1xuXG5wcm9ncmFtXG4gIC52ZXJzaW9uKHZlcnNpb24sICctdiwgLS12ZXJzaW9uJylcbiAgLm9wdGlvbignLXMsIC0tc2V0dGluZycsICdZQU1MIHNldHRpbmcgZmlsZSBwYXRoJylcblxucHJvZ3JhbVxuICAuY29tbWFuZCgnY2hlY2snKVxuICAuZGVzY3JpcHRpb24oJ2NoZWNrIG9ubHknKVxuICAudXNhZ2UoJ1tvcHRpb25zXScpXG4gIC5hY3Rpb24oYXN5bmMgKGNtZCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXR0aW5nID0gY21kLnNldHRpbmcgfHwgZGVmYXVsdFNldHRpbmdGaWxlXG4gICAgICBjb25zdCBjb25maWcgPSBtYWtlQ29uZmlnKHNldHRpbmcpXG4gICAgICBjb25zdCBwcm9qZWN0ID0gYXdhaXQgbWFrZVByb2plY3QoY29uZmlnKVxuICAgICAgY29uc3QgY2hhbmdlcyA9IGNoZWNrKGNvbmZpZywgcHJvamVjdClcbiAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb25zb2xlLmxvZygnbm8gZmlsZSBuZWVkcyBmaXhpbmcnKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5sb2coJ3RoZXNlIGZpbGVzIHdpbGwgYmUgcmVwbGFjZWQgd2hlbiBmaXhpbmcnKVxuICAgICAgICBjaGFuZ2VzLmZvckVhY2goY2hhbmdlID0+IHsgY29uc29sZS5sb2coY2hhbmdlKSB9KVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICh0eXBlb2YgZSA9PT0gJ3N0cmluZycpIGNvbnNvbGUuZXJyb3IoZSlcbiAgICAgIGVsc2UgdGhyb3cgZVxuICAgIH1cbiAgfSlcblxucHJvZ3JhbVxuICAuY29tbWFuZCgnZml4JylcbiAgLmRlc2NyaXB0aW9uKCdjaGVjayBhbmQgZml4IGl0JylcbiAgLnVzYWdlKCdbb3B0aW9uc10nKVxuICAuYWN0aW9uKGFzeW5jIChjbWQpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2V0dGluZyA9IGNtZC5zZXR0aW5nIHx8IGRlZmF1bHRTZXR0aW5nRmlsZVxuICAgICAgY29uc3QgY29uZmlnID0gbWFrZUNvbmZpZyhzZXR0aW5nKVxuICAgICAgY29uc3QgcHJvamVjdCA9IGF3YWl0IG1ha2VQcm9qZWN0KGNvbmZpZylcbiAgICAgIGNvbnN0IGNoYW5nZXMgPSBjaGVjayhjb25maWcsIHByb2plY3QpXG4gICAgICBjb25zb2xlLmxvZyhgJHtjaGFuZ2VzLmxlbmd0aH0gZmlsZXMgd2lsbCBiZSBmaXhlZGApXG4gICAgICBmaXgoY29uZmlnLCBwcm9qZWN0KVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmICh0eXBlb2YgZSA9PT0gJ3N0cmluZycpIGNvbnNvbGUuZXJyb3IoZSlcbiAgICAgIGVsc2UgdGhyb3cgZVxuICAgIH1cbiAgfSlcblxucHJvZ3JhbVxuICAuY29tbWFuZCgnYnVpbGQnKVxuICAudXNhZ2UoJ1tvcHRpb25zXScpXG4gIC5vcHRpb24oJy1pLCAtLWluaXQnLCAncHV0IHByaW50bGlzdC5qc29uJylcbiAgLm9wdGlvbignLWYsIC0tZml4JywgJ3doZW4gY2hlY2sgaXMgZmFpbGVkLCBmaXggYW5kIGJ1aWxkJylcbiAgLm9wdGlvbignLW8sIC0tb25lJywgJ291dHB1dCBvbmUtcHJpbnRhYmxlLXBhZ2UnKVxuICAuYWN0aW9uKGFzeW5jIChjbWQpID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc2V0dGluZyA9IGNtZC5zZXR0aW5nIHx8IGRlZmF1bHRTZXR0aW5nRmlsZVxuICAgICAgY29uc3QgY29uZmlnID0gbWFrZUNvbmZpZyhzZXR0aW5nKVxuICAgICAgY29uc3QgcHJvamVjdCA9IGF3YWl0IG1ha2VQcm9qZWN0KGNvbmZpZylcbiAgICAgIGlmIChjbWQuaW5pdCkge1xuICAgICAgICBidWlsZEluaXQoY29uZmlnLCBwcm9qZWN0KVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbnN0IGNoYW5nZXMgPSBjaGVjayhjb25maWcsIHByb2plY3QpXG4gICAgICBpZiAoY2hhbmdlcy5sZW5ndGggIT09IDApIHtcbiAgICAgICAgaWYgKGNtZC5maXgpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgZml4aW5nLi4uYClcbiAgICAgICAgICBmaXgoY29uZmlnLCBwcm9qZWN0KVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYHlvdSBuZWVkIHRvIGZpeGApXG4gICAgICAgICAgZXhpdCgxKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhgcGFzc2VkIGNoZWNraW5nYClcbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKCdidWlsZGluZy4uLicpXG4gICAgICBidWlsZChjb25maWcsIHByb2plY3QsIGNtZC5vbmUpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG5wcm9ncmFtXG4gIC5jb21tYW5kKCdpbml0JylcbiAgLmRlc2NyaXB0aW9uKCdtYWtlIGNvbmZpZyBmaWxlJylcbiAgLnVzYWdlKCdbb3B0aW9uc10nKVxuICAub3B0aW9uKCctZCwgLS1kZWZhdWx0JywgJ3VzZSBkZWZhdWx0IHNldHRpbmcnKVxuICAub3B0aW9uKCctZiwgLS1mb3JjZScsIFwid2hlbiB0aGVyZSdzIGFscmVhZHkgYSBzZXR0aW5nLCByZXBsYWNlXCIpXG4gIC5hY3Rpb24oYXN5bmMgKGNtZCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXR0aW5nID0gY21kLnNldHRpbmcgfHwgZGVmYXVsdFNldHRpbmdGaWxlXG4gICAgICBpZiAoZXhpc3RzU3luYyhzZXR0aW5nKSAmJiAhY21kLmZvcmNlKSB7XG4gICAgICAgIHRocm93IGAke3NldHRpbmd9IGFscmVhZHkgZXhpc3RzYFxuICAgICAgfVxuICAgICAgY29uc3QgY2ZnT2JqID0gY21kLmRlZmF1bHQgPyBkZWZhdWx0Q29uZmlnKCkgOiB7fVxuICAgICAgd3JpdGVGaWxlU3luYyhyZXNvbHZlKHByb2Nlc3MuY3dkKCksIHNldHRpbmcpLCB5YW1sLnNhZmVEdW1wKGNmZ09iaikpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG5wcm9ncmFtXG4gIC5jb21tYW5kKCdjbGVhbicpXG4gIC5kZXNjcmlwdGlvbignZGVsZXRlIHRtcCwgZGlzdCBkaXInKVxuICAudXNhZ2UoJ1tvcHRpb25zXScpXG4gIC5hY3Rpb24oYXN5bmMgKGNtZCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXR0aW5nID0gY21kLnNldHRpbmcgfHwgZGVmYXVsdFNldHRpbmdGaWxlXG4gICAgICBjb25zdCBjb25maWcgPSBtYWtlQ29uZmlnKHNldHRpbmcpXG4gICAgICBjb25zdCB3b3JrID0gcmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBjb25maWcuV29ya2luZ0RpcilcbiAgICAgIGNvbnN0IHRtcCA9IHJlc29sdmUod29yaywgY29uZmlnLlRlbXBEaXIpXG4gICAgICBjb25zdCBkaXN0ID0gcmVzb2x2ZSh3b3JrLCBjb25maWcuRGlzdERpcilcbiAgICAgIGlmIChleGlzdHNTeW5jKHRtcCkpcmVtb3ZlU3luYyh0bXApXG4gICAgICBpZiAoZXhpc3RzU3luYyhkaXN0KSlyZW1vdmVTeW5jKGRpc3QpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKHR5cGVvZiBlID09PSAnc3RyaW5nJykgY29uc29sZS5lcnJvcihlKVxuICAgICAgZWxzZSB0aHJvdyBlXG4gICAgfVxuICB9KVxuXG4vLyBlcnJvciBvbiB1bmtub3duIGNvbW1hbmRzXG5wcm9ncmFtLm9uKCdjb21tYW5kOionLCBmdW5jdGlvbiAoKSB7XG4gIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgY29tbWFuZDogJXNcXG5TZWUgLS1oZWxwIGZvciBhIGxpc3Qgb2YgYXZhaWxhYmxlIGNvbW1hbmRzLicsIHByb2dyYW0uYXJncy5qb2luKCcgJykpXG59KVxuXG5wcm9ncmFtLnBhcnNlKHByb2Nlc3MuYXJndilcblxuaWYgKCFwcm9jZXNzLmFyZ3Yuc2xpY2UoMikubGVuZ3RoKSB7XG4gIHByb2dyYW0uaGVscCgpXG59XG4iXX0=